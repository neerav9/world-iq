<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>WORLD IQ ‚Äî Gamified Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Nunito:wght@400;600;700;800;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" href="data:,">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#07090f;--surface:#0c0f1a;--card:#111626;--card2:#161c2e;--border:rgba(255,255,255,0.07);
  --text:#eef0f8;--muted:#3d4a65;--dim:#1a2035;
  --xp:#7c3aed;--xp2:#a855f7;
  --gold:#f5c842;--gold2:#e8a020;--goldfaint:rgba(245,200,66,0.08);
  --silver:#c8d8ee;--silverfaint:rgba(200,216,238,0.07);
  --green:#00e676;--red:#ff4560;--blue:#00bfff;--orange:#ff8c42;
  --ff:'Nunito',sans-serif;--ffm:'JetBrains Mono',monospace;--ffh:'Rajdhani',sans-serif;
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:var(--ff);overflow-x:hidden;-webkit-font-smoothing:antialiased}
::-webkit-scrollbar{width:3px;height:3px}::-webkit-scrollbar-thumb{background:var(--dim);border-radius:2px}

/* ‚îÄ‚îÄ AMBIENT ‚îÄ‚îÄ */
.orb{position:fixed;border-radius:50%;filter:blur(100px);pointer-events:none;z-index:0}
.orb1{width:500px;height:500px;top:-150px;left:-150px;background:rgba(124,58,237,0.06)}
.orb2{width:400px;height:400px;bottom:-100px;right:-100px;background:rgba(245,200,66,0.04)}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
#topbar{
  position:sticky;top:0;z-index:200;
  background:rgba(7,9,15,0.94);backdrop-filter:blur(20px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  padding:0 18px;height:56px;flex-shrink:0;
}
.tb-logo{font-family:var(--ffh);font-size:22px;font-weight:700;letter-spacing:0.06em;
  background:linear-gradient(135deg,#7c3aed,#a855f7,#00bfff);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent}
.tb-mid{display:flex;align-items:center;gap:10px}
.xp-wrap{display:flex;align-items:center;gap:8px}
.xp-label{font-family:var(--ffm);font-size:10px;color:var(--muted);letter-spacing:0.1em}
.xp-bar{width:80px;height:6px;background:var(--dim);border-radius:3px;overflow:hidden}
.xp-fill{height:100%;background:linear-gradient(90deg,var(--xp),var(--xp2));border-radius:3px;transition:width 0.8s ease}
.xp-val{font-family:var(--ffm);font-size:11px;color:var(--xp2);font-weight:700}
.level-badge{display:flex;align-items:center;gap:6px;background:rgba(124,58,237,0.12);border:1px solid rgba(124,58,237,0.25);border-radius:20px;padding:4px 12px;cursor:pointer;transition:all 0.2s}
.level-badge:hover{background:rgba(124,58,237,0.2)}
.lv-icon{font-size:15px}
.lv-num{font-family:var(--ffm);font-size:12px;font-weight:700;color:var(--xp2)}
.lv-label{font-size:10px;color:var(--muted)}
.streak-badge{display:flex;align-items:center;gap:5px;background:rgba(245,200,66,0.08);border:1px solid rgba(245,200,66,0.2);border-radius:20px;padding:4px 10px;cursor:pointer}
.str-fire{font-size:14px}
.str-num{font-family:var(--ffm);font-size:12px;font-weight:700;color:var(--gold)}
#topbar-clock{font-family:var(--ffm);font-size:11px;color:var(--muted)}

/* ‚îÄ‚îÄ HOME SCREEN ‚îÄ‚îÄ */
#homescreen{position:relative;z-index:1;min-height:calc(100vh - 56px);padding:24px 18px 40px}
.home-hero{text-align:center;padding:32px 0 40px}
.home-greeting{font-size:14px;color:var(--muted);letter-spacing:0.1em;text-transform:uppercase;margin-bottom:8px;font-family:var(--ffm)}
.home-title{font-family:var(--ffh);font-size:clamp(32px,8vw,52px);font-weight:700;letter-spacing:0.04em;line-height:1.1;margin-bottom:10px}
.home-title span{background:linear-gradient(135deg,var(--gold),var(--xp2),var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.home-sub{font-size:14px;color:var(--muted);max-width:400px;margin:0 auto}

/* DAILY QUEST BAR */
.quest-bar{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px 18px;margin-bottom:28px;display:flex;align-items:center;gap:14px}
.quest-icon{font-size:26px;flex-shrink:0}
.quest-content{flex:1}
.quest-title{font-size:13px;font-weight:700;margin-bottom:4px}
.quest-sub{font-size:11px;color:var(--muted)}
.quest-progress-wrap{margin-top:8px;display:flex;align-items:center;gap:8px}
.quest-prog-bar{flex:1;height:4px;background:var(--dim);border-radius:2px;overflow:hidden}
.quest-prog-fill{height:100%;background:linear-gradient(90deg,var(--gold),var(--xp2));border-radius:2px;transition:width 0.8s ease}
.quest-pct{font-family:var(--ffm);font-size:10px;color:var(--gold)}
.quest-reward{font-family:var(--ffm);font-size:11px;color:var(--xp2);background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.2);border-radius:8px;padding:4px 10px;flex-shrink:0}

/* ARENA GRID */
.arenas-label{font-family:var(--ffm);font-size:10px;letter-spacing:0.2em;text-transform:uppercase;color:var(--muted);margin-bottom:14px;display:flex;align-items:center;gap:10px}
.arenas-label::before{content:'';width:20px;height:1px;background:var(--xp2)}
.arenas-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:32px}
@media(min-width:600px){.arenas-grid{grid-template-columns:repeat(3,1fr)}}

.arena-card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:20px 16px;cursor:pointer;transition:all 0.3s;position:relative;overflow:hidden;display:flex;flex-direction:column;gap:8px;animation:cardIn 0.5s ease both}
.arena-card:nth-child(1){animation-delay:0.05s}
.arena-card:nth-child(2){animation-delay:0.1s}
.arena-card:nth-child(3){animation-delay:0.15s}
.arena-card:nth-child(4){animation-delay:0.2s}
.arena-card:nth-child(5){animation-delay:0.25s}
.arena-card:nth-child(6){animation-delay:0.3s}
@keyframes cardIn{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.arena-card::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity 0.3s}
.arena-card:hover{transform:translateY(-3px);box-shadow:0 16px 40px rgba(0,0,0,0.4)}
.arena-card:hover::before{opacity:1}
.arena-card:active{transform:scale(0.97)}
.arena-emoji{font-size:32px;line-height:1;margin-bottom:2px}
.arena-name{font-family:var(--ffh);font-size:17px;font-weight:700;letter-spacing:0.04em}
.arena-sub{font-size:11px;color:var(--muted);line-height:1.4}
.arena-footer{display:flex;align-items:center;justify-content:space-between;margin-top:4px}
.arena-xp-badge{font-family:var(--ffm);font-size:9px;letter-spacing:0.1em;padding:2px 8px;border-radius:4px;border:1px solid}
.arena-streak{font-size:10px;color:var(--muted)}

.arena-gold{border-color:rgba(245,200,66,0.2)}
.arena-gold::before{background:radial-gradient(ellipse at 80% 20%,rgba(245,200,66,0.08),transparent 60%)}
.arena-gold .arena-xp-badge{color:var(--gold);border-color:rgba(245,200,66,0.3);background:rgba(245,200,66,0.05)}
.arena-india{border-color:rgba(255,140,66,0.2)}
.arena-india::before{background:radial-gradient(ellipse at 80% 20%,rgba(255,140,66,0.08),transparent 60%)}
.arena-india .arena-xp-badge{color:var(--orange);border-color:rgba(255,140,66,0.3);background:rgba(255,140,66,0.05)}
.arena-world{border-color:rgba(0,230,118,0.2)}
.arena-world::before{background:radial-gradient(ellipse at 80% 20%,rgba(0,230,118,0.07),transparent 60%)}
.arena-world .arena-xp-badge{color:var(--green);border-color:rgba(0,230,118,0.3);background:rgba(0,230,118,0.05)}
.arena-tech{border-color:rgba(168,85,247,0.2)}
.arena-tech::before{background:radial-gradient(ellipse at 80% 20%,rgba(168,85,247,0.08),transparent 60%)}
.arena-tech .arena-xp-badge{color:var(--xp2);border-color:rgba(168,85,247,0.3);background:rgba(168,85,247,0.05)}
.arena-markets{border-color:rgba(0,191,255,0.2)}
.arena-markets::before{background:radial-gradient(ellipse at 80% 20%,rgba(0,191,255,0.07),transparent 60%)}
.arena-markets .arena-xp-badge{color:var(--blue);border-color:rgba(0,191,255,0.3);background:rgba(0,191,255,0.05)}
.arena-science{border-color:rgba(255,69,96,0.2)}
.arena-science::before{background:radial-gradient(ellipse at 80% 20%,rgba(255,69,96,0.06),transparent 60%)}
.arena-science .arena-xp-badge{color:var(--red);border-color:rgba(255,69,96,0.3);background:rgba(255,69,96,0.05)}

/* ACHIEVEMENTS */
.achieve-row{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px;scrollbar-width:none;margin-bottom:32px}
.achieve-row::-webkit-scrollbar{display:none}
.achieve{flex-shrink:0;width:72px;text-align:center;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px 6px;transition:all 0.2s;cursor:pointer}
.achieve:hover{transform:scale(1.05)}
.achieve.locked{opacity:0.35;filter:grayscale(1)}
.achieve-icon{font-size:26px;margin-bottom:4px}
.achieve-name{font-size:9px;color:var(--muted);line-height:1.3}

/* ‚îÄ‚îÄ ARENA SCREEN ‚îÄ‚îÄ */
#arenascreen{position:relative;z-index:1;display:none;min-height:calc(100vh - 56px)}
.arena-topbar{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid var(--border);background:rgba(7,9,15,0.8);backdrop-filter:blur(12px);position:sticky;top:56px;z-index:100}
.back-btn{width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:none;color:var(--text);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s}
.back-btn:hover{background:var(--dim);border-color:rgba(255,255,255,0.15)}
.arena-top-info{flex:1}
.arena-top-name{font-family:var(--ffh);font-size:20px;font-weight:700;letter-spacing:0.04em}
.arena-top-sub{font-size:11px;color:var(--muted)}
.arena-top-xp{font-family:var(--ffm);font-size:11px;color:var(--xp2)}

/* INNER TABS */
.inner-tabs{display:flex;background:var(--surface);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.inner-tabs::-webkit-scrollbar{display:none}
.itab{flex-shrink:0;padding:11px 18px;border:none;background:none;color:var(--muted);font-family:var(--ff);font-size:12px;font-weight:700;letter-spacing:0.06em;text-transform:uppercase;cursor:pointer;border-bottom:2px solid transparent;transition:all 0.25s;white-space:nowrap}
.itab:hover{color:var(--text)}
.itab.active{color:var(--text);border-bottom-color:var(--xp2)}
.arena-content{padding:20px 18px 60px;max-width:860px;margin:0 auto}
.ipanel{display:none;animation:fadeSlide 0.3s ease}
.ipanel.active{display:block}
@keyframes fadeSlide{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px;position:relative;overflow:hidden}
.card-accent{position:absolute;top:0;left:0;right:0;height:2px}
.card-label{font-family:var(--ffm);font-size:9px;letter-spacing:0.18em;text-transform:uppercase;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.card-label::before{content:'';width:16px;height:1px;background:currentColor}

/* PRICE CARDS */
.price-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px}
.price-card{background:var(--card2);border:1px solid var(--border);border-radius:14px;padding:16px;position:relative;overflow:hidden;cursor:pointer;transition:all 0.25s}
.price-card:hover{transform:translateY(-2px);box-shadow:0 12px 32px rgba(0,0,0,0.3)}
.price-card.gold-c{border-color:rgba(245,200,66,0.2)}
.price-card.gold-c::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:radial-gradient(circle,rgba(245,200,66,0.15),transparent 70%);pointer-events:none}
.price-card.silver-c{border-color:rgba(200,216,238,0.2)}
.price-card.silver-c::before{content:'';position:absolute;top:-30px;right:-30px;width:100px;height:100px;background:radial-gradient(circle,rgba(200,216,238,0.1),transparent 70%);pointer-events:none}
.pc-tag{font-family:var(--ffm);font-size:9px;letter-spacing:0.15em;text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:6px}
.pc-dot{width:7px;height:7px;border-radius:50%;display:inline-block}
.pc-price{font-family:var(--ffm);font-size:clamp(22px,5vw,32px);font-weight:700;color:var(--text);line-height:1;margin-bottom:4px}
.pc-sub{font-size:11px;color:var(--muted)}
.pc-change{font-family:var(--ffm);font-size:12px;margin-top:8px;display:flex;align-items:center;gap:5px}
.up{color:var(--green)}.dn{color:var(--red)}
.pc-intl{font-size:10px;color:var(--muted);margin-top:2px;font-family:var(--ffm)}

/* SKELETON LOADER */
.price-loading{background:linear-gradient(90deg,var(--dim) 25%,rgba(255,255,255,0.04) 50%,var(--dim) 75%);background-size:200% 100%;animation:shimmer 1.4s infinite}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* CHART */
.chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px}
.chart-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px}
.chart-title{font-family:var(--ffh);font-size:16px;font-weight:600;letter-spacing:0.06em}
.range-btns{display:flex;gap:4px}
.rb{font-family:var(--ffm);font-size:10px;letter-spacing:0.08em;padding:4px 10px;border-radius:6px;border:1px solid var(--border);background:none;color:var(--muted);cursor:pointer;transition:all 0.2s}
.rb:hover,.rb.act{background:rgba(124,58,237,0.12);border-color:var(--xp2);color:var(--xp2)}
#priceChart{width:100%;height:180px;display:block}
.chart-legend{display:flex;gap:16px;margin-top:10px;flex-wrap:wrap}
.cl-item{display:flex;align-items:center;gap:6px;font-size:11px;color:var(--muted)}
.cl-dot{width:8px;height:8px;border-radius:50%}

/* WHY CARDS */
.why-card{background:var(--card2);border:1px solid var(--border);border-radius:14px;overflow:hidden;margin-bottom:10px;cursor:pointer;transition:border-color 0.2s}
.why-card:hover{border-color:rgba(255,255,255,0.12)}
.why-front{padding:14px 16px;display:flex;align-items:center;gap:12px}
.why-icon{font-size:26px;width:40px;text-align:center;flex-shrink:0}
.why-mid{flex:1}
.why-title{font-size:13px;font-weight:700;margin-bottom:3px}
.why-sub{font-size:11px;color:var(--muted)}
.why-impact{font-family:var(--ffm);font-size:9px;letter-spacing:0.1em;padding:3px 9px;border-radius:10px;border:1px solid;flex-shrink:0}
.imp-bull{color:var(--green);border-color:rgba(0,230,118,0.3);background:rgba(0,230,118,0.05)}
.imp-bear{color:var(--red);border-color:rgba(255,69,96,0.3);background:rgba(255,69,96,0.05)}
.imp-neut{color:var(--muted);border-color:var(--border)}
.why-chevron{color:var(--muted);font-size:12px;margin-left:8px;transition:transform 0.3s;flex-shrink:0}
.why-card.open .why-chevron{transform:rotate(180deg)}
.why-body{max-height:0;overflow:hidden;transition:max-height 0.4s ease,padding 0.3s;font-size:13px;color:#6a7fa0;line-height:1.75;border-top:0 solid var(--border);padding:0 16px}
.why-card.open .why-body{max-height:400px;padding:14px 16px;border-top-width:1px}
.why-body strong{color:var(--text);font-weight:600}
.why-body .tag{display:inline-block;font-family:var(--ffm);font-size:9px;letter-spacing:0.1em;text-transform:uppercase;padding:1px 7px;border-radius:4px;margin-bottom:6px}

/* FORECAST TIMELINE */
.ft-wrap{position:relative;padding-left:28px}
.ft-line-vert{position:absolute;left:10px;top:6px;bottom:6px;width:2px;background:linear-gradient(to bottom,var(--xp2),rgba(124,58,237,0.1))}
.ft-item{position:relative;margin-bottom:22px}
.ft-item:last-child{margin-bottom:0}
.ft-dot{position:absolute;left:-23px;top:3px;width:14px;height:14px;border-radius:50%;background:var(--bg);border:2px solid var(--xp2)}
.ft-dot.now{background:var(--xp2);box-shadow:0 0 10px rgba(168,85,247,0.6)}
.ft-period{font-family:var(--ffm);font-size:10px;letter-spacing:0.12em;text-transform:uppercase;color:var(--xp2);margin-bottom:4px}
.ft-price-row{display:flex;align-items:baseline;gap:8px;margin-bottom:4px}
.ft-price{font-family:var(--ffm);font-size:20px;font-weight:700;color:var(--text)}
.ft-chg{font-family:var(--ffm);font-size:12px}
.ft-reason{font-size:12px;color:var(--muted);line-height:1.6}
.ft-conf-row{display:flex;align-items:center;gap:8px;margin-top:8px}
.ft-cbar{flex:1;height:3px;background:var(--dim);border-radius:2px;overflow:hidden}
.ft-cfill{height:100%;background:linear-gradient(90deg,var(--xp),var(--xp2));transition:width 1.2s ease 0.5s;border-radius:2px}
.ft-clabel{font-family:var(--ffm);font-size:9px;color:var(--muted);white-space:nowrap}

/* ‚îÄ‚îÄ GAME TAB ‚îÄ‚îÄ */
.game-wrap{background:var(--card);border:1px solid rgba(168,85,247,0.2);border-radius:20px;padding:22px;margin-bottom:20px;text-align:center;position:relative;overflow:hidden}
.game-wrap::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 50% 0%,rgba(124,58,237,0.08),transparent 60%);pointer-events:none}
.game-hud{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:8px}
.hud-item{text-align:center}
.hud-val{font-family:var(--ffm);font-size:18px;font-weight:700;color:var(--xp2)}
.hud-label{font-size:10px;color:var(--muted);font-family:var(--ffm);letter-spacing:0.1em}
.hud-streak .hud-val{color:var(--gold)}
.hud-acc .hud-val{color:var(--green)}
.game-q-num{font-family:var(--ffm);font-size:10px;letter-spacing:0.2em;color:var(--muted);margin-bottom:12px;text-transform:uppercase}
.game-q{background:rgba(255,255,255,0.03);border:1px solid var(--border);border-radius:14px;padding:18px;margin-bottom:16px;font-size:15px;font-weight:700;line-height:1.5;color:var(--text);text-align:left}
.game-context{background:rgba(0,191,255,0.04);border:1px solid rgba(0,191,255,0.1);border-radius:10px;padding:12px;margin-bottom:18px;font-size:12px;color:#5a7a9a;line-height:1.7;text-align:left}
.game-context strong{color:var(--blue)}
.opts-grid{display:flex;flex-direction:column;gap:9px;margin-bottom:16px}
.opt-btn{width:100%;padding:13px 16px;border-radius:12px;border:1.5px solid var(--border);background:var(--card2);color:var(--text);font-family:var(--ff);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:12px;text-align:left}
.opt-btn:hover:not(:disabled){border-color:rgba(168,85,247,0.4);background:rgba(124,58,237,0.08);transform:translateX(4px)}
.opt-btn.correct{border-color:var(--green);background:rgba(0,230,118,0.08);color:var(--green)}
.opt-btn.wrong{border-color:var(--red);background:rgba(255,69,96,0.08);color:var(--red)}
.opt-btn:disabled{cursor:default}
.opt-btn:disabled:not(.correct):not(.wrong){opacity:0.45}
.opt-letter{width:28px;height:28px;border-radius:8px;background:var(--dim);display:flex;align-items:center;justify-content:center;font-family:var(--ffm);font-size:11px;font-weight:700;flex-shrink:0;transition:all 0.2s}
.opt-btn.correct .opt-letter{background:var(--green);color:var(--bg)}
.opt-btn.wrong .opt-letter{background:var(--red);color:white}
.game-result{border-radius:14px;padding:16px;font-size:13px;line-height:1.7;display:none;animation:fadeSlide 0.3s ease;text-align:left;margin-bottom:12px}
.game-result.show{display:block}
.game-result.right{background:rgba(0,230,118,0.07);border:1px solid rgba(0,230,118,0.2);color:#a0e8c0}
.game-result.wrong{background:rgba(255,69,96,0.07);border:1px solid rgba(255,69,96,0.2);color:#ffa0b0}
.game-result strong{color:var(--text)}
.game-correct-answer{font-family:var(--ffm);font-size:11px;letter-spacing:0.08em;margin-bottom:8px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.04)}
.xp-pop{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-family:var(--ffm);font-size:32px;font-weight:700;pointer-events:none;opacity:0;color:var(--gold)}
.xp-pop.fire{animation:xpFly 1s ease forwards}
@keyframes xpFly{0%{opacity:0;transform:translate(-50%,-100%) scale(0.5)}30%{opacity:1;transform:translate(-50%,-120%) scale(1.3)}100%{opacity:0;transform:translate(-50%,-180%) scale(1)}}
.next-q-btn{padding:11px 28px;border-radius:12px;border:1px solid rgba(168,85,247,0.3);background:rgba(124,58,237,0.1);color:var(--xp2);font-family:var(--ffm);font-size:11px;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;display:none}
.next-q-btn:hover{background:rgba(124,58,237,0.2)}
.next-q-btn.show{display:inline-block}

/* SCORE BOARD */
.score-summary{background:var(--card2);border:1px solid rgba(168,85,247,0.15);border-radius:16px;padding:22px;text-align:center;display:none}
.score-summary.show{display:block;animation:fadeSlide 0.4s ease}
.ss-trophy{font-size:56px;animation:bounce 1s ease}
@keyframes bounce{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.ss-title{font-family:var(--ffh);font-size:24px;font-weight:700;color:var(--gold);margin:10px 0 4px}
.ss-sub{font-size:13px;color:var(--muted);margin-bottom:20px}
.ss-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px}
.ss-stat{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center}
.ss-val{font-family:var(--ffm);font-size:22px;font-weight:700;color:var(--text)}
.ss-label{font-size:11px;color:var(--muted);margin-top:2px}
.replay-btn{padding:12px 28px;border-radius:12px;border:1px solid rgba(245,200,66,0.3);background:rgba(245,200,66,0.08);color:var(--gold);font-family:var(--ffm);font-size:11px;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s}
.replay-btn:hover{background:rgba(245,200,66,0.15)}
.hs-badge{font-family:var(--ffm);font-size:11px;color:var(--xp2);background:rgba(124,58,237,0.1);border:1px solid rgba(124,58,237,0.2);border-radius:8px;padding:6px 14px;display:inline-block;margin-top:10px}

/* LEARN TAB */
.learn-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.learn-card{background:var(--card2);border:1px solid var(--border);border-radius:14px;padding:16px;cursor:pointer;transition:all 0.25s}
.learn-card:hover{transform:translateY(-2px);border-color:rgba(255,255,255,0.12)}
.lc-icon{font-size:28px;margin-bottom:8px}
.lc-title{font-size:13px;font-weight:700;margin-bottom:4px}
.lc-sub{font-size:11px;color:var(--muted);line-height:1.4}
.lc-badge{display:inline-block;margin-top:8px;font-family:var(--ffm);font-size:9px;letter-spacing:0.1em;padding:2px 7px;border-radius:4px;background:rgba(124,58,237,0.1);color:var(--xp2)}

/* LESSON MODAL */
#lesson-modal{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,0.85);backdrop-filter:blur(16px);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity 0.3s;padding:18px}
#lesson-modal.show{opacity:1;pointer-events:all}
.lesson-box{background:var(--card);border:1px solid rgba(168,85,247,0.2);border-radius:22px;padding:28px;max-width:520px;width:100%;max-height:88vh;overflow-y:auto;transform:translateY(20px);transition:transform 0.35s cubic-bezier(0.34,1.56,0.64,1)}
#lesson-modal.show .lesson-box{transform:translateY(0)}
.lb-icon{font-size:48px;margin-bottom:12px}
.lb-title{font-family:var(--ffh);font-size:22px;font-weight:700;letter-spacing:0.06em;color:var(--gold);margin-bottom:16px}
.lb-body{font-size:14px;color:#7080a0;line-height:1.85}
.lb-body strong{color:var(--text);font-weight:700}
.lb-body h3{color:var(--xp2);font-family:var(--ffm);font-size:11px;letter-spacing:0.15em;text-transform:uppercase;margin:18px 0 6px;display:flex;align-items:center;gap:8px}
.lb-body h3::before{content:'';width:14px;height:1px;background:var(--xp2)}
.lb-body .example-box{background:rgba(124,58,237,0.06);border:1px solid rgba(124,58,237,0.15);border-radius:10px;padding:12px;margin:10px 0;font-size:13px;color:#8090b8}
.lb-close{margin-top:20px;padding:11px 24px;border-radius:12px;border:1px solid var(--border);background:var(--card2);color:var(--text);font-family:var(--ffm);font-size:11px;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;width:100%}
.lb-close:hover{border-color:var(--xp2);color:var(--xp2)}

/* LEVEL UP TOAST */
#lvl-toast{position:fixed;top:70px;left:50%;transform:translateX(-50%) translateY(-20px);z-index:1000;background:linear-gradient(135deg,var(--xp),var(--xp2));border-radius:20px;padding:12px 24px;display:flex;align-items:center;gap:10px;opacity:0;transition:all 0.4s cubic-bezier(0.34,1.56,0.64,1);pointer-events:none;box-shadow:0 8px 32px rgba(124,58,237,0.4)}
#lvl-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.lt-icon{font-size:22px}
.lt-text{font-family:var(--ffh);font-size:16px;font-weight:700;color:white;letter-spacing:0.06em}
.lt-sub{font-size:11px;color:rgba(255,255,255,0.7)}

/* ‚îÄ‚îÄ DRAG & DROP GAME ‚îÄ‚îÄ */
.drag-game-wrap{background:var(--card);border:1px solid rgba(168,85,247,0.2);border-radius:20px;padding:22px;margin-bottom:20px}
.drag-title{font-family:var(--ffh);font-size:18px;font-weight:700;margin-bottom:6px;letter-spacing:0.04em}
.drag-prompt{font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.6}
.drag-columns{display:grid;grid-template-columns:1fr 44px 1fr;gap:0;margin-bottom:16px;align-items:start}
.drag-col-title{font-family:var(--ffm);font-size:9px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:8px}
.drag-items{display:flex;flex-direction:column;gap:8px}
.drag-svg-col{position:relative}
.drag-item{padding:9px 12px;border-radius:10px;border:1.5px solid rgba(168,85,247,0.3);background:rgba(124,58,237,0.08);font-size:12px;font-weight:600;cursor:pointer;transition:all 0.2s;user-select:none;min-height:44px;display:flex;align-items:center}
.drag-item:hover{border-color:var(--xp2);background:rgba(124,58,247,0.14)}
.drag-item.dragging{opacity:0.4}
.drag-item.selected{border-color:var(--gold);background:rgba(245,200,66,0.1);box-shadow:0 0 0 2px rgba(245,200,66,0.25)}
.drag-item.matched{border-color:var(--green);background:rgba(0,230,118,0.08);color:var(--green)}
.drag-item.wrong-match{border-color:var(--red);background:rgba(255,69,96,0.08);animation:shake 0.4s ease}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.drop-zone{padding:9px 12px;border-radius:10px;border:1.5px dashed var(--border);background:var(--card2);font-size:12px;color:var(--muted);min-height:44px;transition:all 0.2s;display:flex;align-items:center;cursor:pointer}
.drop-zone:hover{border-color:rgba(168,85,247,0.35)}
.drop-zone.drag-over{border-color:var(--xp2);background:rgba(124,58,237,0.08);color:var(--text)}
.drop-zone.matched-target{border-style:solid;border-color:rgba(0,230,118,0.35);background:rgba(0,230,118,0.06);color:var(--text)}
.drop-zone.filled{border-style:solid;border-color:var(--green);background:rgba(0,230,118,0.1);color:var(--green)}
.drop-zone.wrong{border-color:rgba(255,69,96,0.5);background:rgba(255,69,96,0.07);animation:shake 0.4s ease}
.drag-submit-btn{padding:11px 28px;border-radius:12px;border:1px solid rgba(168,85,247,0.3);background:rgba(124,58,237,0.1);color:var(--xp2);font-family:var(--ffm);font-size:11px;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s;margin-top:12px}
.drag-submit-btn:hover{background:rgba(124,58,237,0.2)}

/* ‚îÄ‚îÄ TRAINEE TAB ‚îÄ‚îÄ */
.trainee-wrap{padding:4px 0}
.trainee-header{margin-bottom:24px}
.trainee-title{font-family:var(--ffh);font-size:22px;font-weight:700;letter-spacing:0.04em;margin-bottom:6px}
.trainee-sub{font-size:13px;color:var(--muted)}
.trainee-progress-wrap{margin-top:12px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
.trainee-prog-bar{height:8px;background:var(--dim);border-radius:4px;overflow:hidden;margin-bottom:8px}
.trainee-prog-fill{height:100%;background:linear-gradient(90deg,var(--xp),var(--xp2));border-radius:4px;transition:width 0.8s ease}
.trainee-prog-label{font-family:var(--ffm);font-size:10px;color:var(--muted)}
.module-list{display:flex;flex-direction:column;gap:10px}
.module-card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all 0.2s}
.module-card:hover{border-color:rgba(168,85,247,0.3);transform:translateX(3px)}
.module-card.completed{border-color:rgba(0,230,118,0.2);background:rgba(0,230,118,0.03)}
.module-card.locked{opacity:0.45;cursor:not-allowed}
.module-card.locked:hover{transform:none;border-color:var(--border)}
.module-num{width:36px;height:36px;border-radius:10px;background:var(--dim);display:flex;align-items:center;justify-content:center;font-family:var(--ffm);font-size:13px;font-weight:700;flex-shrink:0}
.module-card.completed .module-num{background:rgba(0,230,118,0.15);color:var(--green)}
.module-info{flex:1}
.module-title{font-size:13px;font-weight:700;margin-bottom:3px}
.module-sub{font-size:11px;color:var(--muted)}
.module-badge{font-family:var(--ffm);font-size:9px;padding:2px 8px;border-radius:4px;flex-shrink:0}
.module-badge.done{background:rgba(0,230,118,0.1);color:var(--green);border:1px solid rgba(0,230,118,0.3)}
.module-badge.todo{background:rgba(124,58,237,0.1);color:var(--xp2);border:1px solid rgba(124,58,237,0.2)}
.module-badge.lock{background:var(--dim);color:var(--muted);border:1px solid var(--border)}

/* ‚îÄ‚îÄ GLOSSARY MODAL ‚îÄ‚îÄ */
#glossary-modal{position:fixed;z-index:600;background:var(--card);border:1px solid rgba(168,85,247,0.3);border-radius:16px;padding:18px;max-width:300px;width:90%;box-shadow:0 20px 60px rgba(0,0,0,0.6);opacity:0;pointer-events:none;transition:opacity 0.2s;top:50%;left:50%;transform:translate(-50%,-50%)}
#glossary-modal.show{opacity:1;pointer-events:all}
.gm-word{font-family:var(--ffh);font-size:20px;font-weight:700;color:var(--gold);margin-bottom:10px;letter-spacing:0.04em}
.gm-def{font-size:13px;color:#7080a0;line-height:1.7}
.gm-close{margin-top:14px;padding:8px;border-radius:8px;border:1px solid var(--border);background:var(--card2);color:var(--muted);font-family:var(--ffm);font-size:10px;cursor:pointer;width:100%;transition:all 0.2s}
.gm-close:hover{color:var(--text)}
.keyword{color:var(--xp2);border-bottom:1px dotted rgba(168,85,247,0.5);cursor:help;transition:color 0.2s}
.keyword:hover{color:var(--gold)}

/* ‚îÄ‚îÄ CHAT ASSIST PANEL ‚îÄ‚îÄ */
#chat-btn{position:fixed;bottom:24px;right:20px;width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--xp),var(--xp2));border:none;font-size:22px;cursor:pointer;z-index:300;box-shadow:0 8px 24px rgba(124,58,237,0.4);transition:all 0.3s;display:none}
#chat-btn:hover{transform:scale(1.1);box-shadow:0 12px 32px rgba(124,58,237,0.5)}
#chat-btn.visible{display:flex;align-items:center;justify-content:center}
#chat-panel{position:fixed;bottom:88px;right:20px;width:310px;background:var(--card);border:1px solid rgba(168,85,247,0.25);border-radius:20px;z-index:300;box-shadow:0 20px 60px rgba(0,0,0,0.5);overflow:hidden;display:none;flex-direction:column;max-height:420px}
#chat-panel.open{display:flex}
.chat-header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px}
.chat-header-icon{font-size:18px}
.chat-header-title{font-family:var(--ffh);font-size:16px;font-weight:700;letter-spacing:0.04em;flex:1}
.chat-close-btn{background:none;border:none;color:var(--muted);font-size:16px;cursor:pointer;padding:2px 6px}
.chat-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.chat-msg{padding:10px 13px;border-radius:12px;font-size:12px;line-height:1.6;max-width:85%}
.chat-msg.bot{background:var(--card2);color:#8090b8;align-self:flex-start;border:1px solid var(--border)}
.chat-msg.user{background:rgba(124,58,237,0.15);color:var(--text);align-self:flex-end;border:1px solid rgba(168,85,247,0.2)}
.chat-input-row{padding:12px;border-top:1px solid var(--border);display:flex;gap:8px}
.chat-input{flex:1;background:var(--card2);border:1px solid var(--border);border-radius:10px;padding:9px 12px;color:var(--text);font-family:var(--ff);font-size:12px;outline:none}
.chat-input:focus{border-color:rgba(168,85,247,0.4)}
.chat-send-btn{padding:9px 14px;border-radius:10px;background:rgba(124,58,237,0.15);border:1px solid rgba(168,85,247,0.3);color:var(--xp2);font-family:var(--ffm);font-size:11px;cursor:pointer;transition:all 0.2s;white-space:nowrap}
.chat-send-btn:hover{background:rgba(124,58,237,0.25)}

/* RESPONSIVE */
@media(max-width:500px){.price-row{grid-template-columns:1fr 1fr}.learn-grid{grid-template-columns:1fr}.ss-grid{grid-template-columns:repeat(3,1fr)}.game-q{font-size:14px}.arenas-grid{grid-template-columns:1fr 1fr}.drag-columns{grid-template-columns:1fr}}
@media(max-width:360px){.arenas-grid{grid-template-columns:1fr}.price-row{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="orb orb1"></div>
<div class="orb orb2"></div>

<!-- LEVEL UP TOAST -->
<div id="lvl-toast">
  <span class="lt-icon">‚ö°</span>
  <div><div class="lt-text" id="lt-text">LEVEL UP!</div><div class="lt-sub" id="lt-sub">You reached Level 2</div></div>
</div>

<!-- LESSON MODAL -->
<div id="lesson-modal" onclick="closelesson()">
  <div class="lesson-box" onclick="event.stopPropagation()">
    <div class="lb-icon" id="lb-icon"></div>
    <div class="lb-title" id="lb-title"></div>
    <div class="lb-body" id="lb-body"></div>
    <button class="lb-close" onclick="closelesson()">Got it ‚Äî close lesson ‚úì</button>
  </div>
</div>

<!-- GLOSSARY MODAL -->
<div id="glossary-modal">
  <div class="gm-word" id="gm-word"></div>
  <div class="gm-def" id="gm-def"></div>
  <button class="gm-close" onclick="closeGlossary()">Close ‚úï</button>
</div>

<!-- CHAT ASSIST BUTTON -->
<button id="chat-btn" onclick="toggleChat()" title="Ask IQ Assistant">üí¨</button>

<!-- CHAT PANEL -->
<div id="chat-panel">
  <div class="chat-header">
    <span class="chat-header-icon">üß†</span>
    <span class="chat-header-title">IQ Assistant</span>
    <button class="chat-close-btn" onclick="toggleChat()">‚úï</button>
  </div>
  <div class="chat-messages" id="chat-messages">
    <div class="chat-msg bot">Hi! Ask me about finance, economics, or any term from this app. I'll do my best to explain.</div>
  </div>
  <div class="chat-input-row">
    <input class="chat-input" id="chat-input" placeholder="What is inflation?" onkeydown="if(event.key==='Enter')sendChat()">
    <button class="chat-send-btn" onclick="sendChat()">Send</button>
  </div>
</div>

<!-- TOPBAR -->
<div id="topbar" style="display:none;">
  <div style="display:flex;align-items:center;gap:14px;">
    <div class="tb-logo">WORLD IQ</div>
    <div id="tb-username" style="font-size:11px;color:var(--muted);font-family:var(--ffm);letter-spacing:0.08em;">Guest</div>
  </div>
  <div class="tb-mid">
    <div class="xp-wrap" onclick="showLvlModal()" style="cursor:pointer" title="Click to see level progress">
      <div class="xp-label">LV<span id="lv-inline">1</span></div>
      <div class="xp-bar" style="width:90px"><div class="xp-fill" id="xp-fill" style="width:0%"></div></div>
      <div class="xp-val" id="xp-val">0</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px">
    <div class="level-badge" onclick="showLvlModal()" id="level-badge-wrap" title="Click to see level details">
      <span class="lv-icon" id="lv-icon">üå±</span>
      <span class="lv-num" id="lv-num">1</span>
      <span class="lv-label">LVL</span>
    </div>
    <div class="streak-badge" onclick="showStreakInfo()">
      <span class="str-fire">üî•</span>
      <span class="str-num" id="str-num">1</span>
    </div>
    <div id="topbar-clock" style="font-family:var(--ffm);font-size:10px;color:var(--muted);"></div>
    <button onclick="logout()" style="padding:6px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card2);color:var(--text);font-family:var(--ffm);font-size:10px;letter-spacing:0.08em;cursor:pointer;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--red)';this.style.color='var(--red)';" onmouseout="this.style.borderColor='var(--border)';this.style.color='var(--text)';">LOGOUT</button>
  </div>
</div>

<!-- AUTH SCREEN -->
<div id="auth-screen" style="display:flex;align-items:center;justify-content:center;height:100vh;padding:20px;">
  <div style="background:var(--card);border:1px solid var(--border);border-radius:20px;padding:40px 32px;width:100%;max-width:380px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.5);">
    <div style="font-family:var(--ffh);font-size:28px;font-weight:700;margin-bottom:6px;letter-spacing:0.06em;">WORLD IQ</div>
    <div id="auth-mode-label" style="font-size:12px;color:var(--muted);margin-bottom:28px;letter-spacing:0.1em;text-transform:uppercase;">Create Account</div>

    <input type="text" id="username" placeholder="Username" style="width:100%;padding:12px;margin-bottom:12px;border-radius:10px;border:1px solid var(--border);background:var(--card2);color:var(--text);font-family:var(--ff);">
    <input type="email" id="email" placeholder="Email" style="width:100%;padding:12px;margin-bottom:12px;border-radius:10px;border:1px solid var(--border);background:var(--card2);color:var(--text);font-family:var(--ff);">
    <input type="password" id="password" placeholder="Password" style="width:100%;padding:12px;margin-bottom:20px;border-radius:10px;border:1px solid var(--border);background:var(--card2);color:var(--text);font-family:var(--ff);">

    <button id="signup-btn" type="button" onclick="signup()" style="display:block;width:100%;padding:12px;margin-bottom:10px;border-radius:12px;border:1px solid rgba(168,85,247,0.4);background:linear-gradient(135deg,var(--xp),var(--xp2));color:white;font-family:var(--ffm);font-size:11px;letter-spacing:0.1em;cursor:pointer;">CREATE ACCOUNT</button>
    <button id="login-btn" type="button" onclick="login()" style="display:none;width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--card2);color:var(--text);font-family:var(--ffm);font-size:11px;letter-spacing:0.1em;cursor:pointer;">LOGIN</button>

    <div style="margin-top:18px;font-size:11px;color:var(--muted);font-family:var(--ffm);">
      Already have an account? <span onclick="switchToLogin()" style="color:var(--xp2);cursor:pointer;">Login</span>
      &nbsp;|&nbsp;
      New user? <span onclick="switchToSignup()" style="color:var(--xp2);cursor:pointer;">Register</span>
    </div>
    <div id="auth-status" style="margin-top:12px;font-size:12px;color:var(--muted);min-height:18px;font-family:var(--ffm);"></div>
  </div>
</div>

<!-- HOME SCREEN -->
<div id="homescreen" style="display:none;">
  <div class="home-hero">
    <div class="home-greeting" id="home-greeting">Good morning</div>
    <div class="home-title">Learn <span>everything</span><br>about your world</div>
    <div class="home-sub">Pick an arena. Play, learn, earn XP. Beat yesterday's you.</div>
  </div>

  <div class="quest-bar">
    <div class="quest-icon">üéØ</div>
    <div class="quest-content">
      <div class="quest-title">Daily Quest ‚Äî Complete 2 arenas</div>
      <div class="quest-sub">You've visited <span id="quest-count">0</span> of 2 today</div>
      <div class="quest-progress-wrap">
        <div class="quest-prog-bar"><div class="quest-prog-fill" id="quest-fill" style="width:0%"></div></div>
        <div class="quest-pct" id="quest-pct">0%</div>
      </div>
    </div>
    <div class="quest-reward">+150 XP</div>
  </div>

  <div class="arenas-label">Choose Your Arena</div>
  <div class="arenas-grid">
    <div class="arena-card arena-gold" onclick="openArena('gold')">
      <div class="arena-emoji">ü•á</div>
      <div class="arena-name">Gold & Silver</div>
      <div class="arena-sub">Prices, reasons, forecasts & prediction games</div>
      <div class="arena-footer"><div class="arena-xp-badge">+50 XP/game</div><div class="arena-streak">‚Üë Hot today</div></div>
    </div>
    <div class="arena-card arena-india" onclick="openArena('india')">
      <div class="arena-emoji">üáÆüá≥</div>
      <div class="arena-name">India</div>
      <div class="arena-sub">Economy, politics, markets, culture</div>
      <div class="arena-footer"><div class="arena-xp-badge">+50 XP/game</div><div class="arena-streak">GDP: 8.4%</div></div>
    </div>
    <div class="arena-card arena-world" onclick="openArena('world')">
      <div class="arena-emoji">üåê</div>
      <div class="arena-name">World</div>
      <div class="arena-sub">Geopolitics, global events, nations</div>
      <div class="arena-footer"><div class="arena-xp-badge">+50 XP/game</div><div class="arena-streak">4 hot stories</div></div>
    </div>
    <div class="arena-card arena-tech" onclick="openArena('tech')">
      <div class="arena-emoji">‚ö°</div>
      <div class="arena-name">Tech & AI</div>
      <div class="arena-sub">AI, startups, chips, future tech</div>
      <div class="arena-footer"><div class="arena-xp-badge">+50 XP/game</div><div class="arena-streak">üî• Trending</div></div>
    </div>
    <div class="arena-card arena-markets" onclick="openArena('markets')">
      <div class="arena-emoji">üìà</div>
      <div class="arena-name">Markets</div>
      <div class="arena-sub">Stocks, crypto, indices, investing</div>
      <div class="arena-footer"><div class="arena-xp-badge">+50 XP/game</div><div class="arena-streak">Sensex +0.43%</div></div>
    </div>
    <div class="arena-card arena-science" onclick="openArena('science')">
      <div class="arena-emoji">üß¨</div>
      <div class="arena-name">Science</div>
      <div class="arena-sub">Space, physics, biology, discoveries</div>
      <div class="arena-footer"><div class="arena-xp-badge">+50 XP/game</div><div class="arena-streak">New mission!</div></div>
    </div>
  </div>

  <div class="arenas-label">Achievements</div>
  <div class="achieve-row" id="achieve-row">
    <div class="achieve" id="ach-first" onclick="showAchieve('First Step','You opened WORLD IQ for the first time. Every expert was once a beginner.')">
      <div class="achieve-icon">üöÄ</div><div class="achieve-name">First Step</div>
    </div>
    <div class="achieve locked" id="ach-quiz" onclick="showAchieve('Quiz Pro','Score 100 in any arena quiz. Your knowledge is exceptional!')">
      <div class="achieve-icon">üß†</div><div class="achieve-name">Quiz Pro</div>
    </div>
    <div class="achieve locked" id="ach-streak">
      <div class="achieve-icon">üî•</div><div class="achieve-name">Consistent</div>
    </div>
    <div class="achieve locked" id="ach-explorer">
      <div class="achieve-icon">üåç</div><div class="achieve-name">Explorer</div>
    </div>
    <div class="achieve locked" id="ach-cardmaster">
      <div class="achieve-icon">üÉè</div><div class="achieve-name">Card Master</div>
    </div>
    <div class="achieve locked" id="ach-diamond">
      <div class="achieve-icon">üíé</div><div class="achieve-name">Diamond IQ</div>
    </div>
  </div>
</div>

<!-- ARENA SCREEN -->
<div id="arenascreen">
  <div class="arena-topbar">
    <button class="back-btn" onclick="goHome()">‚Üê</button>
    <div class="arena-top-info">
      <div class="arena-top-name" id="arena-top-name">Gold & Silver</div>
      <div class="arena-top-sub" id="arena-top-sub">Prices ¬∑ Forecast ¬∑ Game ¬∑ Learn</div>
    </div>
    <div class="arena-top-xp" id="arena-xp-display">+0 XP today</div>
  </div>

  <div class="inner-tabs" id="inner-tabs">
    <button class="itab active" onclick="switchInner(0)">üìä Live</button>
    <button class="itab" onclick="switchInner(1)">ü§î Why?</button>
    <button class="itab" onclick="switchInner(2)">üîÆ Forecast</button>
    <button class="itab" onclick="switchInner(3)">üéÆ Game</button>
    <button class="itab" onclick="switchInner(4)">üìö Learn</button>
    <button class="itab" onclick="switchInner(5)">üéì Trainee</button>
  </div>

  <div class="arena-content">
    <div class="ipanel active" id="ip0"><div id="live-content"></div></div>
    <div class="ipanel" id="ip1"><div id="why-content"></div></div>
    <div class="ipanel" id="ip2"><div id="forecast-content"></div></div>
    <div class="ipanel" id="ip3"><div id="game-content"></div></div>
    <div class="ipanel" id="ip4"><div id="learn-content"></div></div>
    <div class="ipanel" id="ip5"><div id="trainee-content"></div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WORLD IQ ‚Äî UPGRADED ARCHITECTURE v2.0
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SUPABASE_URL = "https://cnerthaoxsgawokaultj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNuZXJ0aGFveHNnYXdva2F1bHRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2ODI0MjEsImV4cCI6MjA4NzI1ODQyMX0.j59L0Q7j-nbIQSY_NS4c2_cqoB0lrNJkzbjvWIHhlPg";

function initSupabase() {
  try {
    if (!window.supabase || !window.supabase.createClient) throw new Error("Supabase lib not loaded");
    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: false }
    });
    console.log("‚úÖ Supabase ready");
  } catch (err) { console.error("Supabase init error:", err); }
}
initSupabase();

// ‚îÄ‚îÄ AUTH UI MODE SWITCHING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchToLogin() {
  document.getElementById("username").style.display = "none";
  document.getElementById("signup-btn").style.display = "none";
  document.getElementById("login-btn").style.display = "block";
  document.getElementById("auth-mode-label").textContent = "Login to continue";
  document.getElementById("email").value = "";
  document.getElementById("password").value = "";
  document.getElementById("auth-status").textContent = "";
}
function switchToSignup() {
  document.getElementById("username").style.display = "block";
  document.getElementById("signup-btn").style.display = "block";
  document.getElementById("login-btn").style.display = "none";
  document.getElementById("auth-mode-label").textContent = "Create Account";
  document.getElementById("email").value = "";
  document.getElementById("password").value = "";
  document.getElementById("auth-status").textContent = "";
}

// ‚îÄ‚îÄ UI STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAuth() {
  document.getElementById("auth-screen").style.display = "flex";
  document.getElementById("homescreen").style.display = "none";
  document.getElementById("arenascreen").style.display = "none";
  document.getElementById("topbar").style.display = "none";
  document.getElementById("chat-btn").classList.remove("visible");
}
function showApp(username) {
  document.getElementById("auth-screen").style.display = "none";
  document.getElementById("homescreen").style.display = "block";
  document.getElementById("arenascreen").style.display = "none";
  document.getElementById("topbar").style.display = "flex";
  document.getElementById("chat-btn").classList.add("visible");
  if (username) document.getElementById("tb-username").innerText = username;
  updateXPBar();
  updateQuest();
  renderAchievements();
}

// ‚îÄ‚îÄ CACHE HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const CACHE_TTL_PRICES = 30 * 60 * 1000;
const CACHE_TTL_NEWS   = 60 * 60 * 1000;
function cacheSet(key, data, ttl) {
  try { localStorage.setItem(key, JSON.stringify({ ts: Date.now(), ttl, data })); } catch {}
}
function cacheGet(key) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (Date.now() - obj.ts > obj.ttl) return null;
    return obj.data;
  } catch { return null; }
}

// [FIX v2.1 - FIX 7] Daily seed using ISO date string as specified
// Generates a numeric seed from "YYYY-MM-DD" ‚Äî deterministic, changes daily
function getDailySeed() {
  const iso = new Date().toISOString().split("T")[0]; // "YYYY-MM-DD"
  // Convert date string to a stable integer seed
  return iso.split('').reduce((acc, ch) => (acc * 31 + ch.charCodeAt(0)) | 0, 0) >>> 0;
}
function seededRandom(seed) {
  let s = seed;
  return function() {
    s = (s * 1664525 + 1013904223) & 0xffffffff;
    return (s >>> 0) / 0xffffffff;
  };
}
function shuffleWithSeed(arr, seed) {
  const rand = seededRandom(seed);
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(rand() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

// ‚îÄ‚îÄ GLOSSARY SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GLOSSARY = {
  "inflation": "A sustained increase in the general price level of goods and services. When inflation is high, each unit of currency buys fewer goods. Central banks like RBI target 4% inflation in India.",
  "DXY": "Dollar Index ‚Äî measures the value of the US dollar against a basket of 6 major currencies (EUR, JPY, GBP, CHF, SEK, CAD). A rising DXY typically pushes gold prices down since gold is priced in USD globally.",
  "de-dollarization": "The global trend of countries reducing their dependence on the US dollar for trade and reserves. Central banks are buying gold and trading in local currencies instead of USD. China and India are leading this shift.",
  "repo rate": "The interest rate at which the Reserve Bank of India lends money to commercial banks. When RBI raises this rate, banks borrow at higher cost ‚Üí they raise loan rates ‚Üí economy cools. When RBI cuts it ‚Üí loans get cheaper ‚Üí economy heats up.",
  "SIP": "Systematic Investment Plan ‚Äî a method of investing a fixed amount regularly (usually monthly) in a mutual fund. The power of SIP comes from rupee cost averaging and compounding over long periods.",
  "Sensex": "The benchmark stock market index of the Bombay Stock Exchange (BSE), tracking 30 of India's largest companies. It's a barometer of India's economic health.",
  "Nifty": "The National Stock Exchange's flagship index tracking the top 50 companies listed on NSE. Along with Sensex, it measures overall Indian stock market performance.",
  "FII": "Foreign Institutional Investor ‚Äî large overseas entities (banks, hedge funds, pension funds) that invest in Indian markets. FII buying drives markets up; FII selling drives them down.",
  "gold/silver ratio": "How many ounces of silver it takes to buy one ounce of gold. Historical average: ~60:1. When the ratio is high (e.g. 89:1), silver is relatively cheap and often outperforms gold when it reverts to mean.",
  "CRISPR": "A revolutionary gene-editing technology that allows scientists to modify DNA sequences with precision. Named after naturally occurring sequences in bacteria, it works like molecular 'find and replace' for genetic code.",
  "GDP": "Gross Domestic Product ‚Äî the total monetary value of all goods and services produced in a country within a specific period. India's GDP growth of 8%+ makes it the world's fastest-growing large economy.",
  "safe haven": "An investment expected to retain or increase in value during times of market turbulence. Gold, US Treasury bonds, and the Swiss franc are classic safe havens ‚Äî investors buy them when fearful.",
  "MCX": "Multi Commodity Exchange ‚Äî India's largest commodity exchange where futures contracts for gold, silver, crude oil, copper etc. are traded. MCX gold prices are quoted in ‚Çπ per 10 grams.",
  "bull market": "A market condition where prices are rising or expected to rise. Generally defined as a 20%+ rise from recent lows. Opposite of bear market.",
  "bear market": "A market condition characterized by falling prices ‚Äî typically a 20%+ decline from recent highs over at least two months. Associated with pessimism and economic downturn.",
  "central bank": "A financial institution that manages a country's currency, money supply, and interest rates. Examples: RBI (India), Federal Reserve (USA), ECB (Europe). They print money and set interest rates.",
  "compounding": "The process where an investment's earnings generate their own earnings over time. Often called the 8th wonder of the world ‚Äî ‚Çπ1L growing at 12% for 30 years becomes ‚Çπ30L without adding any more money.",
  "ETF": "Exchange Traded Fund ‚Äî an investment fund traded on stock exchanges like individual stocks. A Nifty 50 ETF holds all 50 Nifty stocks proportionally, giving you diversified exposure cheaply.",
  "crude oil": "Unrefined petroleum extracted from the ground. India imports 85% of its crude oil needs. Rising crude prices increase petrol prices, raise transportation costs, and cause inflation.",
  "fusion energy": "A type of nuclear reaction where atomic nuclei combine to release massive energy ‚Äî the same process that powers the sun. Unlike fission (current nuclear plants), fusion produces no long-lived radioactive waste and uses hydrogen from water as fuel.",
};

function showGlossary(word) {
  const def = GLOSSARY[word.toLowerCase()] || GLOSSARY[word] || "Definition not available in current glossary.";
  document.getElementById("gm-word").textContent = word;
  document.getElementById("gm-def").textContent = def;
  document.getElementById("glossary-modal").classList.add("show");
}
function closeGlossary() {
  document.getElementById("glossary-modal").classList.remove("show");
}

// ‚îÄ‚îÄ LOCAL CHAT ASSIST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleChat() {
  const panel = document.getElementById("chat-panel");
  panel.classList.toggle("open");
}
function sendChat() {
  const input = document.getElementById("chat-input");
  const msg = input.value.trim();
  if (!msg) return;
  appendChatMsg(msg, "user");
  input.value = "";
  setTimeout(() => {
    const reply = getChatReply(msg);
    appendChatMsg(reply, "bot");
  }, 400);
}
function appendChatMsg(text, role) {
  const msgs = document.getElementById("chat-messages");
  const div = document.createElement("div");
  div.className = `chat-msg ${role}`;
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}
// [FIX v2.1 - FIX 5] Upgraded local chatbot with scoring-based keyword matching
// Matches partial words, scoring multiple keyword hits, Indian finance context, price-aware
function getChatReply(msg) {
  const lower = msg.toLowerCase().trim();

  // ‚îÄ‚îÄ 1. Glossary exact + substring match ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Score each glossary term by how well it matches
  let bestGlossaryWord = null, bestGlossaryScore = 0;
  for (const [word, def] of Object.entries(GLOSSARY)) {
    const wl = word.toLowerCase();
    if (lower.includes(wl)) {
      // Prefer longer matches (more specific)
      const score = wl.length + (lower === wl ? 50 : 0);
      if (score > bestGlossaryScore) {
        bestGlossaryScore = score;
        bestGlossaryWord = word;
      }
    }
    // Also check partial word match (e.g. "repos" matches "repo rate")
    const parts = wl.split(' ');
    if (parts.length > 1 && parts.every(p => lower.includes(p))) {
      const score = wl.length * 0.8;
      if (score > bestGlossaryScore) {
        bestGlossaryScore = score;
        bestGlossaryWord = word;
      }
    }
  }
  if (bestGlossaryWord) {
    const def = GLOSSARY[bestGlossaryWord];
    // Add price context if relevant
    let priceCtx = '';
    if ((bestGlossaryWord === 'gold/silver ratio' || bestGlossaryWord.includes('gold') || bestGlossaryWord.includes('silver')) && window._liveGold) {
      const g = window._liveGold;
      priceCtx = ` ¬∑ Current: Gold ‚Çπ${g.goldPer10g?.toLocaleString('en-IN')}/10g, Silver ‚Çπ${g.silverPerKg?.toLocaleString('en-IN')}/kg`;
    }
    return `üìñ ${bestGlossaryWord.toUpperCase()}: ${def}${priceCtx}`;
  }

  // ‚îÄ‚îÄ 2. Contextual topic patterns (keyword scoring) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const topics = [
    // price / value questions
    { keywords: ['gold price','sone ka bhav','gold today','gold rate','gold inr'], reply: () => {
      if (window._liveGold) return `ü•á Gold today: ‚Çπ${window._liveGold.goldPer10g?.toLocaleString('en-IN')}/10g (‚Çπ${window._liveGold.goldPerGram?.toLocaleString('en-IN')}/gram). USD ref: $${window._liveGold.goldUsd?.toFixed(0)}/oz. Exchange rate: ‚Çπ${window._liveGold.usdToInr?.toFixed(1)}/$`;
      return "ü•á Gold prices update live from metals.live. Open the Gold & Silver arena's Live tab for current Indian prices in ‚Çπ/10g and ‚Çπ/gram.";
    }},
    { keywords: ['silver price','chandi','silver today','silver rate','silver inr'], reply: () => {
      if (window._liveGold) return `ü•à Silver today: ‚Çπ${window._liveGold.silverPerKg?.toLocaleString('en-IN')}/kg (‚Çπ${window._liveGold.silverPerGram?.toLocaleString('en-IN')}/gram). Gold:Silver ratio = ${window._liveGold.gsRatio}:1.`;
      return "ü•à Silver prices update live. Open Gold & Silver arena ‚Üí Live tab for current INR prices.";
    }},
    // RBI / repo / interest rates
    { keywords: ['repo','rbi rate','interest rate','monetary policy','mpc meeting'], reply: () =>
      "üè¶ RBI's repo rate is the rate at which RBI lends to banks. Higher repo = expensive loans = cooling inflation. Lower repo = cheap loans = economic stimulus. Check the India arena for current RBI policy context."
    },
    // inflation
    { keywords: ['inflation','cpi','prices rising','price rise','cost of living'], reply: () =>
      "üìà Inflation in India is measured by CPI (Consumer Price Index). RBI targets 4% ¬± 2%. When inflation is high ‚Üí RBI raises repo rate ‚Üí loans expensive ‚Üí spending slows ‚Üí inflation cools. Gold is a classic inflation hedge."
    },
    // DXY / dollar
    { keywords: ['dxy','dollar index','usd','dollar','rupee','inr rate','usdinr'], reply: () => {
      const rate = cacheGet('dyn_usdinr') || '~84';
      return `üíµ DXY (Dollar Index) measures USD strength. USD/INR: ~‚Çπ${typeof rate === 'number' ? rate.toFixed(1) : rate}. When DXY rises ‚Üí Gold falls (gold is priced in USD). When DXY falls ‚Üí Gold rises, emerging markets rally.`;
    }},
    // gold vs fd / investment
    { keywords: ['invest gold','buy gold','gold vs','sgb','sovereign gold bond','gold etf'], reply: () =>
      "üí° Best ways to invest in gold in India: 1) Sovereign Gold Bonds (SGB) ‚Äî pays 2.5% interest + capital gains tax free on maturity. 2) Gold ETFs ‚Äî liquid, no storage risk. 3) Digital Gold via Augmont/MMTC-PAMP. Avoid jewellery for investment due to making charges."
    },
    // Sensex / Nifty / stock market
    { keywords: ['sensex','nifty','stock market','bse','nse','equity','share market'], reply: () =>
      "üìä Sensex tracks 30 top BSE companies; Nifty 50 tracks 50 top NSE companies. Both are Indian equity benchmarks. Long-term returns: ~13-14% CAGR. Best entry strategy: monthly SIP regardless of market level."
    },
    // crude oil / petrol
    { keywords: ['crude','oil price','petrol','diesel','brent'], reply: () =>
      "üõ¢Ô∏è India imports 85% of crude oil. When crude rises ‚Üí petrol prices rise ‚Üí inflation rises ‚Üí RBI considers rate hike. Crude is denominated in USD, so a weak rupee amplifies the impact on India."
    },
    // XP / gamification
    { keywords: ['xp','experience points','level up','how to level','earn xp'], reply: () =>
      "‚ö° XP is earned by: +20 XP first card view (each arena tab), quiz high scores (XP for improvement only, not replays), trainee module completion, daily quest (visit 2 arenas = +150 XP). 200 XP = 1 level."
    },
    { keywords: ['streak','daily streak','login streak','days in a row'], reply: () =>
      "üî• Streak = consecutive days you open WORLD IQ. 7-day streak unlocks 'Consistent' achievement. Keep visiting daily to maintain it!"
    },
    { keywords: ['achievement','badge','unlock'], reply: () =>
      "üèÜ Achievements: First Step (open app), Quiz Pro (100% in any quiz), Consistent (7-day streak), Explorer (visit all arenas), Card Master (10x same card), Diamond IQ (reach Level 10)."
    },
    { keywords: ['trainee','module','lesson','course'], reply: () =>
      "üéì Trainee Mode is in each arena's last tab. Modules unlock sequentially. Click a module, read the content, then click 'Mark Complete' to earn XP. XP is only awarded once per module."
    },
    // Arena navigation
    { keywords: ['arena','arena list','which arena','sections'], reply: () =>
      "üåç 6 Arenas: ü•á Gold & Silver (metals, Indian prices), üáÆüá≥ India (RBI, GDP, budget), üåê World (Fed, geopolitics), üíª Tech & AI (chips, AI, startups), üìä Markets (stocks, crypto, SIP), üî¨ Science (ISRO, CRISPR, fusion)."
    },
    // Investment disclaimers
    { keywords: ['should i buy','should i invest','recommend','which stock','portfolio advice'], reply: () =>
      "‚ö†Ô∏è WORLD IQ is an educational platform, not a financial advisor. For personal investment advice, consult a SEBI-registered advisor. We teach you how to think about markets, not what to do with your money."
    },
    // Crypto / bitcoin
    { keywords: ['bitcoin','crypto','ethereum','blockchain','btc'], reply: () =>
      "‚Çø Crypto in India: 30% flat tax on gains + 1% TDS per transaction. Bitcoin = digital store of value (21M fixed supply). Ethereum = programmable blockchain. Limit crypto to 2-5% of portfolio maximum."
    },
  ];

  // Score each topic by number of keyword matches
  let bestTopic = null, bestTopicScore = 0;
  for (const t of topics) {
    let score = 0;
    for (const kw of t.keywords) {
      if (lower.includes(kw)) score += kw.split(' ').length; // longer phrases score higher
    }
    if (score > bestTopicScore) { bestTopicScore = score; bestTopic = t; }
  }
  if (bestTopic) return bestTopic.reply();

  // ‚îÄ‚îÄ 3. Default helpful message ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const suggestions = Object.keys(GLOSSARY).slice(0, 6).map(w => `"${w}"`).join(', ');
  return `üí¨ I'm your WORLD IQ finance assistant. Ask me about: gold price, silver price, DXY, repo rate, inflation, SIP, Sensex, crude oil, or glossary terms like ${suggestions}. I'm fully local ‚Äî no AI API needed!`;
}

// ‚îÄ‚îÄ STATE MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// [STORAGE KEYS] wiq_xp, wiq_level, wiq_streak, wiq_correct,
// wiq_highscores, wiq_completed_cards, wiq_achievements,
// wiq_trainee_progress, wiq_quest_date, wiq_visited_today
// wiq_uid ‚Äî stores current user_id to detect user switches
const S = {
  xp:          parseInt(localStorage.getItem('wiq_xp')      || '0'),
  level:       1, // will be recalculated from XP after getLevelFromXP is defined
  streak:      1,
  questCount:  0,
  arenaXP:     0,
  currentArena:'gold',
  visitedArenas: new Set(),
  totalCorrect: parseInt(localStorage.getItem('wiq_correct') || '0'),
};
// Recalculate level from XP (getLevelFromXP defined above)
S.level = getLevelFromXP(S.xp);

// ‚îÄ‚îÄ STREAK LOGIC (date-based) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function initStreak() {
  const today = new Date().toDateString();
  const yesterday = new Date(Date.now() - 86400000).toDateString();
  const raw = JSON.parse(localStorage.getItem('wiq_streak') || '{"count":1,"last":""}');
  if (raw.last === today) {
    S.streak = raw.count;
  } else if (raw.last === yesterday) {
    raw.count += 1;
    raw.last = today;
    S.streak = raw.count;
    localStorage.setItem('wiq_streak', JSON.stringify(raw));
  } else {
    raw.count = 1;
    raw.last = today;
    S.streak = 1;
    localStorage.setItem('wiq_streak', JSON.stringify(raw));
  }
})();

// ‚îÄ‚îÄ QUEST STATE (resets daily) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function initQuest() {
  const today = new Date().toDateString();
  const stored = localStorage.getItem('wiq_quest_date');
  if (stored !== today) {
    localStorage.setItem('wiq_quest_date', today);
    localStorage.setItem('wiq_visited_today', '[]');
  }
  const visited = JSON.parse(localStorage.getItem('wiq_visited_today') || '[]');
  S.questCount = Math.min(visited.length, 2);
  visited.forEach(v => S.visitedArenas.add(v));
})();

// ‚îÄ‚îÄ LEVEL SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Level 1 needs 100 XP, Level 2 needs 200 more, Level 3 needs 300 more, etc.
// Cumulative XP to reach level N: N*(N+1)/2 * 100
// e.g. Lv1=100, Lv2=300, Lv3=600, Lv4=1000, Lv5=1500 ...
function xpToReachLevel(n) {
  if (n <= 1) return 0;
  return (n - 1) * n / 2 * 100; // cumulative XP needed to START level n
}
function xpNeededForLevel(n) {
  return n * 100; // XP needed to COMPLETE level n and advance
}
function getLevelFromXP(xp) {
  // Find highest level N where xpToReachLevel(N) <= xp
  // xpToReachLevel(N) = (N-1)*N/2*100
  // Solve: (N-1)*N/2*100 <= xp ‚Üí N^2-N-2xp/100 <= 0
  const n = Math.floor((1 + Math.sqrt(1 + 8 * xp / 100)) / 2);
  return Math.max(1, n);
}
function xpWithinLevel(xp) {
  // XP earned within the current level (for the progress bar)
  const lv = getLevelFromXP(xp);
  return xp - xpToReachLevel(lv);
}
function xpForCurrentLevel(xp) {
  // Total XP needed to complete the current level
  const lv = getLevelFromXP(xp);
  return xpNeededForLevel(lv);
}
function getLevelTitle(lv) {
  if (lv <= 2)  return 'Curious Beginner üå±';
  if (lv <= 4)  return 'Market Watcher üì∞';
  if (lv <= 6)  return 'Informed Investor üìä';
  if (lv <= 8)  return 'Finance Analyst üåç';
  if (lv <= 10) return 'World Strategist üß†';
  if (lv <= 15) return 'Intelligence Master üíé';
  return 'World IQ Legend üèÜ';
}
const XP_PER_LEVEL = 200; // legacy fallback, not used in new system

// ‚îÄ‚îÄ SUPABASE SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// [FIX 1] saveState: always writes LS first (offline safe), then Supabase
async function saveState() {
  // Always persist locally first ‚Äî never lose data
  localStorage.setItem('wiq_xp',      String(S.xp));
  localStorage.setItem('wiq_level',   String(S.level));
  localStorage.setItem('wiq_correct', String(S.totalCorrect));
  // Async Supabase sync ‚Äî non-blocking
  try {
    if (!window.supabaseClient) return;
    const { data: { user } } = await supabaseClient.auth.getUser();
    if (!user) return;
    // Reconcile: read server value first, only write if our local is >= server
    // This prevents a stale local from overwriting a fresher server value
    const { data: srv } = await supabaseClient.from('profiles').select('xp,level,total_correct').eq('user_id', user.id).single();
    const finalXP      = srv ? Math.max(S.xp, srv.xp || 0)                    : S.xp;
    const finalLevel   = srv ? Math.max(S.level, srv.level || 1)               : S.level;
    const finalCorrect = srv ? Math.max(S.totalCorrect, srv.total_correct || 0): S.totalCorrect;
    // Update S with reconciled values
    S.xp = finalXP; S.level = finalLevel; S.totalCorrect = finalCorrect;
    localStorage.setItem('wiq_xp',      String(S.xp));
    localStorage.setItem('wiq_level',   String(S.level));
    localStorage.setItem('wiq_correct', String(S.totalCorrect));
    // Use UPDATE not upsert ‚Äî profile already exists after first login
    await supabaseClient.from('profiles').update({
      xp:            S.xp,
      level:         S.level,
      streak:        S.streak,
      total_correct: S.totalCorrect,
      achievements:  JSON.stringify(getAchievements()),
      updated_at:    new Date().toISOString()
    }).eq('user_id', user.id);
  } catch (e) { console.warn('[WIQ] Sync (non-blocking):', e.message); }
}

// [FIX v2.1] loadUserProfile: SERVER IS SOURCE OF TRUTH
// LS used as offline cache; reconcile on every login using MAX values
async function loadUserProfile(user) {
  const uname = user.user_metadata?.username || user.email.split('@')[0];
  // [v2.1 FIX] Removed client-side user-switch detection ‚Äî it was incorrectly
  // wiping data for the same user. The server reconciliation (MAX logic below)
  // safely handles all cases: same user re-login, new user, offline play.
  // Just stamp the UID for informational purposes only ‚Äî never use it to wipe data.
  localStorage.setItem('wiq_uid', user.id);
  try {
    if (!window.supabaseClient) { showApp(uname); return; }
    const { data, error } = await supabaseClient.from('profiles').select('*').eq('user_id', user.id).single();
    if (error && error.code === 'PGRST116') {
      // Brand new user ‚Äî read LS in case they played before signup
      const localXP  = parseInt(localStorage.getItem('wiq_xp')     || '0');
      const localLv  = parseInt(localStorage.getItem('wiq_level')   || '1');
      const localCor = parseInt(localStorage.getItem('wiq_correct') || '0');
      await supabaseClient.from('profiles').insert([{
        user_id:       user.id,
        username:      uname,
        xp:            localXP,
        level:         localLv,
        streak:        S.streak,
        total_correct: localCor,
        achievements:  localStorage.getItem('wiq_achievements') || '[]',
        updated_at:    new Date().toISOString()
      }]);
      S.xp = localXP; S.level = localLv; S.totalCorrect = localCor;
      localStorage.setItem('wiq_xp', String(S.xp));
      localStorage.setItem('wiq_level', String(S.level));
      showApp(uname);
    } else if (!error && data) {
      // [v2.2 FIX] SERVER IS ALWAYS THE SOURCE OF TRUTH on login.
      // Never take MAX with localStorage ‚Äî that causes XP from a previous user
      // on the same device to bleed into the current user's account.
      // localStorage is ONLY written after we load from server, so it always
      // reflects this user's data for offline fallback.
      S.xp          = data.xp           || 0;
      S.level        = data.level        || 1;
      S.totalCorrect = data.total_correct|| 0;
      // Restore streak from server
      if (data.streak) S.streak = data.streak;
      // Restore achievements from server (authoritative), merge any local-only ones
      if (data.achievements) {
        try {
          const srvAch = JSON.parse(data.achievements);
          const locAch = getAchievements();
          // Only merge local achievements if they belong to this UID
          const storedUid = localStorage.getItem('wiq_uid');
          const merged = storedUid === user.id ? [...new Set([...srvAch, ...locAch])] : srvAch;
          localStorage.setItem('wiq_achievements', JSON.stringify(merged));
        } catch {}
      }
      // Overwrite LS with THIS user's server data ‚Äî clears any previous user's cached data
      localStorage.setItem('wiq_uid',     user.id);
      localStorage.setItem('wiq_xp',      String(S.xp));
      localStorage.setItem('wiq_level',   String(S.level));
      localStorage.setItem('wiq_correct', String(S.totalCorrect));
      // Recalculate level from XP in case of any drift
      S.level = getLevelFromXP(S.xp);
      localStorage.setItem('wiq_level', String(S.level));
      showApp(data.username || uname);
    } else {
      // Unexpected error ‚Äî only use local cache if it belongs to this same user
      const storedUid = localStorage.getItem('wiq_uid');
      if (storedUid === user.id) {
        S.xp          = parseInt(localStorage.getItem('wiq_xp')     || '0');
        S.level        = parseInt(localStorage.getItem('wiq_level')   || '1');
        S.totalCorrect = parseInt(localStorage.getItem('wiq_correct') || '0');
      } else {
        S.xp = 0; S.level = 1; S.totalCorrect = 0;
      }
      showApp(uname);
    }
  } catch (e) {
    console.warn('[WIQ] Profile load failed ‚Äî using local cache:', e.message);
    const storedUid = localStorage.getItem('wiq_uid');
    if (storedUid === user.id) {
      S.xp          = parseInt(localStorage.getItem('wiq_xp')     || '0');
      S.level        = parseInt(localStorage.getItem('wiq_level')   || '1');
      S.totalCorrect = parseInt(localStorage.getItem('wiq_correct') || '0');
    } else {
      S.xp = 0; S.level = 1; S.totalCorrect = 0;
    }
    showApp(uname);
  }
}

// ‚îÄ‚îÄ HIGH SCORE SYSTEM (prevents XP farming) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getHighscores() { return JSON.parse(localStorage.getItem('wiq_highscores') || '{}'); }
function setHighscore(arena, score) {
  const hs = getHighscores();
  hs[arena] = score;
  localStorage.setItem('wiq_highscores', JSON.stringify(hs));
}
function processGameXP(arena, currentScore) {
  const hs = getHighscores();
  const prev = hs[arena] || 0;
  if (currentScore > prev) {
    const diff = currentScore - prev;
    setHighscore(arena, currentScore);
    addXP(diff);
    return { awarded: diff, isNewHS: true };
  }
  return { awarded: 0, isNewHS: false };
}

// ‚îÄ‚îÄ CARD COMPLETION SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Storage key: wiq_completed_cards = { "gold_0": count, "gold_1": count, ... }
function getCompletedCards() { return JSON.parse(localStorage.getItem('wiq_completed_cards') || '{}'); }
function recordCardCompletion(arena, tabIdx) {
  const key = `${arena}_${tabIdx}`;
  const cards = getCompletedCards();
  const prev = cards[key] || 0;
  cards[key] = prev + 1;
  localStorage.setItem('wiq_completed_cards', JSON.stringify(cards));
  // First completion reward
  if (prev === 0) {
    addXP(20);
    showLevelUp('Card explored! +20 XP');
  }
  // Card Master achievement: 10 completions of same card
  if (cards[key] >= 10) unlockAchievement('card_master');
  // Check arena explorer (all 6 arenas visited)
  const allArenas = ['gold','india','world','tech','markets','science'];
  const visited = allArenas.filter(a => cards[`${a}_0`] > 0);
  if (visited.length === 6) unlockAchievement('arena_explorer');
}

// ‚îÄ‚îÄ ACHIEVEMENT SYSTEM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Storage key: wiq_achievements = ["first_step","quiz_pro",...]
const ACHIEVEMENT_META = {
  first_step:     { id: 'ach-first',     name: 'First Step',   desc: 'You opened WORLD IQ for the first time!' },
  quiz_pro:       { id: 'ach-quiz',      name: 'Quiz Pro',     desc: 'You scored 100 in an arena quiz. Exceptional!' },
  consistent:     { id: 'ach-streak',    name: 'Consistent',   desc: '7-day streak! Your learning habit is forming.' },
  arena_explorer: { id: 'ach-explorer',  name: 'Explorer',     desc: 'You visited all 6 arenas. True World IQ!' },
  card_master:    { id: 'ach-cardmaster',name: 'Card Master',  desc: '10 completions of the same card. Dedicated learner!' },
  diamond_iq:     { id: 'ach-diamond',   name: 'Diamond IQ',   desc: 'Reached Level 10. You are in the top tier!' },
};
function getAchievements() { return JSON.parse(localStorage.getItem('wiq_achievements') || '[]'); }
function unlockAchievement(key) {
  const list = getAchievements();
  if (list.includes(key)) return;
  list.push(key);
  localStorage.setItem('wiq_achievements', JSON.stringify(list));
  const meta = ACHIEVEMENT_META[key];
  if (meta) {
    showLevelUp(`üèÜ Achievement Unlocked: ${meta.name}`);
    setTimeout(() => renderAchievements(), 500);
  }
}
function renderAchievements() {
  const list = getAchievements();
  Object.entries(ACHIEVEMENT_META).forEach(([key, meta]) => {
    const el = document.getElementById(meta.id);
    if (!el) return;
    if (list.includes(key)) {
      el.classList.remove('locked');
      el.onclick = () => showAchieve(meta.name, meta.desc);
    }
  });
}

// ‚îÄ‚îÄ API FETCHERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getMetalPrices() {
  const cached = cacheGet('dyn_metals');
  if (cached) return cached;
  // Multiple free metal price APIs tried in order
  const METAL_APIS = [
    // 1. metals.live (USD spot)
    async () => {
      const res = await fetch('https://api.metals.live/v1/spot', { signal: AbortSignal.timeout(6000) });
      const arr = await res.json();
      const d = {};
      arr.forEach(item => Object.assign(d, item));
      if (!d.gold || d.gold < 1500) throw new Error('Implausible: ' + d.gold);
      return d;
    },
    // 2. metals-api free tier via allorigins proxy
    async () => {
      const url = 'https://metals-api.com/api/latest?access_key=free&base=USD&symbols=XAU,XAG,XPT,XPD';
      const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`, { signal: AbortSignal.timeout(7000) });
      const j = await res.json();
      const rates = JSON.parse(j.contents).rates;
      // metals-api returns oz in terms of 1 unit base ‚Äî XAU rate = USD per oz (inverted)
      const gold = rates.XAU ? 1 / rates.XAU : null;
      if (!gold || gold < 1500) throw new Error('Bad metals-api data');
      return { gold, silver: rates.XAG ? 1/rates.XAG : 32, platinum: rates.XPT ? 1/rates.XPT : 990, palladium: rates.XPD ? 1/rates.XPD : 1000 };
    },
  ];
  for (const fn of METAL_APIS) {
    try {
      const data = await fn();
      cacheSet('dyn_metals', data, CACHE_TTL_PRICES);
      return data;
    } catch (e) { console.warn('[WIQ] metals API attempt failed:', e.message); }
  }
  const stale = (() => { try { const r = localStorage.getItem('dyn_metals'); if (r) { const o = JSON.parse(r); if (o.data?.gold > 1500) return o.data; } } catch {} return null; })();
  return stale || { gold: 2940, silver: 33.0, palladium: 1010, platinum: 995 };
}
// [FIX v2.1 - FIX 2] USD‚ÜíINR with multi-endpoint fallback chain
// Tries: Frankfurter ‚Üí exchangerate.host ‚Üí Open Exchange Rates (free) ‚Üí stale cache ‚Üí hardcoded
const FX_FALLBACK_RATE = 84.0; // updated hardcoded fallback
async function getUsdInr() {
  const cached = cacheGet('dyn_usdinr');
  if (cached) return cached;
  // Try multiple free FX APIs in sequence
  const FX_APIS = [
    // Frankfurter (ECB data, very reliable)
    async () => {
      const r = await fetch('https://api.frankfurter.app/latest?from=USD&to=INR', { signal: AbortSignal.timeout(5000) });
      const j = await r.json();
      return j.rates?.INR;
    },
    // ExchangeRate-API free tier (100 req/month no key needed for open endpoint)
    async () => {
      const r = await fetch('https://open.er-api.com/v6/latest/USD', { signal: AbortSignal.timeout(5000) });
      const j = await r.json();
      return j.rates?.INR;
    },
    // exchangerate.host
    async () => {
      const r = await fetch('https://api.exchangerate.host/latest?base=USD&symbols=INR', { signal: AbortSignal.timeout(5000) });
      const j = await r.json();
      return j.rates?.INR;
    },
  ];
  for (const fn of FX_APIS) {
    try {
      const rate = await fn();
      if (rate && rate > 50 && rate < 200) { // sanity check
        cacheSet('dyn_usdinr', rate, CACHE_TTL_PRICES);
        return rate;
      }
    } catch {}
  }
  // Fall back to stale cache (any age), then hardcoded
  const stale = (() => {
    try { const r = localStorage.getItem('dyn_usdinr'); if (r) { const o = JSON.parse(r); return o.data; } } catch {} return null;
  })();
  return stale || FX_FALLBACK_RATE;
}

// [FIX 2] getIndianMetalPrices: returns INR-denominated gold & silver with proper conversion
// Gold: ‚Çπ per 10g (Indian jewellery standard)
// Silver: ‚Çπ per kg (Indian bullion standard)
async function getIndianMetalPrices() {
  const cacheKey = 'dyn_indian_metals';
  const cached = cacheGet(cacheKey);
  if (cached) return cached;
  const [metals, usdInr] = await Promise.all([getMetalPrices(), getUsdInr()]);
  const goldUsd     = metals.gold      || 2034;
  const silverUsd   = metals.silver    || 22.8;
  const platinumUsd = metals.platinum  || 950;
  const palladiumUsd= metals.palladium || 1000;
  // Conversion formulas:
  // Gold: (price_per_troy_oz √ó usdInr) / 31.1035 √ó 10  ‚Üí price per 10 grams
  // Silver: price_per_troy_oz √ó usdInr √ó 32.1507        ‚Üí price per kg (1 troy oz = 0.0311035 kg; 1kg = 32.1507 troy oz)
  // India gold pricing: spot USD/oz √ó INR rate / 31.1035g √ó India tax factor
  // Import duty 12.5% + AgriCess 5% on duty (= 13.125%) + GST 3% + misc ~0.5% = ~16.5% effective
  // Empirically calibrated to match live MCX prices: 1.165 works well at current prices
  const INDIA_TAX   = 1.165;
  const goldPerGram  = Math.round(goldUsd   * usdInr / 31.1035 * INDIA_TAX);
  const goldPer10g   = goldPerGram * 10;
  // Silver: lower import duty (10%) + GST 3% = 1.13 effective
  const SILVER_TAX   = 1.13;
  const silverPerKg  = Math.round(silverUsd * usdInr * 32.1507 * SILVER_TAX);
  const silverPer10g = Math.round(silverPerKg / 100);
  // MCX values (same as per-gram with tax, MCX IS the Indian spot)
  const mcxGold  = goldPer10g;
  const mcxSilver= silverPerKg;
  const gsRatio  = (goldUsd / silverUsd).toFixed(1);
  const result = {
    goldUsd, silverUsd, platinumUsd, palladiumUsd, usdInr,
    goldPer10g, goldPerGram, mcxGold,
    silverPerKg, silverPer10g, mcxSilver,
    gsRatio,
    trend: goldUsd > 2200 ? 'STRONG BULL üü¢' : goldUsd > 2000 ? 'BULL üü¢' : goldUsd > 1800 ? 'NEUTRAL üü°' : 'BEAR üî¥',
    fetchedAt: Date.now()
  };
  cacheSet(cacheKey, result, CACHE_TTL_PRICES);
  return result;
}
async function getQuote(symbol) {
  const key = `dyn_q_${symbol}`;
  const cached = cacheGet(key);
  if (cached) return cached;
  try {
    const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(symbol)}?interval=1d&range=2d`;
    const proxy = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const res = await fetch(proxy, { signal: AbortSignal.timeout(8000) });
    const json = await res.json();
    const chart = JSON.parse(json.contents).chart.result[0];
    const meta = chart.meta;
    const price = meta.regularMarketPrice;
    const prev  = meta.previousClose || meta.chartPreviousClose;
    const chg   = price - prev;
    const pct   = (chg / prev * 100);
    const data  = { price, prev, chg, pct, currency: meta.currency, symbol };
    cacheSet(key, data, CACHE_TTL_PRICES);
    return data;
  } catch (e) {
    console.warn('[WIQ] Yahoo quote failed for', symbol, e);
    return null;
  }
}
function fmtQuote(q, label, sub, color) {
  if (!q) return `<div class="pc-tag" style="color:${color}">${label}</div><div class="pc-sub" style="margin-top:8px;color:var(--muted)">‚è≥ Refreshing live data...</div><div style="font-size:10px;color:var(--muted);margin-top:4px">Last known value being restored</div>`;
  const up = q.chg >= 0;
  const sign = up ? '‚ñ≤ +' : '‚ñº ';
  // [FIX 6] Always show INR equivalent if price is in USD
  const isInr = q.currency === 'INR';
  const priceStr = isInr
    ? '‚Çπ' + Math.round(q.price).toLocaleString('en-IN')
    : '$' + q.price.toLocaleString('en-US', { maximumFractionDigits: 2 });
  const chgStr = isInr
    ? `${sign}${Math.abs(Math.round(q.chg)).toLocaleString('en-IN')} (${up?'+':''}${q.pct.toFixed(2)}%)`
    : `${sign}${Math.abs(q.chg).toFixed(2)} (${up?'+':''}${q.pct.toFixed(2)}%)`;
  // Add INR note for non-INR prices
  const inrNote = !isInr && q.price > 0 ? (() => {
    const rate = cacheGet('dyn_usdinr') || 84;
    if (typeof rate === 'number') {
      return `<div style="font-size:10px;color:var(--muted);margin-top:4px">‚âà ‚Çπ${Math.round(q.price * rate).toLocaleString('en-IN')} at ‚Çπ${rate.toFixed(1)}/USD</div>`;
    }
    return '';
  })() : '';
  return `<div class="pc-tag" style="color:${color}">${label}</div>
    <div class="pc-price">${priceStr}</div>
    <div class="pc-sub">${sub}</div>
    <div class="pc-change ${up?'up':'dn'}">${chgStr}</div>${inrNote}`;
}

// ‚îÄ‚îÄ RSS NEWS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const RSS_FEEDS = {
  india:   'https://economictimes.indiatimes.com/markets/rssfeeds/1977021501.cms',
  world:   'https://feeds.feedburner.com/ndtvnews-world-news',
  tech:    'https://techcrunch.com/feed/',
  markets: 'https://economictimes.indiatimes.com/markets/stocks/rssfeeds/2146842.cms',
  science: 'https://www.sciencenews.org/feed',
};
const FALLBACK_NEWS = {
  india:   [{title:'India GDP growth remains among fastest globally',desc:'Economy continues to outperform G20 peers driven by manufacturing and services',tag:'ECONOMY'},{title:'Sensex and Nifty react to global market moves',desc:'FII flows and global cues drive Indian equity markets daily',tag:'MARKETS'},{title:'RBI policy meeting outcome watched closely',desc:'Rate decisions impact EMIs, bond yields and rupee value',tag:'RBI'},{title:'Indian IT sector wins global AI contracts',desc:'Infosys, TCS, Wipro secure multi-year AI transformation deals',tag:'TECH'}],
  world:   [{title:'US Federal Reserve holds interest rate decision',desc:'Rate outlook drives global capital flows and emerging market currencies',tag:'USA'},{title:'China economy data impacts commodity demand outlook',desc:'Industrial output numbers move oil, copper and metals globally',tag:'CHINA'},{title:'EU regulatory moves reshape global tech landscape',desc:'New rules affect AI companies and data privacy standards',tag:'EUROPE'},{title:'Middle East tensions affect oil prices',desc:'Geopolitical risk premium built into crude oil and gold',tag:'GULF'}],
  tech:    [{title:'AI chip demand continues to surge worldwide',desc:'NVIDIA and semiconductor stocks reflect unprecedented AI infrastructure spending',tag:'AI'},{title:'Indian AI startups raise record funding',desc:'Sarvam, Krutrim and others building India-specific language models',tag:'INDIA AI'},{title:'OpenAI and Google release next-gen models',desc:'Competition in foundation AI models intensifies across all fronts',tag:'AI'},{title:'Global tech M&A activity picks up pace',desc:'Large acquisitions signal confidence in long-term tech growth',tag:'DEALS'}],
  markets: [{title:'Global equities track US earnings season',desc:'Corporate results drive sector rotation and index moves worldwide',tag:'EQUITIES'},{title:'Bitcoin and crypto markets react to macro data',desc:'Crypto correlates increasingly with risk appetite and dollar strength',tag:'CRYPTO'},{title:'Commodity markets driven by supply-demand shifts',desc:'Oil, metals and agri-commodities move on global data releases',tag:'COMMODITIES'},{title:'Bond yields signal inflation and rate expectations',desc:'Fixed income markets often lead equity movements by weeks',tag:'BONDS'}],
  science: [{title:'ISRO advances India space mission milestones',desc:'Indian space programme accelerates with commercial and government launches',tag:'SPACE'},{title:'CRISPR gene therapy trials show promising results',desc:'Gene editing technology moves closer to treating hereditary diseases',tag:'BIO'},{title:'Fusion energy research achieves new milestone',desc:'Scientists push closer to commercially viable clean fusion power',tag:'ENERGY'},{title:'AI accelerates drug discovery timelines dramatically',desc:'Machine learning cuts years from pharmaceutical development process',tag:'AI+BIO'}],
};
async function getNews(arena) {
  const key = `dyn_news_${arena}`;
  const cached = cacheGet(key);
  if (cached) return cached;
  try {
    const feedUrl = RSS_FEEDS[arena];
    const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}&count=5`;
    const res = await fetch(api, { signal: AbortSignal.timeout(8000) });
    const json = await res.json();
    if (json.status !== 'ok') throw new Error('RSS error');
    const items = json.items.slice(0, 5).map(item => ({
      title: item.title.replace(/<[^>]*>/g, '').substring(0, 80),
      desc: (item.description || item.content || '').replace(/<[^>]*>/g, '').substring(0, 100).trim(),
      tag: (item.categories && item.categories[0]) ? item.categories[0].toUpperCase().substring(0, 10) : arena.toUpperCase(),
    }));
    cacheSet(key, items, CACHE_TTL_NEWS);
    return items;
  } catch (e) {
    console.warn('[WIQ] RSS failed for', arena, e);
    return FALLBACK_NEWS[arena] || [];
  }
}

// ‚îÄ‚îÄ RENDER HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const today = () => new Date().toLocaleDateString('en-IN', { day: 'numeric', month: 'short', year: 'numeric' });
function skeleton(lines = 3) {
  return Array(lines).fill('<div class="price-loading" style="height:14px;margin-bottom:8px;display:block;border-radius:6px"></div>').join('');
}
function newsEmoji(title, tag) {
  const t = (title + tag).toLowerCase();
  if (t.includes('space')||t.includes('isro')||t.includes('nasa')) return 'üöÄ';
  if (t.includes('ai')||t.includes('artificial')) return 'ü§ñ';
  if (t.includes('crypto')||t.includes('bitcoin')) return '‚Çø';
  if (t.includes('gold')||t.includes('silver')) return 'ü•á';
  if (t.includes('oil')||t.includes('crude')) return 'üõ¢Ô∏è';
  if (t.includes('rbi')||t.includes('bank')||t.includes('rate')) return 'üè¶';
  if (t.includes('india')) return 'üáÆüá≥';
  if (t.includes('usa')||t.includes('fed')||t.includes('dollar')) return 'üá∫üá∏';
  if (t.includes('china')) return 'üá®üá≥';
  if (t.includes('gene')||t.includes('crispr')) return 'üß¨';
  if (t.includes('energy')||t.includes('solar')) return '‚òÄÔ∏è';
  return 'üì∞';
}
function makeNewsItem(icon, title, sub, tag) {
  return `<div style="display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);align-items:flex-start">
    <div style="font-size:22px;flex-shrink:0;padding-top:2px">${icon}</div>
    <div style="flex:1">
      <div style="font-size:13px;font-weight:700;margin-bottom:3px;color:var(--text)">${title}</div>
      <div style="font-size:11px;color:var(--muted)">${sub}</div>
    </div>
    <div style="font-family:var(--ffm);font-size:9px;letter-spacing:0.1em;color:var(--muted);padding:2px 6px;background:var(--dim);border-radius:4px;flex-shrink:0">${tag}</div>
  </div>`;
}
function makeWhyCard(icon, title, sub, impact, body) {
  const cls = impact === 'BULLISH' ? 'imp-bull' : impact === 'BEARISH' ? 'imp-bear' : 'imp-neut';
  return `<div class="why-card" onclick="toggleWhy(this)">
    <div class="why-front">
      <div class="why-icon">${icon}</div>
      <div class="why-mid"><div class="why-title">${title}</div><div class="why-sub">${sub}</div></div>
      <div class="why-impact ${cls}">${impact}</div>
      <div class="why-chevron">‚ñæ</div>
    </div>
    <div class="why-body">${body}</div>
  </div>`;
}
function makeFT(period, price, sub, pct, up, reason, conf, now) {
  const chgColor = up === true ? 'var(--green)' : up === false ? 'var(--red)' : 'var(--muted)';
  return `<div class="ft-item">
    <div class="ft-dot${now ? ' now' : ''}"></div>
    <div class="ft-period">${period}</div>
    <div class="ft-price-row">
      <div class="ft-price">${price}</div>
      ${pct ? `<div class="ft-chg" style="color:${chgColor}">${up ? '‚ñ≤' : '‚ñº'} ${pct}</div>` : ''}
    </div>
    ${sub ? `<div style="font-family:var(--ffm);font-size:11px;color:var(--muted);margin-bottom:4px">${sub}</div>` : ''}
    <div class="ft-reason">${reason}</div>
    <div class="ft-conf-row">
      <div class="ft-cbar"><div class="ft-cfill" style="width:0%" data-w="${conf}"></div></div>
      <div class="ft-clabel">Confidence: ${conf}%</div>
    </div>
  </div>`;
}
function makeStockRow(sym, name, price, chg, up, badge, reason) {
  const bc = badge === 'BUY' ? 'background:rgba(0,230,118,0.08);color:var(--green);border:1px solid rgba(0,230,118,0.3)' : 'background:rgba(0,191,255,0.08);color:var(--blue);border:1px solid rgba(0,191,255,0.3)';
  return `<div style="display:flex;align-items:center;gap:10px;padding:11px 0;border-bottom:1px solid var(--border)">
    <div style="flex:1">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-family:var(--ffm);font-size:13px;font-weight:700;color:var(--blue)">${sym}</span>
        <span style="font-family:var(--ffm);font-size:9px;padding:2px 7px;border-radius:4px;${bc}">${badge}</span>
      </div>
      <div style="font-size:11px;color:var(--muted);margin-top:2px">${name} ¬∑ ${reason}</div>
    </div>
    <div style="text-align:right;flex-shrink:0">
      <div style="font-family:var(--ffm);font-size:13px;font-weight:700">${price}</div>
      <div style="font-family:var(--ffm);font-size:11px;color:${up ? 'var(--green)' : 'var(--red)'}">${up ? '‚ñ≤' : '‚ñº'} ${chg}</div>
    </div>
  </div>`;
}

// ‚îÄ‚îÄ LIVE TAB RENDERERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// [FIX 2 & 6] Gold/Silver: INR values ONLY; ‚Çπ/gram, ‚Çπ/10g, ‚Çπ/kg
// USD shown only as small reference note, never as primary price
async function renderGoldLive(container) {
  container.innerHTML = `
    <div class="card-label" style="color:var(--gold)">‚óÜ Indian Gold & Silver Prices ‚Äî ${today()}</div>
    <div class="price-row">
      <div class="price-card gold-c"><div id="dyn-gold-card">${skeleton(4)}</div></div>
      <div class="price-card silver-c"><div id="dyn-silver-card">${skeleton(4)}</div></div>
    </div>
    <div class="chart-wrap">
      <div class="chart-header">
        <div class="chart-title">Price Chart (INR)</div>
        <div class="range-btns">
          <button class="rb act" onclick="switchRange(this,'7d')">7D</button>
          <button class="rb" onclick="switchRange(this,'1m')">1M</button>
          <button class="rb" onclick="switchRange(this,'3m')">3M</button>
          <button class="rb" onclick="switchRange(this,'1y')">1Y</button>
        </div>
      </div>
      <canvas id="priceChart"></canvas>
      <div class="chart-legend">
        <div class="cl-item"><div class="cl-dot" style="background:var(--gold)"></div>Gold (‚Çπ/10g)</div>
        <div class="cl-item"><div class="cl-dot" style="background:var(--silver)"></div>Silver (‚Çπ/kg √∑ 10)</div>
      </div>
    </div>
    <div class="card" style="border-color:rgba(245,200,66,0.15)" id="dyn-metal-snapshot">
      <div class="card-accent" style="background:linear-gradient(90deg,var(--gold),var(--gold2))"></div>
      <div class="card-label" style="color:var(--gold)">‚óÜ Indian Market Snapshot</div>
      ${skeleton(3)}
    </div>`;
  setTimeout(drawChart, 100);

  // [FIX 2] Use dedicated Indian metal price function for cleaner INR-first display
  const m = await getIndianMetalPrices();

  // Store for forecast and chatbot
  window._liveGold = {
    goldUsd: m.goldUsd, silverUsd: m.silverUsd,
    goldPer10g: m.goldPer10g, goldPerGram: m.goldPerGram,
    silverPerKg: m.silverPerKg, silverPerGram: m.silverPer10g * 10,
    gsRatio: m.gsRatio, usdToInr: m.usdInr
  };

  const platPerGram    = Math.round(m.platinumUsd  * m.usdInr / 31.1035);
  const palladPerGram  = Math.round(m.palladiumUsd * m.usdInr / 31.1035);

  // [FIX 2] Gold card ‚Äî INR first, USD as small reference
  const gc = document.getElementById('dyn-gold-card');
  if (gc) gc.innerHTML = `
    <div class="pc-tag"><span class="pc-dot" style="background:var(--gold)"></span><span style="color:var(--gold)">GOLD 24K ¬∑ MCX</span></div>
    <div class="pc-price">‚Çπ${m.goldPer10g.toLocaleString('en-IN')}</div>
    <div class="pc-sub">per 10 grams ¬∑ ${today()}</div>
    <div style="font-family:var(--ffm);font-size:11px;color:var(--muted);margin-top:6px">‚Çπ${m.goldPerGram.toLocaleString('en-IN')}/gram</div>
    <div class="pc-change up" style="margin-top:6px;font-size:10px">Ref: $${m.goldUsd.toFixed(0)}/oz ¬∑ ‚Çπ${m.usdInr.toFixed(1)}/USD</div>`;

  // [FIX 2] Silver card ‚Äî INR first
  const sc = document.getElementById('dyn-silver-card');
  if (sc) sc.innerHTML = `
    <div class="pc-tag"><span class="pc-dot" style="background:var(--silver)"></span><span style="color:var(--silver)">SILVER ¬∑ MCX</span></div>
    <div class="pc-price">‚Çπ${m.silverPerKg.toLocaleString('en-IN')}</div>
    <div class="pc-sub">per kg ¬∑ ${today()}</div>
    <div style="font-family:var(--ffm);font-size:11px;color:var(--muted);margin-top:6px">‚Çπ${m.silverPer10g.toLocaleString('en-IN')} / 10g</div>
    <div class="pc-change up" style="margin-top:6px;font-size:10px">Ref: $${m.silverUsd.toFixed(2)}/oz ¬∑ Ratio: ${m.gsRatio}:1</div>`;

  // [FIX 2 & 6] Snapshot ‚Äî all INR
  const snap = document.getElementById('dyn-metal-snapshot');
  if (snap) snap.innerHTML = `
    <div class="card-accent" style="background:linear-gradient(90deg,var(--gold),var(--gold2))"></div>
    <div class="card-label" style="color:var(--gold)">‚óÜ Indian Market Snapshot</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;text-align:center">
      <div>
        <div style="font-family:var(--ffm);font-size:15px;font-weight:700;color:var(--gold)">‚Çπ${m.goldPer10g.toLocaleString('en-IN')}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px">Gold / 10g</div>
      </div>
      <div>
        <div style="font-family:var(--ffm);font-size:15px;font-weight:700;color:var(--silver)">${m.gsRatio}:1</div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px">Gold/Silver Ratio</div>
      </div>
      <div>
        <div style="font-family:var(--ffm);font-size:15px;font-weight:700;color:var(--green)">${m.trend}</div>
        <div style="font-size:10px;color:var(--muted);margin-top:3px">Trend Signal</div>
      </div>
    </div>
    <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div style="background:var(--dim);border-radius:8px;padding:8px;text-align:center">
        <div style="font-family:var(--ffm);font-size:12px;font-weight:700;color:var(--text)">‚Çπ${platPerGram.toLocaleString('en-IN')}/g</div>
        <div style="font-size:10px;color:var(--muted)">Platinum</div>
      </div>
      <div style="background:var(--dim);border-radius:8px;padding:8px;text-align:center">
        <div style="font-family:var(--ffm);font-size:12px;font-weight:700;color:var(--text)">‚Çπ${palladPerGram.toLocaleString('en-IN')}/g</div>
        <div style="font-size:10px;color:var(--muted)">Palladium</div>
      </div>
    </div>
    <div style="margin-top:10px;padding:8px 10px;background:rgba(245,200,66,0.05);border:1px solid rgba(245,200,66,0.1);border-radius:8px;font-size:10px;color:var(--muted);text-align:center">
      üìå MCX approx. ¬∑ Import duty ~15% + GST 3% extra on physical ¬∑ metals.live + ${m.usdInr.toFixed(1)} USD/INR rate
    </div>`;
}
async function renderIndiaLive(container) {
  container.innerHTML = `<div class="card-label" style="color:var(--orange)">‚óÜ India Today ‚Äî ${today()}</div>
    <div class="price-row">
      <div class="price-card" style="border-color:rgba(255,140,66,0.2)"><div id="dyn-sensex-card">${skeleton(4)}</div></div>
      <div class="price-card" style="border-color:rgba(255,140,66,0.2)"><div id="dyn-nifty-card">${skeleton(4)}</div></div>
    </div>
    <div class="card"><div class="card-label" style="color:var(--orange)">‚óÜ Top India Stories</div>
    <div id="dyn-india-news">${skeleton(5)}</div></div>`;
  // [FIX 4] allSettled ‚Äî one failure doesn't break the whole tab
  const [sensexR, niftyR, newsR] = await Promise.allSettled([getQuote('^BSESN'), getQuote('^NSEI'), getNews('india')]);
  const sensex = sensexR.status === 'fulfilled' ? sensexR.value : null;
  const nifty  = niftyR.status  === 'fulfilled' ? niftyR.value  : null;
  const indiaN = newsR.status   === 'fulfilled' ? newsR.value   : FALLBACK_NEWS.india;

  const sc = document.getElementById('dyn-sensex-card');
  if (sc) {
    if (sensex) sc.innerHTML = fmtQuote(sensex, 'SENSEX', 'BSE 30 ¬∑ Live (‚Çπ)', 'var(--orange)');
    else sc.innerHTML = `<div class="pc-tag" style="color:var(--orange)">SENSEX</div>
      <div class="pc-price" style="font-size:20px">~76,500</div><div class="pc-sub">Estimated ¬∑ BSE 30</div>
      <div style="font-size:10px;color:var(--muted);margin-top:6px">Live data temporarily unavailable</div>`;
  }
  const nc = document.getElementById('dyn-nifty-card');
  if (nc) {
    if (nifty) nc.innerHTML = fmtQuote(nifty, 'NIFTY 50', 'NSE ¬∑ Live (‚Çπ)', 'var(--orange)');
    else nc.innerHTML = `<div class="pc-tag" style="color:var(--orange)">NIFTY 50</div>
      <div class="pc-price" style="font-size:20px">~23,100</div><div class="pc-sub">Estimated ¬∑ NSE 50</div>
      <div style="font-size:10px;color:var(--muted);margin-top:6px">Live data temporarily unavailable</div>`;
  }
  const nn = document.getElementById('dyn-india-news');
  if (nn) nn.innerHTML = indiaN.map(n => makeNewsItem(newsEmoji(n.title, n.tag), n.title, n.desc || '', n.tag)).join('');
}
async function renderWorldLive(container) {
  // [FIX 4] Always render something ‚Äî fallback for every data point
  container.innerHTML = `<div class="card-label" style="color:var(--green)">‚óÜ World Today ‚Äî ${today()}</div>
    <div class="price-row">
      <div class="price-card" style="border-color:rgba(0,191,255,0.2)"><div id="dyn-usd-card">${skeleton(3)}</div></div>
      <div class="price-card" style="border-color:rgba(255,140,66,0.2)"><div id="dyn-crude-card">${skeleton(3)}</div></div>
    </div>
    <div class="card"><div class="card-label" style="color:var(--green)">‚óÜ World Headlines</div>
    <div id="dyn-world-news">${skeleton(4)}</div></div>`;

  // Fetch with individual try-catches so one failure doesn't block others
  const [dxyResult, crudeResult, usdInr, news] = await Promise.allSettled([
    getQuote('DX-Y.NYB'),
    getQuote('CL=F'),
    getUsdInr(),
    getNews('world'),
  ]);

  const dxy   = dxyResult.status   === 'fulfilled' ? dxyResult.value   : null;
  const crude = crudeResult.status === 'fulfilled' ? crudeResult.value : null;
  const inrRate = usdInr.status   === 'fulfilled' ? usdInr.value       : (cacheGet('dyn_usdinr') || 83.5);
  const worldNews = news.status === 'fulfilled' ? news.value : FALLBACK_NEWS.world;

  // [FIX 4 & 6] DXY card with fallback
  const dc = document.getElementById('dyn-usd-card');
  if (dc) {
    if (dxy) {
      dc.innerHTML = fmtQuote(dxy, 'DOLLAR INDEX (DXY)', 'USD strength vs 6 currencies', 'var(--blue)');
    } else {
      dc.innerHTML = `<div class="pc-tag" style="color:var(--blue)">DOLLAR INDEX (DXY)</div>
        <div class="pc-price" style="font-size:20px">~104.5</div>
        <div class="pc-sub">Estimated ¬∑ Live data loading</div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px">DXY down ‚Üí Gold up ¬∑ DXY up ‚Üí EM outflows</div>`;
    }
  }

  // [FIX 4 & 6] Crude oil with INR petrol estimate + fallback
  const cc = document.getElementById('dyn-crude-card');
  if (cc) {
    if (crude) {
      const crudeInrBbl = Math.round(crude.price * inrRate);
      const upDown = crude.chg >= 0;
      const sign = upDown ? '‚ñ≤ +' : '‚ñº ';
      cc.innerHTML = `<div class="pc-tag" style="color:var(--orange)">CRUDE OIL (WTI)</div>
        <div class="pc-price">$${crude.price.toFixed(1)}</div>
        <div class="pc-sub">per barrel ¬∑ NYMEX</div>
        <div class="pc-change ${upDown?'up':'dn'}">${sign}${Math.abs(crude.chg).toFixed(2)} (${crude.pct.toFixed(2)}%)</div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px">‚âà ‚Çπ${crudeInrBbl.toLocaleString('en-IN')}/bbl ¬∑ India imports 85%</div>`;
    } else {
      cc.innerHTML = `<div class="pc-tag" style="color:var(--orange)">CRUDE OIL (WTI)</div>
        <div class="pc-price" style="font-size:20px">~$82</div>
        <div class="pc-sub">Estimated ¬∑ ‚âà ‚Çπ6,800/bbl</div>
        <div style="font-size:10px;color:var(--muted);margin-top:6px">India imports 85% of crude ¬∑ Affects petrol prices</div>`;
    }
  }

  // [FIX 4] News ‚Äî always shows (fallback guaranteed)
  const wn = document.getElementById('dyn-world-news');
  if (wn) wn.innerHTML = worldNews.map(n => makeNewsItem(newsEmoji(n.title, n.tag), n.title, n.desc || '', n.tag)).join('');
}
async function renderTechLive(container) {
  container.innerHTML = `<div class="card-label" style="color:var(--xp2)">‚óÜ Tech Pulse ‚Äî ${today()}</div>
    <div class="price-row">
      <div class="price-card" style="border-color:rgba(168,85,247,0.2)"><div id="dyn-nvda-card">${skeleton(4)}</div></div>
      <div class="price-card" style="border-color:rgba(168,85,247,0.2)"><div id="dyn-tcs-card">${skeleton(4)}</div></div>
    </div>
    <div class="price-row">
      <div class="price-card" style="border-color:rgba(168,85,247,0.2)"><div id="dyn-infy-card">${skeleton(4)}</div></div>
      <div class="price-card" style="border-color:rgba(168,85,247,0.2)"><div id="dyn-msft-card">${skeleton(4)}</div></div>
    </div>
    <div class="card"><div class="card-label" style="color:var(--xp2)">‚óÜ Tech Headlines</div>
    <div id="dyn-tech-news">${skeleton(5)}</div></div>`;
  // [FIX 4] allSettled prevents one failing symbol breaking the whole tab
  const [nvdaR, tcsR, infyR, msftR, newsR] = await Promise.allSettled([
    getQuote('NVDA'), getQuote('TCS.NS'), getQuote('INFY.NS'), getQuote('MSFT'), getNews('tech')
  ]);
  const TECH_FALLBACKS = {
    'dyn-nvda-card': ['NVIDIA', 'AI Chip King ¬∑ NASDAQ ($)', 'var(--xp2)'],
    'dyn-tcs-card':  ['TCS', 'Tata Consultancy ¬∑ NSE (‚Çπ)', 'var(--xp2)'],
    'dyn-infy-card': ['INFOSYS', 'IT Services ¬∑ NSE (‚Çπ)', 'var(--xp2)'],
    'dyn-msft-card': ['MICROSOFT', 'Azure + AI ¬∑ NASDAQ ($)', 'var(--xp2)'],
  };
  const results = [nvdaR, tcsR, infyR, msftR];
  ['dyn-nvda-card','dyn-tcs-card','dyn-infy-card','dyn-msft-card'].forEach((id, i) => {
    const el = document.getElementById(id);
    if (!el) return;
    const q = results[i].status === 'fulfilled' ? results[i].value : null;
    const [label, sub, color] = TECH_FALLBACKS[id];
    if (q) {
      el.innerHTML = fmtQuote(q, label, sub, color);
    } else {
      el.innerHTML = `<div class="pc-tag" style="color:${color}">${label}</div>
        <div class="pc-sub" style="margin-top:8px">Loading... ¬∑ ${sub}</div>`;
    }
  });
  const tn = document.getElementById('dyn-tech-news');
  const techN = newsR.status === 'fulfilled' ? newsR.value : FALLBACK_NEWS.tech;
  if (tn) tn.innerHTML = techN.map(n => makeNewsItem(newsEmoji(n.title, n.tag), n.title, n.desc || '', n.tag)).join('');
}

async function renderMarketsLive(container) {
  container.innerHTML = `<div class="card-label" style="color:var(--blue)">‚óÜ Market Pulse ‚Äî ${today()}</div>
    <div class="price-row">
      <div class="price-card" style="border-color:rgba(0,191,255,0.2)"><div id="dyn-sensex2-card">${skeleton(4)}</div></div>
      <div class="price-card" style="border-color:rgba(0,191,255,0.2)"><div id="dyn-btc-card">${skeleton(4)}</div></div>
    </div>
    <div class="card"><div class="card-label" style="color:var(--blue)">‚óÜ Key Stocks</div>
    <div id="dyn-stocks-list">${skeleton(4)}</div></div>
    <div class="card"><div class="card-label" style="color:var(--blue)">‚óÜ Market Headlines</div>
    <div id="dyn-markets-news">${skeleton(4)}</div></div>`;
  const [sensexR, btcR, hdfcR, tatapowerR, newsR] = await Promise.allSettled([
    getQuote('^BSESN'), getQuote('BTC-USD'), getQuote('HDFCBANK.NS'), getQuote('TATAPOWER.NS'), getNews('markets')
  ]);
  const sensex = sensexR.status === 'fulfilled' ? sensexR.value : null;
  const btc    = btcR.status    === 'fulfilled' ? btcR.value    : null;
  const hdfc   = hdfcR.status   === 'fulfilled' ? hdfcR.value   : null;
  const tatapower = tatapowerR.status === 'fulfilled' ? tatapowerR.value : null;
  const marketsN  = newsR.status === 'fulfilled' ? newsR.value : FALLBACK_NEWS.markets;

  const sc = document.getElementById('dyn-sensex2-card');
  if (sc) {
    if (sensex) sc.innerHTML = fmtQuote(sensex, 'SENSEX', 'BSE 30 ¬∑ Live (‚Çπ)', 'var(--blue)');
    else sc.innerHTML = `<div class="pc-tag" style="color:var(--blue)">SENSEX</div><div class="pc-price" style="font-size:20px">~76,500</div><div class="pc-sub">BSE 30 ¬∑ Estimated</div>`;
  }
  const bc = document.getElementById('dyn-btc-card');
  if (bc) {
    if (btc) bc.innerHTML = fmtQuote(btc, 'BITCOIN', 'BTC/USD ¬∑ Crypto', 'var(--orange)');
    else bc.innerHTML = `<div class="pc-tag" style="color:var(--orange)">BITCOIN</div><div class="pc-price" style="font-size:20px">~$67K</div><div class="pc-sub">BTC/USD ¬∑ Estimated</div>`;
  }
  const stocks = [
    { q: hdfc,       sym: 'HDFC BANK', name: "India's largest private bank",  reason: 'Banking leader' },
    { q: tatapower,  sym: 'TATA PWR',  name: 'Tata Power ¬∑ Renewables',       reason: 'Clean energy play' },
  ].map(({ q, sym, name, reason }) => {
    if (!q) return `<div style="padding:11px 0;border-bottom:1px solid var(--border);font-size:12px;color:var(--muted)">${sym} ¬∑ ${reason} ¬∑ Loading...</div>`;
    const up = q.chg >= 0;
    return makeStockRow(sym, name, '‚Çπ' + Math.round(q.price).toLocaleString('en-IN'), `${up?'+':''}${q.pct.toFixed(2)}%`, up, up ? 'BUY' : 'HOLD', reason);
  }).join('');
  const sl = document.getElementById('dyn-stocks-list'); if (sl) sl.innerHTML = stocks;
  const mn = document.getElementById('dyn-markets-news');
  if (mn) mn.innerHTML = marketsN.map(n => makeNewsItem(newsEmoji(n.title, n.tag), n.title, n.desc || '', n.tag)).join('');
}
async function renderScienceLive(container) {
  container.innerHTML = `<div class="card-label" style="color:var(--red)">‚óÜ Science This Week ‚Äî ${today()}</div>
    <div class="price-row">
      <div class="price-card" style="border-color:rgba(255,69,96,0.2)"><div id="dyn-spce-card">${skeleton(3)}</div></div>
      <div class="price-card" style="border-color:rgba(255,69,96,0.2)"><div id="dyn-bio-card">${skeleton(3)}</div></div>
    </div>
    <div class="card"><div class="card-label" style="color:var(--red)">‚óÜ Science Headlines</div>
    <div id="dyn-science-news">${skeleton(5)}</div></div>`;
  const [spceR, mrnaR, newsR] = await Promise.allSettled([getQuote('SPCE'), getQuote('MRNA'), getNews('science')]);
  const spce    = spceR.status === 'fulfilled' ? spceR.value : null;
  const mrna    = mrnaR.status === 'fulfilled' ? mrnaR.value : null;
  const scienceN = newsR.status === 'fulfilled' ? newsR.value : FALLBACK_NEWS.science;
  const sc = document.getElementById('dyn-spce-card');
  if (sc) {
    if (spce) sc.innerHTML = fmtQuote(spce, 'SPACE SECTOR (SPCE)', 'Virgin Galactic ¬∑ NYSE', 'var(--red)');
    else sc.innerHTML = `<div class="pc-tag" style="color:var(--red)">SPACE SECTOR</div>
      <div class="pc-sub" style="margin-top:8px;line-height:1.6">Space stocks track ISRO milestones, Starship launches, and satellite industry growth worldwide.</div>`;
  }
  const bc = document.getElementById('dyn-bio-card');
  if (bc) {
    if (mrna) bc.innerHTML = fmtQuote(mrna, 'BIOTECH (MRNA)', 'Moderna ¬∑ NASDAQ', 'var(--red)');
    else bc.innerHTML = `<div class="pc-tag" style="color:var(--red)">BIOTECH</div>
      <div class="pc-sub" style="margin-top:8px;line-height:1.6">Biotech stocks reflect CRISPR therapy approvals, cancer drug pipelines, and gene editing milestones.</div>`;
  }
  const sn = document.getElementById('dyn-science-news');
  if (sn) sn.innerHTML = scienceN.map(n => makeNewsItem(newsEmoji(n.title, n.tag), n.title, n.desc || '', n.tag)).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ARENA DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ARENAS = {
  gold: {
    name: 'ü•á Gold & Silver', sub: 'Precious Metals Intelligence', color: '#f5c842',
    live: (c) => renderGoldLive(c),
    why: () => `<div class="card-label" style="color:var(--gold)">‚óÜ Why did Gold & Silver move today?</div>
      ${makeWhyCard('üè¶','Fed Rate Cut Signals','US Dollar Weakens','BULLISH',`<span class="tag" style="background:rgba(0,230,118,0.1);color:var(--green)">KEY DRIVER</span>
        The US Federal Reserve signalled rate cuts. When US rates fall, the <span class="keyword" data-word="DXY" onclick="showGlossary('DXY')">DXY</span> weakens. Since gold is priced in dollars globally, a <strong>weaker dollar = gold gets cheaper for non-US buyers = more demand = higher price</strong>.`)}
      ${makeWhyCard('‚ö†Ô∏è','Geopolitical Tension','Middle East & Russia-Ukraine conflict','BULLISH',`Gold is a <strong>"<span class="keyword" data-word="safe haven" onclick="showGlossary('safe haven')">safe haven asset</span>"</strong> ‚Äî when the world feels uncertain, people move money FROM risky assets INTO gold.<br><br>Historically, every major conflict since 1970 pushed gold up 10‚Äì30% within 3 months.`)}
      ${makeWhyCard('üá®üá≥','China & India Buying','Central Banks accumulate gold reserves','BULLISH',`In 2024, China\'s central bank bought 735 tonnes of gold. India\'s RBI also added 65 tonnes. Central banks buy gold to reduce dependence on the USD ‚Äî called "<span class="keyword" data-word="de-dollarization" onclick="showGlossary('de-dollarization')">de-dollarization</span>".`)}
      ${makeWhyCard('üè≠','Industrial Demand for Silver','EVs & Solar panels need silver','BULLISH',`Silver isn't just jewellery ‚Äî it's a <strong>critical industrial metal</strong>. Every solar panel needs silver paste. Every EV has silver contacts.<br><br>India's target: 500GW solar by 2030. Each GW uses ~30 tonnes of silver.`)}
      ${makeWhyCard('üí∞','Dollar Index (DXY)','DXY and Gold move inversely','BULLISH',`The <span class="keyword" data-word="DXY" onclick="showGlossary('DXY')">DXY</span> measures USD strength. Rule of thumb: DXY up ‚Üí Gold down. DXY down ‚Üí Gold up. They move in almost perfect opposition ~80% of the time.`)}`,
    forecast: () => `<div class="card-label" style="color:var(--xp2)">‚óÜ Price Forecast ‚Äî Analyst Consensus</div>
      <div class="card" style="border-color:rgba(168,85,247,0.2);margin-bottom:20px">
        <div style="background:rgba(124,58,237,0.06);border:1px solid rgba(124,58,237,0.12);border-radius:10px;padding:12px;font-size:12px;color:#6070a0;margin-bottom:16px">‚ö†Ô∏è <strong style="color:var(--text)">Disclaimer:</strong> Forecasts are analyst consensus & macro models. Not financial advice.</div>
        <div class="ft-wrap"><div class="ft-line-vert"></div>
        ${makeFT('NOW (Today)', window._liveGold ? '‚Çπ'+window._liveGold.goldPer10g.toLocaleString('en-IN') : 'See Live tab', window._liveGold ? '$'+window._liveGold.goldUsd.toFixed(2)+'/oz' : '', '','','Current price. Check the Live tab for real-time data.',95,true)}
        ${makeFT('1 MONTH','Target: +2‚Äì4%','Analyst consensus','',true,'Fed rate cut expectations building. Dollar weakening trend continues. Watch DXY closely.',78,false)}
        ${makeFT('3 MONTHS','Target: +5‚Äì10%','Seasonal buying in India','',true,'Monsoon season typically raises Indian gold buying. Uncertainty historically spikes gold.',72,false)}
        ${makeFT('6 MONTHS','Target: +10‚Äì18%','Bull cycle mid-phase','',true,'Fed rate cuts likely begin Q3. Geopolitical tensions unpredictable. Solar/EV industrial silver demand accelerating.',65,false)}
        ${makeFT('1 YEAR','Target: +18‚Äì30%','Long-term bull case','',true,'Continued de-dollarization, central bank buying, inflation hedge demand.',58,false)}
        </div></div>`,
    questions: [
      {q:"Gold is priced in US Dollars globally. Today the US Dollar got WEAKER. What happens to gold's price?",ctx:"üí° Gold is bought and sold globally in USD. When the dollar weakens, foreign currencies can buy more dollars ‚Äî and therefore more gold ‚Äî with the same amount of local money.",opts:["Gold price stays the same","Gold price DROPS because dollar weakened","Gold price RISES because a weaker dollar = more demand from non-US buyers","Impossible to predict"],ans:2,xp:50,explain:"‚úÖ A weaker dollar makes gold cheaper for buyers in India, Europe, China etc. They buy more ‚Üí higher demand ‚Üí price rises. This is why Gold and the Dollar Index (DXY) almost always move in OPPOSITE directions."},
      {q:"If you had ‚Çπ1 lakh in 1990, and kept it as cash vs buying gold ‚Äî what's the difference today?",ctx:"üí° India's inflation since 1990 has eroded purchasing power significantly. Meanwhile gold has risen ~20x in nominal terms.",opts:["Cash: ‚Çπ1L ‚Üí still ‚Çπ1L | Gold: ‚Çπ1L ‚Üí ‚Çπ8L","Cash: ‚Çπ1L ‚Üí ‚Çπ3L | Gold: ‚Çπ1L ‚Üí ‚Çπ15L","Cash: ‚Çπ1L ‚Üí ‚Çπ4,200 real value | Gold: ‚Çπ1L ‚Üí ‚Çπ40L+","They would be equal due to bank interest"],ans:2,xp:60,explain:"‚úÖ Inflation destroyed the purchasing power of cash. Gold bought in 1990 at ~‚Çπ3,200/10g has grown ~20x in nominal terms, far outpacing inflation."},
      {q:"Silver's price has been rising because of ONE big trend in technology. Which one?",ctx:"üí° Silver is a critical industrial metal used in electronics, solar panels, and electric vehicles ‚Äî all growing sectors.",opts:["Smartphones (silver in circuit boards)","Solar panels & electric vehicles (silver paste & contacts)","Satellites (silver wiring in space)","AI servers (silver cooling systems)"],ans:1,xp:50,explain:"‚úÖ Every solar panel uses silver paste for conductivity. Every EV uses silver in battery contacts and circuits. India's 500GW solar target = ~15,000 tonnes of silver demand by 2030."},
      {q:"Gold is called a 'Safe Haven'. If there's a major geopolitical crisis tomorrow, what should you EXPECT?",ctx:"üí° Safe haven assets are things investors run TO when scared ‚Äî they hold value or rise when everything else falls.",opts:["Gold drops ‚Äî people sell everything in panic","Gold stays flat ‚Äî wars don't affect commodities","Gold RISES ‚Äî fear increases demand for safe haven assets","Gold is banned during crises"],ans:2,xp:50,explain:"‚úÖ Every major conflict since 1970 pushed gold up. The 2022 Russia-Ukraine war: gold jumped 8% in 2 weeks. When uncertainty rises, gold shines."},
      {q:"The Gold-Silver ratio is historically 60:1 on average. When it's at 89:1, what does this signal?",ctx:"üí° The Gold-Silver ratio tells you how many ounces of silver it takes to buy 1 ounce of gold. High ratio = silver is relatively cheap.",opts:["Gold is too cheap ‚Äî sell silver, buy gold","Silver is relatively cheap ‚Äî it may outperform gold going forward","The ratio means gold will fall 89% soon","Both metals will rise equally"],ans:1,xp:70,explain:"‚úÖ When the ratio is high vs historical 60:1, silver is relatively undervalued. In past cycles, silver rises FASTER than gold when the ratio reverts. This is the 'silver catch-up trade'."},
    ],
    dragGame: {prompt:"Match each economic concept with its correct description",pairs:[{left:"DXY rises",right:"Gold price falls"},{left:"Fed cuts rates",right:"Dollar weakens"},{left:"Geopolitical crisis",right:"Gold demand spikes"},{left:"Solar demand rises",right:"Silver becomes scarce"}]},
    learn: [
      {icon:'üè¶',title:'Why Central Banks Buy Gold',sub:'The secret war against the US Dollar',badge:'Beginner',body:`<h3>The Big Picture</h3>Since 1971, the US dollar has been the world's "reserve currency" ‚Äî all global trade is priced in USD. This gives America enormous power.<br><br><strong>Countries are quietly fighting back</strong> by buying gold instead of holding US dollars as reserves.<h3>Who's buying?</h3>In 2024: China: 735 tonnes ¬∑ India (RBI): 65 tonnes ¬∑ Poland: 90 tonnes ¬∑ Turkey: 75 tonnes<br><br>This is called <strong>"<span class='keyword' data-word='de-dollarization' onclick='showGlossary(\"de-dollarization\")'>de-dollarization</span>"</strong> ‚Äî reducing dependence on the US.<h3>Why does this push gold UP?</h3>When central banks buy hundreds of tonnes, they remove supply from the market. Less supply + same demand = higher price.<div class="example-box">üáÆüá≥ <strong>India angle:</strong> RBI now holds 800+ tonnes of gold. They recently brought 100 tonnes back from Bank of England storage to India.</div>`},
      {icon:'‚ö°',title:'Gold vs Inflation',sub:'The ultimate rupee destroyer explained',badge:'Beginner',body:`<h3>What is Inflation Really?</h3>Every year, the government prints more money. More money chasing the same goods = prices rise. This is <span class='keyword' data-word='inflation' onclick='showGlossary("inflation")'>inflation</span>.<h3>The Rule</h3>Gold doesn't "earn" money like a business. But it holds REAL value over time. It's insurance against currency destruction.<div class="example-box">üí° <strong>Practical tip:</strong> Keep 10-15% of your wealth in gold (ideally Sovereign Gold Bonds for 2.5% interest bonus). Use it as your financial foundation, not your growth engine.</div>`},
      {icon:'‚òÄÔ∏è',title:'Silver & The Green Revolution',sub:'How solar panels & EVs are making silver scarce',badge:'Intermediate',body:`<h3>Silver is More Than Jewellery</h3>About 50% of all silver demand is now industrial:<br>‚Ä¢ <strong>Solar panels:</strong> Each panel uses ~20g of silver paste<br>‚Ä¢ <strong>Electric vehicles:</strong> Each EV uses 25-50g of silver<br>‚Ä¢ <strong>Electronics:</strong> Every smartphone has ~0.3g of silver.<div class="example-box">üìà <strong>Investment angle:</strong> Silver ETFs (like SilverBees on NSE) give pure silver exposure. In bull markets, silver often rises 2-3x more than gold due to its smaller market size.</div>`},
    ],
    traineeModules: [
      {title:"What is Gold?",sub:"Physical properties, history, and cultural significance",xp:30},
      {title:"Gold Pricing Mechanics",sub:"How MCX, spot price, and making charges work",xp:40},
      {title:"Gold vs Other Assets",sub:"Comparing returns: FD, equity, real estate, gold",xp:50},
      {title:"Silver Deep Dive",sub:"Industrial uses, supply constraints, price drivers",xp:40},
      {title:"How to Buy Gold",sub:"SGBs, ETFs, digital gold, physical ‚Äî pros/cons",xp:60},
    ]
  },
  india: {
    name:'üáÆüá≥ India Arena', sub:'Economy ¬∑ Politics ¬∑ Culture ¬∑ Markets', color:'#ff8c42',
    live: (c) => renderIndiaLive(c),
    why:()=>`<div class="card-label" style="color:var(--orange)">‚óÜ Why India's economy is growing</div>
      ${makeWhyCard('üè≠','Manufacturing Boom (PLI Scheme)','‚Çπ2L Cr incentives boosting production','BULLISH','India\'s <strong>Production-Linked Incentive</strong> scheme gives cash back to companies that manufacture in India. Apple now makes 14% of iPhones here. Dixon makes Samsung TVs.<br><br>This created 1.8 million new factory jobs in 2024 alone. More jobs ‚Üí more spending ‚Üí economy grows.')}
      ${makeWhyCard('üë•','Demographic Dividend','65% of India is under 35','BULLISH','India adds <strong>~1 million new workers to the labour force every month</strong>. Compare: Japan is aging and shrinking. China\'s workforce peaked.<br><br>Young workers = producers AND consumers. This demographic tailwind will power India\'s growth for 20+ years.')}
      ${makeWhyCard('üíª','IT Services Boom','AI is creating more work, not less','BULLISH','Every global company upgrading to AI needs Indian engineers to implement it. Infosys, TCS, Wipro are winning massive AI transformation contracts.<br><br>Indian IT export revenue: <strong>$250B in FY24</strong> ‚Äî up 11% YoY.')}`,
    forecast:()=>`<div class="card-label" style="color:var(--xp2)">‚óÜ India Economic Outlook</div>
      <div class="card"><div class="ft-wrap"><div class="ft-line-vert"></div>
      ${makeFT('2025','GDP: 7.8‚Äì8.5%','Sensex target: 82,000+','',true,'IMF projects India as fastest G20 economy. RBI likely to cut rates once in H2 ‚Äî boosting markets.',80,true)}
      ${makeFT('2026‚Äì27','GDP: 8‚Äì9%','‚Çπ100L Cr economy','',true,'India\'s middle class expanding by 40M people/year. Infrastructure spending highest ever.',70,false)}
      ${makeFT('2030','$5 Trillion Economy','3rd largest globally','',true,'Target: Overtake Japan and Germany. Manufacturing + services + digital = diversified growth engine.',60,false)}
      </div></div>`,
    questions:[
      {q:"India's GDP consistently grows above 7%. What does GDP actually measure?",ctx:"üí° GDP = Gross Domestic Product. It measures the total value of everything produced in a country in a year.",opts:["How much gold a country has","Total value of all goods & services produced","How happy citizens are","Government tax collection"],ans:1,xp:40,explain:"‚úÖ GDP measures the total economic output. Think of India as a factory ‚Äî GDP is the total value of everything that factory produced in a year."},
      {q:"When RBI CUTS the repo rate, what happens to HOME LOAN EMIs?",ctx:"üí° Repo rate = the rate RBI charges banks for borrowing money. Banks use this as a baseline for all loans they give.",opts:["Home loan rates go UP","Home loan rates stay the same","Home loan rates go DOWN ‚Äî banks borrow cheaper, pass savings on","Home loans get banned temporarily"],ans:2,xp:50,explain:"‚úÖ When RBI cuts the repo rate, banks can borrow from RBI more cheaply. They pass savings to customers. Your EMI on a ‚Çπ50L home loan could drop by ‚Çπ2,000‚Äì3,000/month after a 0.5% rate cut."},
      {q:"India's 'demographic dividend' refers to what economic advantage?",ctx:"üí° Demographics = population structure. A country's age profile hugely affects its economic growth potential.",opts:["India has the most gold reserves","65% of India's population is under 35 ‚Äî large working-age population","India has the cheapest labour globally","India exports the most IT services"],ans:1,xp:50,explain:"‚úÖ A young, large working-age population = more producers AND more consumers. More workers produce goods and services ‚Üí more people earn money ‚Üí more people spend ‚Üí economy grows. This will power India for 20+ more years."},
    ],
    dragGame: {prompt:"Match India economic concepts with their definitions",pairs:[{left:"GDP growth",right:"Economic output speed"},{left:"Repo rate cut",right:"EMIs become cheaper"},{left:"FII inflow",right:"Sensex rises"},{left:"PLI scheme",right:"Manufacturing boost"}]},
    learn:[
      {icon:'üè¶',title:'How RBI Controls Your Money',sub:'The most powerful institution in India',badge:'Beginner',body:`<h3>What is RBI?</h3>The Reserve Bank of India is India's central bank. It controls the money supply, sets interest rates, and regulates all banks.<h3>The Repo Rate ‚Äî India's Lever</h3>The <span class='keyword' data-word='repo rate' onclick='showGlossary("repo rate")'>repo rate</span> is RBI's main tool. When they raise it, borrowing gets expensive ‚Äî economy cools (fights inflation). When they cut it, borrowing gets cheap ‚Äî economy heats up.<div class="example-box">üè† <strong>Your life example:</strong> RBI cuts rate 0.5% ‚Üí your bank's rate drops ‚Üí on a ‚Çπ50L loan, you save ‚Çπ2,500/month ‚Üí ‚Çπ30,000/year ‚Üí ‚Çπ5L over a 15-year loan. That's real money from one RBI meeting.</div>`},
      {icon:'üìä',title:"India's GDP Story",sub:'How India became the fastest growing large economy',badge:'Beginner',body:`<h3>The Numbers</h3><span class='keyword' data-word='GDP' onclick='showGlossary("GDP")'>GDP</span> growth rate: 8.4% in FY24 ‚Äî highest among G20 nations. China: 5.2%. USA: 2.5%. Eurozone: 0.4%.<h3>Key Drivers</h3>‚Ä¢ Manufacturing (PLI scheme attracting Apple, Samsung)<br>‚Ä¢ Services (IT exports: $250B/year)<br>‚Ä¢ Digital economy (UPI: $2T annual transactions)<br>‚Ä¢ Infrastructure (record govt capex)<div class="example-box">üí° <strong>Why it matters to you:</strong> Faster GDP = more jobs = higher salaries = Sensex rises. Invest in India's growth via Nifty 50 index funds.</div>`},
    ],
    traineeModules:[
      {title:"Understanding GDP",sub:"What it is, how it's measured, why it matters",xp:30},
      {title:"How RBI Works",sub:"Monetary policy, repo rate, inflation targeting",xp:40},
      {title:"India's Budget",sub:"Union Budget, fiscal deficit, government spending",xp:50},
      {title:"FII & DII Flows",sub:"How foreign and domestic money moves markets",xp:40},
      {title:"India's Growth Sectors",sub:"IT, manufacturing, renewable energy, fintech",xp:60},
    ]
  },
  world:{
    name:'üåê World Arena', sub:'Geopolitics ¬∑ Global Events ¬∑ Nations', color:'#00e676',
    live: (c) => renderWorldLive(c),
    why:()=>`<div class="card-label" style="color:var(--green)">‚óÜ Why the world moved today</div>
    ${makeWhyCard('üè¶','Fed Rate Decisions','US rates drive global capital flows','BULLISH','When the US Fed cuts rates, global capital flows OUT of US treasuries and INTO emerging markets like India. More foreign money coming into India = rupee strengthens, stock market rises.')}
    ${makeWhyCard('ü§ñ','China AI Competition','DeepSeek challenges US AI dominance','NEUTRAL','China\'s AI models like DeepSeek proved frontier AI is achievable at low cost. Bearish for expensive US AI models but bullish for adoption ‚Äî cheaper AI = everyone uses it.')}
    ${makeWhyCard('‚öñÔ∏è','Global Regulation Wave','AI, data privacy, trade ‚Äî new rules reshaping economies','NEUTRAL','From EU AI Act to India\'s data protection law, governments worldwide are setting rules for the digital economy. Companies that comply early win long-term.')}`,
    forecast:()=>`<div class="card-label" style="color:var(--xp2)">‚óÜ Global Outlook 2025</div>
    <div class="card"><div class="ft-wrap"><div class="ft-line-vert"></div>
    ${makeFT('Q2 2025','Fed first rate cut expected','Dollar weakens 3-5%','',true,'Emerging markets rally. India, Brazil, Indonesia benefit most. Gold, oil could spike.',75,true)}
    ${makeFT('Q3 2025','US market volatility likely','Election uncertainty','',false,'Markets typically more volatile in political uncertainty periods. Gold rises as safe haven.',65,false)}
    ${makeFT('2026','AI regulation goes global','EU rules adopted widely','',true,'Most countries adopt AI regulations. Companies that comply early win.',60,false)}
    </div></div>`,
    questions:[
      {q:"When the US Fed raises interest rates, what typically happens to the Indian stock market?",ctx:"üí° Global capital is mobile ‚Äî investors move money to wherever returns are highest.",opts:["Sensex goes UP ‚Äî more money flows to India","Sensex is unaffected ‚Äî India is independent","Sensex tends to go DOWN ‚Äî global money flows back to US","Sensex doubles automatically"],ans:2,xp:50,explain:"‚úÖ When US rates rise, US bonds become attractive. Foreign investors pull money OUT of 'risky' emerging markets like India and park it in US bonds. Less FII money in India = Sensex drops."},
      {q:"Oil prices spike 30% due to a Middle East conflict. What happens to India's economy?",ctx:"üí° India imports ~85% of its crude oil requirements. Oil is priced in US dollars globally.",opts:["Nothing ‚Äî India has enough domestic oil","Petrol prices rise ‚Üí inflation rises ‚Üí RBI may raise rates","Indian stock market automatically hedges against oil","Only Saudi Arabia is affected"],ans:1,xp:60,explain:"‚úÖ India's oil import bill rises ‚Üí petrol prices go up ‚Üí transport costs rise ‚Üí all goods cost more ‚Üí inflation rises ‚Üí RBI may raise rates ‚Üí markets react negatively. Everything in India is connected to oil prices."},
    ],
    dragGame: {prompt:"Match global economic triggers with their effects on India",pairs:[{left:"US Fed rate hike",right:"FII money leaves India"},{left:"Oil price spike",right:"Indian inflation rises"},{left:"China GDP slows",right:"Commodity demand falls"},{left:"USD strengthens",right:"Rupee weakens"}]},
    learn:[
      {icon:'üåç',title:'How Global Events Affect Your Money',sub:'Everything is connected',badge:'Beginner',body:`<h3>The Butterfly Effect of Finance</h3>A war in the Middle East can raise your petrol price in Hyderabad within a week:<br><br>Conflict ‚Üí oil supply disruption ‚Üí global <span class='keyword' data-word='crude oil' onclick='showGlossary("crude oil")'>crude oil</span> price rises ‚Üí India imports 85% of oil ‚Üí petrol price rises ‚Üí transport costs rise ‚Üí all goods cost more ‚Üí <span class='keyword' data-word='inflation' onclick='showGlossary("inflation")'>inflation</span> rises ‚Üí RBI raises rates ‚Üí your EMI goes up.<div class="example-box">üí° <strong>Simple habit:</strong> Every time something big happens globally, ask: "Does this affect oil? The dollar? US interest rates?" If yes to any ‚Üí India is affected.</div>`},
    ],
    traineeModules:[
      {title:"The Global Economy",sub:"How countries are interconnected via trade and finance",xp:30},
      {title:"US Federal Reserve",sub:"How Fed decisions ripple across global markets",xp:40},
      {title:"China's Economy",sub:"Manufacturing powerhouse, its slowdown and impact",xp:50},
      {title:"Geopolitics & Markets",sub:"Wars, elections, and sanctions ‚Äî market impact",xp:40},
    ]
  },
  tech:{
    name:'‚ö° Tech & AI Arena', sub:'AI ¬∑ Startups ¬∑ Chips ¬∑ Future', color:'#a855f7',
    live: (c) => renderTechLive(c),
    why:()=>`<div class="card-label" style="color:var(--xp2)">‚óÜ Why Tech moved today</div>
    ${makeWhyCard('üß†','AI Spending Boom','Every company buying AI infrastructure','BULLISH','Microsoft, Google, Amazon, Meta are spending $200B+ combined on AI infrastructure in 2025. This drives demand for NVIDIA chips, data centers, and cloud services. Indian IT companies win implementation contracts.')}
    ${makeWhyCard('üá®üá≥','China AI Competition','DeepSeek at 1/10th the cost','NEUTRAL','DeepSeek proved frontier AI is achievable at low cost. Bearish for expensive US AI models but bullish for adoption ‚Äî cheaper AI = everyone uses it = more demand for Indian engineers.')}
    ${makeWhyCard('‚ö°','Chip Cycle Intensifies','Next-gen chip production confirmed','BULLISH','2nm chips are 30% faster and 25% more power efficient. India is in talks with TSMC for a chip fab. If successful, India could become a chip manufacturing nation.')}`,
    forecast:()=>`<div class="card-label" style="color:var(--xp2)">‚óÜ Tech Outlook</div>
    <div class="card"><div class="ft-wrap"><div class="ft-line-vert"></div>
    ${makeFT('2025','AI becomes mainstream','100M+ new AI users in India','',true,'Jio AI, Sarvam, Krutrim reach mass adoption. Indian AI startups raise $5B+. IT sector revenue +15%.',80,true)}
    ${makeFT('2026','Humanoid robots enter factories','Physical AI goes commercial','',true,'Figure, Tesla Optimus in 1000+ factories. Indian IT companies managing robot fleets.',65,false)}
    ${makeFT('2030','AGI possible','AI surpasses human performance broadly','',true,'Most cognitive work AI-assisted. India positioned well ‚Äî large young population adapting fastest.',45,false)}
    </div></div>`,
    questions:[
      {q:"NVIDIA's stock rises when AI spending booms. Which Indian sector benefits MOST directly?",ctx:"üí° Think about what Indian companies do for global tech giants ‚Äî implementation, maintenance, and consulting.",opts:["Indian real estate (data centers need land)","Indian IT services ‚Äî Infosys, TCS, Wipro get AI contracts","Indian retail ‚Äî people buy more electronics","Indian agriculture ‚Äî AI used in farming"],ans:1,xp:50,explain:"‚úÖ Indian IT companies are the world's AI implementation army. Every Fortune 500 company upgrading to AI needs Indian engineers to integrate, customize, and maintain these systems."},
      {q:"What is the most likely impact of AI on Indian IT job market?",ctx:"üí° AI both threatens and creates jobs. The net effect depends on how quickly new opportunities emerge.",opts:["Complete job elimination in 5 years","Short-term disruption but long-term 10x productivity gains and new jobs","No impact ‚Äî India's IT is immune","All jobs move to US immediately"],ans:1,xp:60,explain:"‚úÖ AI makes each Indian IT engineer ~10x more productive, allowing them to handle more complex projects. India's IT exports could hit $500B by 2030 (vs $250B today) because of the AI multiplier effect."},
    ],
    dragGame: {prompt:"Match tech concepts with their real-world effects",pairs:[{left:"NVIDIA GPU demand up",right:"AI infrastructure grows"},{left:"India chip fab built",right:"Electronics self-reliance"},{left:"AI productivity gains",right:"IT exports double"},{left:"DeepSeek released",right:"AI cost drops 90%"}]},
    learn:[
      {icon:'ü§ñ',title:'AI Explained Simply',sub:'What it actually is and why it matters to you',badge:'Beginner',body:`<h3>What IS Artificial Intelligence?</h3>AI is software that learns from examples instead of following fixed rules. Traditional software: "If X, do Y." AI: "Here are 1 million examples ‚Äî figure out the pattern yourself."<h3>How It Affects You Financially</h3>Companies using AI grow faster and cut costs ‚Üí their stocks rise ‚Üí if you hold their stocks or funds containing them, your wealth grows.<div class="example-box">üíº <strong>Indian opportunity:</strong> India has 5 million+ software engineers. AI makes each one 10x more productive. India's IT exports could hit $500B by 2030 because of AI multiplier effect.</div>`},
    ],
    traineeModules:[
      {title:"What is AI?",sub:"Machine learning, deep learning, LLMs explained simply",xp:30},
      {title:"AI in India",sub:"Sarvam, Krutrim, Jio AI ‚Äî the Indian AI ecosystem",xp:40},
      {title:"Chips & Semiconductors",sub:"Why NVIDIA matters, TSMC, India chip ambitions",xp:50},
      {title:"AI Investment Plays",sub:"How to invest in the AI theme from India",xp:60},
    ]
  },
  markets:{
    name:'üìà Markets Arena', sub:'Stocks ¬∑ Crypto ¬∑ Indices ¬∑ Investing', color:'#00bfff',
    live: (c) => renderMarketsLive(c),
    why:()=>`<div class="card-label" style="color:var(--blue)">‚óÜ Why markets moved today</div>
    ${makeWhyCard('üåç','FII Flows Drive Sensex','Foreign money = market direction','BULLISH','Foreign Institutional Investors are the biggest short-term driver of Indian markets. When FII flows are positive, Sensex rises. When they sell, it falls. Watch FII data daily at NSE website.')}
    ${makeWhyCard('üí∞','US Fed Rate Signals','Dollar impacts global flows','BULLISH','Fed rate cuts make US bonds less attractive. Money rotates into emerging markets. India is typically the top destination ‚Äî strong GDP, political stability.')}
    ${makeWhyCard('üìä','Corporate Earnings Season','Quarterly results drive stocks','BULLISH','When Indian companies report strong quarterly earnings, their stocks go up. When 70%+ of Nifty 50 beats estimates, entire index rises. Track earnings season (Apr, Jul, Oct, Jan) closely.')}`,
    forecast:()=>`<div class="card-label" style="color:var(--xp2)">‚óÜ Market Targets 2025</div>
    <div class="card"><div class="ft-wrap"><div class="ft-line-vert"></div>
    ${makeFT('Q1 2025','Sensex: 74,000‚Äì78,000','Nifty: 22,500‚Äì23,500','',true,'Q4 earnings season begins. RBI rate cut expectations building.',75,true)}
    ${makeFT('Q2‚ÄìQ3 2025','Sensex: 78,000‚Äì84,000','Nifty: 23,500‚Äì25,500','',true,'Fed cuts rates ‚Äî FII inflows surge. Monsoon forecast critical for rural stocks.',68,false)}
    ${makeFT('End 2025','Sensex: 82,000‚Äì92,000','Nifty: 25,000‚Äì28,000','',true,'Full year: +15% to +25% return expected. Best sectors: IT, Banking, Renewable Energy, Defence.',60,false)}
    </div></div>`,
    questions:[
      {q:"You invest ‚Çπ5,000/month in a Nifty 50 index fund for 15 years at 13% average annual return. Roughly how much will you have?",ctx:"üí° This tests your understanding of SIP (Systematic Investment Plan) and compound interest ‚Äî the most powerful concept in personal finance.",opts:["‚Çπ9 lakhs (just what you put in)","‚Çπ22 lakhs (slightly more than invested)","‚Çπ1.2 crores (power of compounding)","‚Çπ5 crores (unrealistic)"],ans:2,xp:60,explain:"‚úÖ At 13% annualized returns (Nifty 50's historical average), ‚Çπ5,000/month for 15 years ‚Üí ~‚Çπ1.2 crore. You invested only ‚Çπ9 lakh. The other ‚Çπ1.1 crore is PURE compounding. Start TODAY."},
      {q:"FII data shows ‚Çπ5,000 Crore of selling in Indian markets today. What should you expect?",ctx:"üí° FIIs (Foreign Institutional Investors) are the dominant force in Indian market short-term direction.",opts:["Sensex will likely rise ‚Äî FIIs are wrong","Sensex will likely fall ‚Äî large selling pressure","Market is unaffected ‚Äî only retail investors matter","Rupee will strengthen against dollar"],ans:1,xp:50,explain:"‚úÖ Large FII selling creates supply in the market. More shares being sold ‚Üí prices drop. FII selling is often the primary cause of 1-3% market falls on a given day."},
    ],
    dragGame: {prompt:"Match market concepts to their outcomes",pairs:[{left:"FII buying",right:"Sensex rises"},{left:"RBI rate cut",right:"Banking stocks rally"},{left:"High inflation",right:"RBI raises rates"},{left:"Strong earnings",right:"Stock price rises"}]},
    learn:[
      {icon:'üìà',title:'SIP: The Most Powerful Habit in Finance',sub:'How ‚Çπ5,000/month becomes ‚Çπ1 crore',badge:'Beginner',body:`<h3>What is a <span class='keyword' data-word='SIP' onclick='showGlossary("SIP")'>SIP</span>?</h3>SIP (Systematic Investment Plan) means automatically investing a fixed amount every month into a mutual fund ‚Äî regardless of whether markets are up or down. Set it, forget it, get rich slowly.<h3>The Numbers</h3>‚Çπ5,000/month √ó 15 years √ó 13% = ‚Çπ1.2 crore<br>‚Çπ5,000/month √ó 20 years √ó 13% = ‚Çπ2.6 crore<br>‚Çπ5,000/month √ó 30 years √ó 13% = ‚Çπ9.4 crore<div class="example-box">üöÄ <strong>Start in 5 minutes:</strong> Open Groww or Zerodha ‚Üí search "Nifty 50 Index Fund" ‚Üí set up ‚Çπ500/month SIP. Increase by 10% every year as your income grows.</div>`},
      {icon:'üß†',title:'Understanding Compounding',sub:"Einstein's 8th wonder of the world",badge:'Beginner',body:`<h3>What is <span class='keyword' data-word='compounding' onclick='showGlossary("compounding")'>Compounding</span>?</h3>It's earning returns on your returns. Year 1: invest ‚Çπ1L, earn 12% = ‚Çπ12,000. Year 2: you earn 12% on ‚Çπ1,12,000 = ‚Çπ13,440. The gains keep growing.<h3>The 72 Rule</h3>Divide 72 by your annual return rate to know how many years to double your money.<br>72 √∑ 12% = 6 years to double. 72 √∑ 6% = 12 years to double.<div class="example-box">üí° <strong>Start earlier principle:</strong> ‚Çπ1L invested at 22 = ‚Çπ3.2 crore at 62. ‚Çπ1L invested at 32 = ‚Çπ1 crore at 62. Those 10 years are worth ‚Çπ2.2 crore. Time is the ultimate edge.</div>`},
    ],
    traineeModules:[
      {title:"Stock Market Basics",sub:"Shares, indices, exchanges ‚Äî the fundamentals",xp:30},
      {title:"How to Read a Chart",sub:"Candlesticks, support/resistance, volume",xp:40},
      {title:"Mutual Funds & ETFs",sub:"Active vs passive investing, expense ratios",xp:50},
      {title:"Cryptocurrency",sub:"Bitcoin, Ethereum, blockchain ‚Äî risks and rewards",xp:40},
      {title:"Portfolio Building",sub:"Diversification, asset allocation, rebalancing",xp:60},
    ]
  },
  science:{
    name:'üß¨ Science Arena', sub:'Space ¬∑ Physics ¬∑ Biology ¬∑ Discovery', color:'#ff4560',
    live: (c) => renderScienceLive(c),
    why:()=>`<div class="card-label" style="color:var(--red)">‚óÜ Why these discoveries matter to you</div>
    ${makeWhyCard('üöÄ','Reusable Rocket Revolution','Cost to space drops 100x','BULLISH','SpaceX\'s Starship aims to reduce launch costs from $10,000/kg to $100/kg. This makes space commercially viable. Indian companies like Skyroot and Agnikul are riding this wave.')}
    ${makeWhyCard('üß¨','CRISPR Gene Editing','We can now rewrite DNA errors','BULLISH','<span class="keyword" data-word="CRISPR" onclick="showGlossary(\'CRISPR\')">CRISPR</span> lets scientists edit genes like editing text. Curing hereditary blindness, sickle cell disease, certain cancers. India has 300M+ people with genetic diseases.')}
    ${makeWhyCard('‚òÄÔ∏è','Fusion Energy Progress','Unlimited clean energy on horizon','BULLISH','<span class="keyword" data-word="fusion energy" onclick="showGlossary(\'fusion energy\')">Fusion energy</span> Q>1 means we got more energy out than we put in. Commercial fusion by 2035 could mean electricity too cheap to meter.')}`,
    forecast:()=>`<div class="card-label" style="color:var(--xp2)">‚óÜ Science Horizon</div>
    <div class="card"><div class="ft-wrap"><div class="ft-line-vert"></div>
    ${makeFT('2025','Gaganyaan launches','India joins elite space nations','',true,'ISRO\'s first human spaceflight. Strategic + scientific milestone. Boosts India\'s space sector.',90,true)}
    ${makeFT('2026‚Äì28','CRISPR therapies approved','Genetic diseases curable','',true,'India-specific genetic diseases (thalassemia, sickle cell) likely first targets.',70,false)}
    ${makeFT('2030‚Äì35','Fusion electricity possible','Energy becomes abundant','',true,'India investing in fusion research. If successful, eliminates energy insecurity permanently.',50,false)}
    </div></div>`,
    questions:[
      {q:"Fusion energy achieves Q>1 ‚Äî more energy OUT than put IN. Why is this a big deal?",ctx:"üí° Fusion is how the sun works ‚Äî hydrogen atoms merge to release enormous energy.",opts:["It makes bombs more powerful","It could provide unlimited clean energy with no carbon or nuclear waste","It gives unlimited internet speed","It makes computers faster"],ans:1,xp:50,explain:"‚úÖ Fusion energy could solve humanity's energy crisis permanently. The fuel is hydrogen (from water) ‚Äî virtually infinite. The output is helium ‚Äî harmless. No carbon emissions, no nuclear waste."},
      {q:"CRISPR is described as 'Find and Replace for DNA'. What disease could it most directly help in India?",ctx:"üí° India has several prevalent genetic conditions that are caused by single gene mutations ‚Äî perfect targets for CRISPR.",opts:["Common cold (viral, not genetic)","Diabetes (lifestyle + genetic complexity)","Sickle cell disease (single gene mutation) ‚Äî affects 20M Indians","All cancers simultaneously"],ans:2,xp:60,explain:"‚úÖ Sickle cell disease is caused by a single point mutation in the hemoglobin gene ‚Äî making it an ideal CRISPR target. India has ~20M people with this disease. First CRISPR therapy (casgevy) was approved in 2023 and India-specific trials are underway."},
    ],
    dragGame: {prompt:"Match scientific breakthroughs to their potential impact",pairs:[{left:"CRISPR therapy",right:"Genetic disease cure"},{left:"Fusion energy",right:"Unlimited clean power"},{left:"Reusable rockets",right:"Cheaper space access"},{left:"mRNA vaccines",right:"Faster drug development"}]},
    learn:[
      {icon:'üß¨',title:'CRISPR: The DNA Editor',sub:'How scientists are rewriting life',badge:'Beginner',body:`<h3>What is DNA?</h3>DNA is the instruction manual for every cell in your body ‚Äî 3 billion letters of code. Errors cause genetic diseases.<h3>What is <span class='keyword' data-word='CRISPR' onclick='showGlossary("CRISPR")'>CRISPR</span>?</h3>CRISPR (Cas9) is a molecular "find and replace" tool. You program it with the faulty DNA sequence ‚Üí it finds it in the cell ‚Üí cuts it out ‚Üí the cell repairs itself.<h3>Why India Should Care</h3>India has 300M+ people with genetic disorders. Sickle cell disease affects 20M Indians. Thalassemia: 45 million carriers. CRISPR therapies could treat millions.<div class="example-box">üí∞ <strong>Investment angle:</strong> India's biotech sector (Sun Pharma, Biocon, Dr. Reddy's) are investing in gene therapy. Long-term 10-20 year bet.</div>`},
      {icon:'üöÄ',title:'The New Space Race',sub:"Why India's ISRO matters globally",badge:'Beginner',body:`<h3>The Commercial Space Revolution</h3>SpaceX proved rockets can be reused ‚Äî dramatically cutting costs. A single Falcon 9 launch: $2,700/kg to orbit. New Starship target: $100/kg. This opens space to everyone.<h3>India's Space Story</h3>Chandrayaan-3 landed on the Moon's south pole ‚Äî a world first. Gaganyaan will send Indians to space. India's space economy is projected to reach $44B by 2033.<div class="example-box">üí° <strong>Invest in space:</strong> Indian space startups like Skyroot Aerospace and Pixxel are growing. Space sector ETFs exist globally. ISRO's commercialization arm, NewSpace India, plans listings.</div>`},
    ],
    traineeModules:[
      {title:"Space & ISRO",sub:"India's space programme, missions, and commercial potential",xp:30},
      {title:"CRISPR & Genomics",sub:"Gene editing, applications, ethical questions",xp:40},
      {title:"Fusion & Clean Energy",sub:"Nuclear fusion, solar, India's energy future",xp:50},
      {title:"AI in Science",sub:"Drug discovery, climate modelling, physics breakthroughs",xp:40},
    ]
  }
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GAME ENGINE (MCQ + Drag & Drop)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gState = { q: 0, score: 0, streak: 0, correct: 0, answered: false, done: false, mode: 'mcq' };
let gQuestions = [];
let _dragState = { selected: null, matches: {} };

function buildGame() {
  // Daily rotation of questions using date seed
  const seed = getDailySeed() + S.currentArena.charCodeAt(0);
  const allQ = ARENAS[S.currentArena].questions;
  gQuestions = shuffleWithSeed(allQ, seed);
  gState = { q: 0, score: 0, streak: 0, correct: 0, answered: false, done: false, mode: 'mcq' };
  renderGameModeSelector();
}

function renderGameModeSelector() {
  const el = document.getElementById('game-content');
  const hs = getHighscores()[S.currentArena] || 0;
  el.innerHTML = `
    <div class="game-wrap">
      <div style="text-align:center;margin-bottom:20px">
        <div style="font-family:var(--ffh);font-size:22px;font-weight:700;letter-spacing:0.04em;margin-bottom:6px">Choose Game Mode</div>
        <div style="font-size:12px;color:var(--muted)">Your high score: <span style="color:var(--gold);font-family:var(--ffm)">${hs} XP</span> ¬∑ XP only awarded for new high scores</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
        <div onclick="startMCQ()" style="background:var(--card2);border:1px solid rgba(168,85,247,0.25);border-radius:14px;padding:18px;cursor:pointer;text-align:center;transition:all 0.2s" onmouseover="this.style.borderColor='var(--xp2)'" onmouseout="this.style.borderColor='rgba(168,85,247,0.25)'">
          <div style="font-size:32px;margin-bottom:8px">üß†</div>
          <div style="font-size:14px;font-weight:700;margin-bottom:4px">MCQ Quiz</div>
          <div style="font-size:11px;color:var(--muted)">${gQuestions.length} questions ¬∑ Multiple choice</div>
        </div>
        <div onclick="startDragGame()" style="background:var(--card2);border:1px solid rgba(245,200,66,0.25);border-radius:14px;padding:18px;cursor:pointer;text-align:center;transition:all 0.2s" onmouseover="this.style.borderColor='var(--gold)'" onmouseout="this.style.borderColor='rgba(245,200,66,0.25)'">
          <div style="font-size:32px;margin-bottom:8px">üîó</div>
          <div style="font-size:14px;font-weight:700;margin-bottom:4px">Match & Connect</div>
          <div style="font-size:11px;color:var(--muted)">Drag & drop ¬∑ Concept matching</div>
        </div>
      </div>
    </div>`;
}

function startMCQ() {
  gState.mode = 'mcq';
  gState.q = 0;
  renderQ();
}

function renderQ() {
  const el = document.getElementById('game-content');
  if (gState.q >= gQuestions.length) { showSummary(); return; }
  const q = gQuestions[gState.q];
  const letters = ['A', 'B', 'C', 'D'];
  el.innerHTML = `
    <div class="game-wrap" style="position:relative">
      <div class="game-hud">
        <div class="hud-item"><div class="hud-val" id="hud-score">${gState.score}</div><div class="hud-label">SCORE</div></div>
        <div class="hud-item"><div class="hud-val" style="color:var(--text)">${gState.q+1}/${gQuestions.length}</div><div class="hud-label">QUESTION</div></div>
        <div class="hud-item hud-streak"><div class="hud-val" id="hud-streak">${gState.streak}üî•</div><div class="hud-label">STREAK</div></div>
        <div class="hud-item hud-acc"><div class="hud-val" id="hud-acc">${gState.q > 0 ? Math.round(gState.correct/gState.q*100) : 100}%</div><div class="hud-label">ACCURACY</div></div>
      </div>
      <div class="game-q-num">Question ${gState.q+1} of ${gQuestions.length} ¬∑ +${q.xp} XP</div>
      <div class="game-q">${q.q}</div>
      <div class="game-context">${q.ctx}</div>
      <div class="opts-grid" id="opts-grid">
        ${q.opts.map((o, i) => `<button class="opt-btn" data-idx="${i}" onclick="answerQ(${i})"><div class="opt-letter">${letters[i]}</div><span>${o}</span></button>`).join('')}
      </div>
      <div class="game-result" id="game-result"></div>
      <div style="position:relative">
        <button class="next-q-btn" id="next-btn" onclick="nextQ()">Next Question ‚Üí</button>
        <span class="xp-pop" id="xp-pop"></span>
      </div>
    </div>
    <div class="score-summary" id="score-summary"></div>`;
}

function answerQ(chosen) {
  if (gState.answered) return;
  gState.answered = true;
  const q = gQuestions[gState.q];
  const opts = document.querySelectorAll('.opt-btn');
  const isRight = chosen === q.ans;
  opts.forEach((b, i) => {
    b.disabled = true;
    if (i === q.ans) b.classList.add('correct');
    else if (i === chosen && !isRight) b.classList.add('wrong');
  });
  const res = document.getElementById('game-result');
  res.className = 'game-result show ' + (isRight ? 'right' : 'wrong');
  // Always show correct answer text
  const correctText = q.opts[q.ans];
  res.innerHTML = `<div class="game-correct-answer">‚úì Correct Answer: ${correctText}</div>${(isRight ? '‚úÖ ' : '‚ùå ')}${q.explain}`;
  if (isRight) {
    gState.score += q.xp; gState.correct++; gState.streak++;
    S.totalCorrect++;
    const pop = document.getElementById('xp-pop');
    pop.textContent = `+${q.xp} XP`; pop.classList.add('fire');
    setTimeout(() => pop.classList.remove('fire'), 1100);
    document.getElementById('hud-score').textContent = gState.score;
    document.getElementById('hud-streak').textContent = gState.streak + 'üî•';
  } else {
    gState.streak = 0;
    document.getElementById('hud-streak').textContent = '0üî•';
  }
  document.getElementById('hud-acc').textContent = Math.round(gState.correct / (gState.q+1) * 100) + '%';
  document.getElementById('next-btn').classList.add('show');
}

function nextQ() {
  gState.q++; gState.answered = false;
  if (gState.q >= gQuestions.length) showSummary(); else renderQ();
}

function showSummary() {
  const el = document.getElementById('game-content');
  const pct = Math.round(gState.correct / gQuestions.length * 100);
  const trophy = pct === 100 ? 'üèÜ' : pct >= 80 ? 'ü•á' : pct >= 60 ? 'ü•à' : pct >= 40 ? 'ü•â' : 'üòÖ';
  const msg = pct === 100 ? 'PERFECT! Flawless!' : pct >= 80 ? 'Excellent work!' : pct >= 60 ? 'Good job! Keep learning.' : 'Review the Learn tab!';
  // Apply high-score XP logic
  const { awarded, isNewHS } = processGameXP(S.currentArena, gState.score);
  saveState();
  // Check Quiz Pro achievement (score 100 in any arena)
  if (pct === 100) unlockAchievement('quiz_pro');
  el.innerHTML = `
    <div class="score-summary show">
      <div class="ss-trophy">${trophy}</div>
      <div class="ss-title">${msg}</div>
      <div class="ss-sub">${gState.correct}/${gQuestions.length} correct ¬∑ ${gState.score} pts</div>
      <div class="ss-grid">
        <div class="ss-stat"><div class="ss-val">${gState.score}</div><div class="ss-label">Score</div></div>
        <div class="ss-stat"><div class="ss-val">${pct}%</div><div class="ss-label">Accuracy</div></div>
        <div class="ss-stat"><div class="ss-val">${gState.streak}üî•</div><div class="ss-label">Best Streak</div></div>
      </div>
      ${isNewHS ? `<div class="hs-badge">üèÖ New High Score! +${awarded} XP earned</div>` : `<div class="hs-badge" style="color:var(--muted);border-color:var(--border);background:var(--dim)">High score unchanged ‚Äî XP not added</div>`}
      <button class="replay-btn" style="margin-top:16px" onclick="buildGame()">üîÑ Try Again</button>
    </div>`;
}

// ‚îÄ‚îÄ DRAG & DROP GAME ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚îÄ‚îÄ MATCH & CONNECT GAME (thread connector UI) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Both columns remain static; SVG lines connect matched pairs
// Click left item to select, click right item to connect ‚Äî shows a thread line
function startDragGame() {
  const arena = S.currentArena;
  const pairs = ARENAS[arena].dragGame;
  const seed = getDailySeed() + arena.charCodeAt(0) + 99;
  const shuffledPairs = shuffleWithSeed(pairs.pairs, seed);
  const rightItems = shuffleWithSeed(shuffledPairs.map(p => p.right), seed + 7);
  // matches[leftIdx] = rightIdx in the rightItems array
  _dragState = { selected: null, matches: {}, pairs: shuffledPairs, rightItems };

  const el = document.getElementById('game-content');
  el.innerHTML = `
    <div class="drag-game-wrap">
      <div class="drag-title">üîó Match & Connect</div>
      <div class="drag-prompt">${pairs.prompt}</div>
      <div style="font-size:11px;color:var(--muted);margin-bottom:14px;text-align:center">
        üëÜ Click a <strong style="color:var(--xp2)">concept</strong> on the left, then click its matching <strong style="color:var(--gold)">definition</strong> on the right
      </div>
      <div class="drag-columns" id="drag-columns-wrap">
        <div>
          <div class="drag-col-title">Concept</div>
          <div class="drag-items" id="drag-left">
            ${shuffledPairs.map((p, i) => `<div class="drag-item" id="drag-${i}" data-idx="${i}" onclick="dragClick(${i})" draggable="true" ondragstart="dragStart(event,${i})">${p.left}</div>`).join('')}
          </div>
        </div>
        <div class="drag-svg-col" id="drag-svg-col" style="position:relative">
          <svg id="connector-svg" class="drag-connector-svg" style="position:absolute;top:0;left:0;width:100%;height:100%;overflow:visible;pointer-events:none"></svg>
        </div>
        <div>
          <div class="drag-col-title">Definition</div>
          <div class="drag-items" id="drag-right">
            ${rightItems.map((r, i) => `<div class="drop-zone" id="drop-${i}" data-val="${r}" data-ridx="${i}" ondragover="event.preventDefault();this.classList.add('drag-over')" ondragleave="this.classList.remove('drag-over')" ondrop="dropItem(event,${i})" onclick="dropClick(${i})">${r}</div>`).join('')}
          </div>
        </div>
      </div>
      <div id="drag-feedback" style="font-size:13px;color:var(--muted);text-align:center;min-height:24px;margin:8px 0"></div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
        <button class="drag-submit-btn" onclick="checkDragAnswers()">Check Answers ‚úì</button>
        <button class="drag-submit-btn" style="border-color:rgba(255,69,96,0.3);color:var(--red)" onclick="clearDragMatches()">Clear All ‚úï</button>
      </div>
    </div>`;
  // Sync SVG height after render
  requestAnimationFrame(syncDragSvgHeight);
}

function syncDragSvgHeight() {
  const leftCol = document.getElementById('drag-left');
  const rightCol = document.getElementById('drag-right');
  const svgCol   = document.getElementById('drag-svg-col');
  if (!leftCol || !svgCol) return;
  const h = Math.max(leftCol.offsetHeight, rightCol ? rightCol.offsetHeight : 0);
  svgCol.style.height = h + 'px';
  const svg = document.getElementById('connector-svg');
  if (svg) svg.setAttribute('height', h);
}

function dragStart(e, idx) {
  e.dataTransfer.setData('text/plain', String(idx));
  document.getElementById(`drag-${idx}`).classList.add('dragging');
}

function dragClick(leftIdx) {
  // Deselect if clicking already-selected
  if (_dragState.selected === leftIdx) {
    document.getElementById(`drag-${leftIdx}`).classList.remove('selected');
    _dragState.selected = null;
    return;
  }
  // Deselect previous
  if (_dragState.selected !== null) {
    document.getElementById(`drag-${_dragState.selected}`)?.classList.remove('selected');
  }
  // Select this left item (unless already matched)
  if (!_dragState.matches.hasOwnProperty(leftIdx)) {
    _dragState.selected = leftIdx;
    document.getElementById(`drag-${leftIdx}`).classList.add('selected');
  }
}

function dropItem(e, rightIdx) {
  e.preventDefault();
  const leftIdx = parseInt(e.dataTransfer.getData('text/plain'));
  document.querySelectorAll('.drag-item').forEach(d => d.classList.remove('dragging'));
  document.getElementById(`drop-${rightIdx}`).classList.remove('drag-over');
  connectMatch(leftIdx, rightIdx);
}

function dropClick(rightIdx) {
  if (_dragState.selected === null) return;
  const leftIdx = _dragState.selected;
  _dragState.selected = null;
  document.getElementById(`drag-${leftIdx}`)?.classList.remove('selected');
  connectMatch(leftIdx, rightIdx);
}

function connectMatch(leftIdx, rightIdx) {
  // Remove any existing match for this left item
  if (_dragState.matches.hasOwnProperty(leftIdx)) {
    const oldRight = _dragState.matches[leftIdx];
    document.getElementById(`drop-${oldRight}`)?.classList.remove('matched-target');
  }
  // Remove any existing match pointing to this right slot
  for (const [li, ri] of Object.entries(_dragState.matches)) {
    if (ri === rightIdx) {
      delete _dragState.matches[li];
      document.getElementById(`drag-${li}`)?.classList.remove('matched');
    }
  }
  _dragState.matches[leftIdx] = rightIdx;
  document.getElementById(`drag-${leftIdx}`)?.classList.add('matched');
  document.getElementById(`drop-${rightIdx}`)?.classList.add('matched-target');
  drawConnectors();
}

const THREAD_COLORS = ['#a855f7','#f5c842','#00bfff','#00e676','#ff8c42'];

function drawConnectors() {
  const svg = document.getElementById('connector-svg');
  if (!svg) return;
  syncDragSvgHeight();
  svg.innerHTML = '';
  const svgRect = svg.getBoundingClientRect();

  Object.entries(_dragState.matches).forEach(([leftIdx, rightIdx], i) => {
    const leftEl  = document.getElementById(`drag-${leftIdx}`);
    const rightEl = document.getElementById(`drop-${rightIdx}`);
    if (!leftEl || !rightEl) return;

    const lr = leftEl.getBoundingClientRect();
    const rr = rightEl.getBoundingClientRect();

    // Right edge of left item ‚Üí left edge of right item (relative to SVG)
    const x1 = lr.right  - svgRect.left;
    const y1 = lr.top    - svgRect.top  + lr.height / 2;
    const x2 = rr.left   - svgRect.left;
    const y2 = rr.top    - svgRect.top  + rr.height / 2;

    // Bezier control points for a smooth S-curve
    const cx = (x1 + x2) / 2;
    const color = THREAD_COLORS[i % THREAD_COLORS.length];

    // Shadow/glow path
    const glow = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    glow.setAttribute('d', `M${x1},${y1} C${cx},${y1} ${cx},${y2} ${x2},${y2}`);
    glow.setAttribute('stroke', color);
    glow.setAttribute('stroke-width', '6');
    glow.setAttribute('opacity', '0.15');
    glow.setAttribute('fill', 'none');
    glow.setAttribute('stroke-linecap', 'round');
    svg.appendChild(glow);

    // Main thread line
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('d', `M${x1},${y1} C${cx},${y1} ${cx},${y2} ${x2},${y2}`);
    path.setAttribute('stroke', color);
    path.setAttribute('stroke-width', '2.5');
    path.setAttribute('opacity', '0.85');
    path.setAttribute('fill', 'none');
    path.setAttribute('stroke-linecap', 'round');
    // Animated dash
    const totalLen = 200;
    path.setAttribute('stroke-dasharray', totalLen);
    path.setAttribute('stroke-dashoffset', totalLen);
    path.style.transition = 'stroke-dashoffset 0.4s ease';
    svg.appendChild(path);
    requestAnimationFrame(() => { path.setAttribute('stroke-dashoffset', '0'); });

    // Dot at start
    const dot1 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot1.setAttribute('cx', x1); dot1.setAttribute('cy', y1); dot1.setAttribute('r', '4');
    dot1.setAttribute('fill', color); dot1.setAttribute('opacity', '0.9');
    svg.appendChild(dot1);

    // Dot at end
    const dot2 = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
    dot2.setAttribute('cx', x2); dot2.setAttribute('cy', y2); dot2.setAttribute('r', '4');
    dot2.setAttribute('fill', color); dot2.setAttribute('opacity', '0.9');
    svg.appendChild(dot2);
  });
}

function clearDragMatches() {
  _dragState.matches = {};
  _dragState.selected = null;
  document.querySelectorAll('.drag-item').forEach(el => el.classList.remove('matched','selected','wrong-match'));
  document.querySelectorAll('.drop-zone').forEach(el => el.classList.remove('matched-target','filled','wrong'));
  const svg = document.getElementById('connector-svg');
  if (svg) svg.innerHTML = '';
  const fb = document.getElementById('drag-feedback');
  if (fb) fb.innerHTML = '';
}

function checkDragAnswers() {
  const pairs = _dragState.pairs;
  let correct = 0;
  const total  = pairs.length;
  // Check each match
  Object.entries(_dragState.matches).forEach(([leftIdxStr, rightIdx]) => {
    const leftIdx  = parseInt(leftIdxStr);
    const leftItem = pairs[leftIdx];
    const rightVal = _dragState.rightItems[rightIdx];
    const isCorrect = leftItem.right === rightVal;
    const leftEl  = document.getElementById(`drag-${leftIdx}`);
    const rightEl = document.getElementById(`drop-${rightIdx}`);
    if (isCorrect) {
      correct++;
      leftEl?.classList.add('matched');
      rightEl?.classList.remove('matched-target');
      rightEl?.classList.add('filled');
    } else {
      leftEl?.classList.add('wrong-match');
      rightEl?.classList.add('wrong');
      setTimeout(() => {
        leftEl?.classList.remove('wrong-match');
        rightEl?.classList.remove('wrong');
      }, 700);
    }
  });
  // Redraw connectors with final state
  drawConnectors();
  const fb = document.getElementById('drag-feedback');
  if (correct === total) {
    fb.innerHTML = `<span style="color:var(--green)">‚úÖ Perfect! All ${total} matches correct!</span>`;
    const { awarded, isNewHS } = processGameXP(S.currentArena + '_drag', total * 50);
    if (awarded > 0) showLevelUp(`Match Master! +${awarded} XP`);
    unlockAchievement('quiz_pro');
    saveState();
  } else if (Object.keys(_dragState.matches).length < total) {
    fb.innerHTML = `<span style="color:var(--muted)">Match all ${total} pairs first, then check!</span>`;
  } else {
    fb.innerHTML = `<span style="color:var(--orange)">${correct}/${total} correct ‚Äî wrong connections shown in red. Try again!</span>`;
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// XP & LEVELS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function addXP(amount) {
  S.xp += amount;
  S.arenaXP += amount;
  const newLevel = getLevelFromXP(S.xp);
  if (newLevel > S.level) {
    S.level = newLevel;
    showLevelUp(`‚¨ÜÔ∏è Level Up! You reached Level ${S.level} ‚Äî ${getLevelTitle(S.level)}`);
    if (S.level >= 10) unlockAchievement('diamond_iq');
  }
  updateXPBar();
  saveState();
  const xpDisp = document.getElementById('arena-xp-display');
  if (xpDisp) xpDisp.textContent = `+${S.arenaXP} XP this session`;
}

function updateXPBar() {
  const lv    = getLevelFromXP(S.xp);
  S.level     = lv;
  const withinLv = xpWithinLevel(S.xp);
  const neededLv = xpForCurrentLevel(S.xp);
  const pct   = Math.min(100, Math.round(withinLv / neededLv * 100));
  const fill  = document.getElementById('xp-fill');
  const val   = document.getElementById('xp-val');
  const lvEl  = document.getElementById('lv-num');
  const str   = document.getElementById('str-num');
  const xpLbl = document.getElementById('xp-label');
  if (fill) fill.style.width = pct + '%';
  if (val)  val.textContent  = S.xp;
  if (lvEl) lvEl.textContent = lv;
  const lvInline = document.getElementById('lv-inline');
  if (lvInline) lvInline.textContent = lv;
  if (str)  str.textContent  = S.streak;
  // Update XP bar tooltip to show progress within level
  const xpWrap = document.querySelector('.xp-wrap');
  if (xpWrap) xpWrap.title = `${withinLv}/${neededLv} XP ‚Äî Level ${lv}: ${getLevelTitle(lv)}`;
  const lvIcon = document.getElementById('lv-icon');
  if (lvIcon) {
    const icons = ['üå±','üå±','üì∞','üì∞','üìä','üìä','üåç','üåç','üß†','üß†','üíé','üíé','üèÜ'];
    lvIcon.textContent = icons[Math.min(lv, icons.length-1)];
  }
  // Update XP bar tooltip
  const xpValEl = document.getElementById('xp-val');
  if (xpValEl) xpValEl.title = `Total: ${S.xp} XP | Level ${lv}: ${within}/${neededLv} XP`;
}

let _toastTimer = null;
function showLevelUp(msg) {
  const t = document.getElementById('lvl-toast');
  document.getElementById('lt-sub').textContent = msg;
  t.classList.add('show');
  if (_toastTimer) clearTimeout(_toastTimer);
  _toastTimer = setTimeout(() => t.classList.remove('show'), 3000);
}

function showLvlModal() {
  const lv     = getLevelFromXP(S.xp);
  const within = xpWithinLevel(S.xp);
  const needed = xpForCurrentLevel(S.xp);
  const toNext = needed - within;
  const title  = getLevelTitle(lv);
  // Build level ladder display
  const levels = [1,2,3,4,5,6,7,8,9,10,15,20];
  const ladder = levels.map(n => {
    const threshold = xpToReachLevel(n);
    const req = xpNeededForLevel(n);
    const done = S.xp >= threshold + req;
    const current = n === lv;
    const locked = S.xp < threshold;
    const icon = done ? '‚úÖ' : current ? '‚ñ∂Ô∏è' : locked ? 'üîí' : '‚¨ú';
    return `<div style="display:flex;align-items:center;gap:10px;padding:6px 0;border-bottom:1px solid var(--border);opacity:${locked?0.4:1}">
      <span style="font-size:16px">${icon}</span>
      <div style="flex:1">
        <div style="font-size:13px;font-weight:700;color:${current?'var(--xp2)':'var(--text)'}">Level ${n} ‚Äî ${getLevelTitle(n)}</div>
        <div style="font-size:11px;color:var(--muted)">Starts at ${threshold.toLocaleString('en-IN')} XP ¬∑ Level needs ${req.toLocaleString('en-IN')} XP</div>
      </div>
      ${current ? `<span style="font-family:var(--ffm);font-size:10px;color:var(--xp2);padding:2px 8px;border:1px solid rgba(168,85,247,0.3);border-radius:6px">YOU ARE HERE</span>` : ''}
    </div>`;
  }).join('');
  openLesson('‚ö°', 'Your Progress',
    `<h3>Current Status</h3>
    <div style="background:rgba(124,58,237,0.08);border:1px solid rgba(124,58,237,0.2);border-radius:12px;padding:14px;margin-bottom:16px">
      <div style="font-family:var(--ffh);font-size:24px;font-weight:700;color:var(--xp2)">Level ${lv}</div>
      <div style="font-size:13px;color:var(--muted);margin:4px 0 10px">${title}</div>
      <div style="font-size:13px"><strong style="color:var(--text)">${S.xp.toLocaleString('en-IN')}</strong> total XP ¬∑ <strong style="color:var(--gold)">${toNext}</strong> more XP to Level ${lv+1}</div>
      <div style="margin-top:10px;height:6px;background:var(--dim);border-radius:3px;overflow:hidden">
        <div style="height:100%;width:${Math.round(within/needed*100)}%;background:linear-gradient(90deg,var(--xp),var(--xp2));border-radius:3px;transition:width 0.5s"></div>
      </div>
      <div style="font-size:10px;color:var(--muted);margin-top:4px">${within}/${needed} XP within this level</div>
    </div>
    <h3>How to Earn XP</h3>
    <div style="font-size:13px;color:#7080a0;line-height:1.8">
      ‚Ä¢ Quiz high score improvement: XP equal to score gain<br>
      ‚Ä¢ First time viewing any card: +20 XP<br>
      ‚Ä¢ Completing a Trainee module: +25‚Äì40 XP<br>
      ‚Ä¢ Daily Quest (visit 2 arenas): +150 XP<br>
      ‚Ä¢ Match & Connect perfect score: +200 XP
    </div>
    <h3>Level Ladder</h3>${ladder}`);
}
function showStreakInfo() {
  openLesson('üî•', `${S.streak} Day Streak!`,
    `<h3>Your Streak</h3>You've used WORLD IQ for <strong>${S.streak} consecutive day${S.streak > 1 ? 's' : ''}.</strong>
    <h3>Why Streaks Matter</h3>Neuroscience shows it takes 21 days to form a habit and 66 days to make it automatic. Every day you open WORLD IQ, you're literally rewiring your brain to seek knowledge.
    <div class="example-box">üèÜ <strong>Streak rewards:</strong> 7 days = "Consistent" badge ¬∑ 30 days = "Scholar" badge ¬∑ 100 days = "World IQ Master" badge</div>`);
}
function showAchieve(title, desc) {
  openLesson('üèÜ', title, `<p>${desc}</p>`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let currentInner = 0;

function openArena(id) {
  S.currentArena = id;
  S.arenaXP = 0;
  const a = ARENAS[id];
  document.getElementById('homescreen').style.display = 'none';
  document.getElementById('arenascreen').style.display = 'block';
  document.getElementById('arena-top-name').textContent = a.name;
  document.getElementById('arena-top-sub').textContent = a.sub;
  document.getElementById('arena-xp-display').textContent = '+0 XP today';
  switchInner(0);
  // Visit tracking (daily quest)
  if (!S.visitedArenas.has(id)) {
    S.visitedArenas.add(id);
    const visited = Array.from(S.visitedArenas);
    localStorage.setItem('wiq_visited_today', JSON.stringify(visited));
    addXP(20);
    updateQuest();
    // Arena explorer achievement
    if (S.visitedArenas.size >= 6) unlockAchievement('arena_explorer');
  }
  window.scrollTo(0, 0);
}

function goHome() {
  document.getElementById('arenascreen').style.display = 'none';
  document.getElementById('homescreen').style.display = 'block';
  window.scrollTo(0, 0);
}

function switchInner(i) {
  currentInner = i;
  document.querySelectorAll('.itab').forEach((t, j) => t.classList.toggle('active', j === i));
  document.querySelectorAll('.ipanel').forEach((p, j) => p.classList.toggle('active', j === i));
  const a = ARENAS[S.currentArena];
  if (i === 0) {
    const wrap = document.getElementById('live-content');
    wrap.innerHTML = `<div id="live-inner" style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px"></div>`;
    a.live(document.getElementById('live-inner'));
    recordCardCompletion(S.currentArena, 0);
  }
  if (i === 1) {
    document.getElementById('why-content').innerHTML = `<div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px;margin-bottom:16px">${a.why()}</div>`;
    recordCardCompletion(S.currentArena, 1);
  }
  if (i === 2) {
    document.getElementById('forecast-content').innerHTML = a.forecast();
    setTimeout(animConf, 300);
    recordCardCompletion(S.currentArena, 2);
  }
  if (i === 3) { buildGame(); recordCardCompletion(S.currentArena, 3); }
  if (i === 4) { buildLearn(); recordCardCompletion(S.currentArena, 4); }
  if (i === 5) { buildTrainee(); }
}

function toggleWhy(el) { el.classList.toggle('open'); }

// ‚îÄ LEARN TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildLearn() {
  const lessons = ARENAS[S.currentArena].learn;
  const container = document.getElementById('learn-content');
  window._learnBodies = lessons.map(l => l.body);
  container.innerHTML = `
    <div class="learn-grid">
      ${lessons.map((l, idx) => `
        <div class="learn-card" data-lesson-index="${idx}">
          <div class="lc-icon">${l.icon}</div>
          <div class="lc-title">${l.title}</div>
          <div class="lc-sub">${l.sub}</div>
          <div class="lc-badge">${l.badge}</div>
        </div>`).join('')}
    </div>
    <div style="background:rgba(124,58,237,0.06);border:1px solid rgba(124,58,237,0.15);border-radius:14px;padding:16px;text-align:center">
      <div style="font-size:24px;margin-bottom:8px">üß†</div>
      <div style="font-size:14px;font-weight:700;margin-bottom:4px">More lessons unlocking</div>
      <div style="font-size:12px;color:var(--muted)">Complete quizzes to unlock advanced lessons</div>
    </div>`;
  document.querySelectorAll('.learn-card').forEach(card => {
    card.addEventListener('click', () => {
      const idx = card.dataset.lessonIndex;
      const lesson = lessons[idx];
      openLesson(lesson.icon, lesson.title, window._learnBodies[idx]);
    });
  });
}
function openLesson(icon, title, body) {
  document.getElementById('lb-icon').textContent = icon;
  document.getElementById('lb-title').textContent = title;
  document.getElementById('lb-body').innerHTML = body;
  document.getElementById('lesson-modal').classList.add('show');
}
function closelesson() { document.getElementById('lesson-modal').classList.remove('show'); }

// ‚îÄ TRAINEE TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// [FIX 3] Storage: wiq_trainee_progress = { arenaName: { completed: [], lastDate: "" } }
// XP only awarded AFTER user clicks "Mark Complete" inside the lesson view
// No instant XP on list click

function getTraineeProgress(arena) {
  try {
    const raw = JSON.parse(localStorage.getItem('wiq_trainee_progress') || '{}');
    return raw[arena] || { completed: [], lastDate: '' };
  } catch { return { completed: [], lastDate: '' }; }
}
function saveTraineeProgress(arena, progress) {
  try {
    const raw = JSON.parse(localStorage.getItem('wiq_trainee_progress') || '{}');
    raw[arena] = progress;
    localStorage.setItem('wiq_trainee_progress', JSON.stringify(raw));
  } catch {}
}

function buildTrainee() {
  const arena   = S.currentArena;
  const modules = ARENAS[arena].traineeModules || [];
  const prog    = getTraineeProgress(arena);
  const done    = prog.completed || [];
  const total   = modules.length;
  const pct     = total > 0 ? Math.round(done.length / total * 100) : 0;
  const container = document.getElementById('trainee-content');
  container.innerHTML = `
    <div class="trainee-wrap">
      <div class="trainee-header">
        <div class="trainee-title">üéì Trainee Mode</div>
        <div class="trainee-sub">Structured path ¬∑ ${ARENAS[arena].name}</div>
        <div class="trainee-progress-wrap">
          <div class="trainee-prog-bar"><div class="trainee-prog-fill" style="width:${pct}%"></div></div>
          <div class="trainee-prog-label">${done.length}/${total} modules complete ¬∑ ${pct}%</div>
        </div>
      </div>
      <div class="module-list" id="module-list">
        ${modules.map((m, idx) => {
          const isDone   = done.includes(idx);
          const isLocked = idx > done.length; // must complete in order
          const cls      = isDone ? 'completed' : isLocked ? 'locked' : '';
          const badge    = isDone
            ? '<span class="module-badge done">‚úì Done</span>'
            : isLocked
            ? '<span class="module-badge lock">üîí</span>'
            : '<span class="module-badge todo">‚Üí Open</span>';
          return `<div class="module-card ${cls}" data-arena="${arena}" data-idx="${idx}" ${!isLocked && !isDone ? 'style="cursor:pointer"' : ''}>
            <div class="module-num" style="color:${isDone ? 'var(--green)' : isLocked ? 'var(--muted)' : 'var(--xp2)'}">${isDone ? '‚úì' : idx+1}</div>
            <div class="module-info">
              <div class="module-title">${m.title}</div>
              <div class="module-sub">${m.sub} ¬∑ <span style="color:var(--xp2)">+${m.xp} XP on completion</span></div>
            </div>
            ${badge}
          </div>`;
        }).join('')}
      </div>
      <div style="margin-top:20px;background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px;text-align:center">
        <div style="font-size:11px;color:var(--muted);line-height:1.7">
          üìå Click a module to read it ¬∑ XP awarded only after clicking <strong style="color:var(--text)">Mark Complete</strong>
        </div>
      </div>
    </div>`;

  // Attach click handlers after rendering
  document.querySelectorAll('#module-list .module-card').forEach(card => {
    const idx   = parseInt(card.dataset.idx);
    const arenaId = card.dataset.arena;
    const isDone   = done.includes(idx);
    const isLocked = idx > done.length;
    if (!isDone && !isLocked) {
      card.addEventListener('click', () => openTraineeLesson(arenaId, idx));
    }
  });
}

// [FIX 3] Open a trainee lesson in the lesson modal ‚Äî shows content, then Mark Complete button
function openTraineeLesson(arena, idx) {
  const m    = ARENAS[arena].traineeModules[idx];
  const prog = getTraineeProgress(arena);
  // Build rich lesson content from module data
  const lessonContent = `
    <div style="margin-bottom:16px">
      <div style="font-family:var(--ffm);font-size:9px;letter-spacing:0.15em;text-transform:uppercase;color:var(--muted);margin-bottom:8px">MODULE ${idx+1} OF ${ARENAS[arena].traineeModules.length}</div>
      <div style="font-size:13px;color:#7080a0;line-height:1.85;margin-bottom:16px">${m.sub}</div>
    </div>
    ${m.content || generateModuleContent(arena, idx)}
    <div style="margin-top:20px;padding:14px;background:rgba(0,230,118,0.06);border:1px solid rgba(0,230,118,0.2);border-radius:12px">
      <div style="font-size:12px;color:var(--muted);margin-bottom:10px">‚úÖ Read through this lesson, then mark it complete to earn your XP.</div>
      <button onclick="completeTraineeModule('${arena}',${idx})" style="width:100%;padding:11px;border-radius:10px;border:1px solid rgba(0,230,118,0.4);background:rgba(0,230,118,0.1);color:var(--green);font-family:var(--ffm);font-size:11px;letter-spacing:0.1em;cursor:pointer;transition:all 0.2s" onmouseover="this.style.background='rgba(0,230,118,0.2)'" onmouseout="this.style.background='rgba(0,230,118,0.1)'">
        ‚úì Mark Complete ¬∑ Earn +${m.xp} XP
      </button>
    </div>`;
  openLesson(m.icon || 'üìñ', m.title, lessonContent);
}

// Generate structured content for trainee modules based on arena + index
function generateModuleContent(arena, idx) {
  const CONTENT = {
    gold: [
      `<h3>What is Gold?</h3>Gold is a chemical element (Au) with atomic number 79. It has been used as money and jewellery for over 5,000 years across every civilisation.<br><br><strong>Physical properties:</strong> Never corrodes ¬∑ Extremely dense (19.3 g/cm¬≥) ¬∑ Conducts electricity ¬∑ Malleable (1oz can be hammered to 300 sq ft)<br><br><strong>Cultural significance in India:</strong> India is the world's 2nd largest gold consumer. Gold is central to weddings, festivals, and is considered an auspicious store of value ‚Äî not just an investment.<div class="example-box">üí° India imports ~700-800 tonnes of gold per year, making it one of the largest drivers of global gold demand. Festival seasons (Diwali, Akshaya Tritiya, wedding season Oct-Dec) cause domestic price spikes.</div>`,
      `<h3>How Gold is Priced in India</h3>Gold pricing in India has multiple layers:<br><br>‚Ä¢ <strong>MCX Spot Price:</strong> Based on global COMEX/LBMA price √ó USD/INR rate<br>‚Ä¢ <strong>Import Duty:</strong> Currently ~15% ‚Äî India levies one of the world's highest gold import taxes<br>‚Ä¢ <strong>GST:</strong> 3% on jewellery purchase<br>‚Ä¢ <strong>Making Charges:</strong> Jeweller's fee ‚Äî 8-25% extra<br><br>So if MCX gold is ‚Çπ72,000/10g, jewellery may cost ‚Çπ82,000-90,000/10g after all charges.<div class="example-box">üí° Best way to buy gold without making charges: Sovereign Gold Bonds (SGB) or Gold ETFs on NSE/BSE. Zero making charges, and SGBs pay 2.5% annual interest!</div>`,
      `<h3>Gold vs Other Asset Classes</h3><strong>20-year return comparison (India):</strong><br>‚Ä¢ Gold: ~13% CAGR<br>‚Ä¢ Nifty 50: ~14% CAGR<br>‚Ä¢ Fixed Deposits: ~7% CAGR<br>‚Ä¢ Real Estate: ~9-11% CAGR (varies hugely by location)<br><br><strong>When gold outperforms equities:</strong> During bear markets, crises, high inflation, currency depreciation. Gold is your hedge, not your growth engine.<div class="example-box">üí° Rule of thumb: Keep 10-15% of your portfolio in gold. It reduces overall volatility. When everything else crashes in 2008 or 2020, gold either held value or went up.</div>`,
      `<h3>Silver's Dual Identity</h3>Silver is unique ‚Äî it's both a precious metal AND an industrial commodity.<br><br><strong>Investment demand (30% of silver):</strong> Coins, bars, ETFs<br><strong>Industrial demand (70% of silver):</strong><br>‚Ä¢ Solar panels: 20g of silver paste per panel<br>‚Ä¢ EV batteries: 25-50g per vehicle<br>‚Ä¢ Electronics: 0.3g per smartphone<br>‚Ä¢ Medical: Antibacterial coatings, equipment<br><br><strong>Why this matters:</strong> Unlike gold, if industry slows ‚Äî silver falls faster. If green energy booms ‚Äî silver could be scarce.<div class="example-box">üí° India's 500 GW renewable energy target by 2030 requires an estimated 15,000 tonnes of silver ‚Äî nearly 6√ó India's current annual silver imports.</div>`,
      `<h3>How to Buy Gold & Silver in India</h3><strong>5 ways, ranked by efficiency:</strong><br><br>1. <strong>Sovereign Gold Bonds (SGB):</strong> Best for long-term. Issued by RBI. Pays 2.5% interest. Zero GST on redemption. Tracks gold price.<br>2. <strong>Gold ETF (NSE/BSE):</strong> Like buying shares of gold. Liquid. No storage risk. ~0.5% expense ratio.<br>3. <strong>Digital Gold:</strong> Instant, fractional. But check if backed by physical gold (MMTC-PAMP, Augmont).<br>4. <strong>Gold Mutual Fund:</strong> Invests in Gold ETFs. Good for SIP mode.<br>5. <strong>Physical Gold:</strong> Jewellery has high making charges. Gold coins/bars are purer but need safe storage.<div class="example-box">üí° Start a ‚Çπ500/month Gold ETF SIP today on Groww or Zerodha. Over 10 years at historical returns, ‚Çπ60,000 invested ‚Üí ‚Çπ1.1 lakh+.</div>`,
    ],
    india: [
      `<h3>India's GDP ‚Äî The Numbers Behind the Story</h3>India's GDP is ~$3.7 trillion (FY2024), making it the world's 5th largest economy. At current growth rates of 7-8%, India becomes the 3rd largest by 2027-28.<br><br><strong>GDP breakdown:</strong><br>‚Ä¢ Services: 54% (IT, finance, retail, healthcare)<br>‚Ä¢ Industry: 28% (manufacturing, construction, utilities)<br>‚Ä¢ Agriculture: 18% (employs 44% of workforce, but contributes only 18% to GDP)<br><br><strong>What drives 8% growth:</strong> Infrastructure spending, PLI scheme manufacturing, IT exports, domestic consumption, digital economy.<div class="example-box">üí° India's per capita GDP is ~$2,600. For comparison: China $13,000, USA $80,000. This means India's growth runway is enormous ‚Äî we're still early in the curve.</div>`,
      `<h3>RBI ‚Äî The Engine of India's Money</h3>The Reserve Bank of India (RBI) controls India's monetary policy. Its core mandate: keep inflation near 4% while supporting growth.<br><br><strong>How RBI controls money supply:</strong><br>‚Ä¢ <strong>Repo Rate:</strong> Rate at which RBI lends to banks. Lower = cheaper loans = growth. Higher = expensive loans = inflation controlled.<br>‚Ä¢ <strong>CRR (Cash Reserve Ratio):</strong> % of deposits banks must hold with RBI. Higher = less money to lend = tighter money supply.<br>‚Ä¢ <strong>OMO (Open Market Operations):</strong> RBI buys/sells government bonds to inject/suck money from the system.<div class="example-box">üí° RBI's rate decisions happen every 2 months at the MPC (Monetary Policy Committee) meeting. The repo rate directly affects your home loan EMI. A 0.25% cut on a ‚Çπ50L loan = ‚Çπ750-1,000/month savings.</div>`,
      `<h3>The Union Budget Explained</h3>India's Union Budget, presented every February, determines how the government earns and spends ‚Çπ50+ lakh crore annually.<br><br><strong>Revenue side:</strong><br>‚Ä¢ Direct taxes (income tax, corporate tax): ~‚Çπ20 lakh crore<br>‚Ä¢ GST and indirect taxes: ~‚Çπ22 lakh crore<br>‚Ä¢ Borrowings: ~‚Çπ15 lakh crore (fiscal deficit)<br><br><strong>Expenditure side:</strong><br>‚Ä¢ Capital expenditure (roads, railways, defence): ‚Çπ11 lakh crore FY24 (record)<br>‚Ä¢ Revenue expenditure (salaries, subsidies): ‚Çπ35+ lakh crore<div class="example-box">üí° The fiscal deficit = government spends more than it earns. India's target: 4.5% of GDP by FY26. High fiscal deficit = government borrows more = interest rates stay higher = your loan EMIs are affected.</div>`,
      `<h3>Understanding FII & DII Flows</h3>Indian stock markets are driven by TWO major investor groups:<br><br><strong>FII (Foreign Institutional Investors):</strong> Global funds (BlackRock, Vanguard, Singapore GIC) investing in Indian stocks and bonds. They move large amounts quickly ‚Äî causing big market swings.<br><br><strong>DII (Domestic Institutional Investors):</strong> Indian institutions (LIC, SBI Mutual Fund, HDFC MF). They often buy when FIIs sell ‚Äî acting as a stabiliser.<br><br><strong>How to track:</strong> NSE website publishes daily FII/DII data by 7 PM every trading day.<div class="example-box">üí° In 2023-24, DIIs invested ‚Çπ2.3 lakh crore into Indian equities ‚Äî partially absorbing ‚Çπ1.2 lakh crore of FII selling. SIP investors (like you) ARE the DII strength.</div>`,
    ],
    world: [
      `<h3>How the Global Economy Works</h3>The world economy is interconnected through trade, finance, and supply chains. No country is truly independent.<br><br><strong>The US dollar's special role:</strong> 85% of global trade is settled in USD. Oil, gold, wheat ‚Äî all priced in dollars. This gives the USA enormous power ‚Äî their monetary policy affects everyone.<br><br><strong>Key global economic players:</strong><br>‚Ä¢ USA: $27T GDP, global reserve currency, tech/finance dominance<br>‚Ä¢ China: $18T GDP, manufacturing hub, growing geopolitical power<br>‚Ä¢ EU: $18T combined, regulatory superpower<br>‚Ä¢ India: $3.7T, fastest-growing large economy<div class="example-box">üí° When the US sneezes, the world catches a cold. The 2008 US housing crisis caused a global recession. The 2022 US Fed rate hikes caused currency crises in Sri Lanka, Turkey, and Argentina.</div>`,
      `<h3>The US Federal Reserve</h3>The Federal Reserve (the "Fed") is America's central bank ‚Äî but its decisions affect every economy on Earth.<br><br><strong>The Fed's two mandates:</strong><br>1. Price stability (2% inflation target)<br>2. Maximum employment<br><br><strong>The rate hike cycle (2022-2023):</strong> Fed raised rates from 0% to 5.25% ‚Äî the fastest increase since 1980. Result: Strong USD ‚Üí Capital fled emerging markets ‚Üí Rupee weakened ‚Üí Indian bonds sold off.<br><br><strong>Now (2024-25):</strong> Fed starting to cut rates ‚Üí Dollar weakens ‚Üí Capital flows back to India ‚Üí Rupee strengthens ‚Üí Gold rises ‚Üí Indian markets rally.<div class="example-box">üí° Watch the Fed Funds Rate futures on CME website ‚Äî it tells you what markets expect the Fed to do next. When futures price in rate cuts ‚Üí buy Indian equities.</div>`,
      `<h3>China's Economy & India's Opportunity</h3>China has been the world's factory for 30 years. But now, things are changing:<br><br><strong>China's challenges:</strong><br>‚Ä¢ Ageing population (1-child policy aftermath)<br>‚Ä¢ Property sector crisis (Evergrande, Country Garden)<br>‚Ä¢ US tech sanctions (chips, AI)<br>‚Ä¢ High debt-to-GDP (300%)<br>‚Ä¢ Supply chain "China+1" diversification<br><br><strong>India's opportunity:</strong> Companies like Apple, Samsung, and global brands are moving factories to India. India's PLI scheme attracted ‚Çπ2 lakh crore in pledged investment.<div class="example-box">üí° Apple now makes 14% of iPhones in India (vs 3% in 2022). Target: 25% by 2025. Each iPhone manufactured in India = jobs, exports, GDP. This is why the PLI scheme matters.</div>`,
      `<h3>Geopolitics & Markets</h3>Political events directly move financial markets. Understanding geopolitics = understanding risks before they happen.<br><br><strong>Key geopolitical risk factors:</strong><br>‚Ä¢ Middle East tensions ‚Üí Oil price spike ‚Üí Indian inflation ‚Üí RBI rate decisions<br>‚Ä¢ Russia-Ukraine war ‚Üí Wheat prices ‚Üí Food inflation globally<br>‚Ä¢ US-China tech war ‚Üí Chip shortages ‚Üí Electronics prices up<br>‚Ä¢ Taiwan tensions ‚Üí Semiconductor supply risk (TSMC makes 90% of advanced chips)<br><br><strong>India's strategic position:</strong> Non-alignment ‚Äî India maintains relationships with USA, Russia, Middle East. This gives India supply security but creates diplomatic complexity.<div class="example-box">üí° India's trade with Russia surged after 2022 sanctions ‚Äî buying discounted Russian oil and saving ~$6B/year on energy costs. Geopolitics creates both risks and opportunities.</div>`,
    ],
    tech: [
      `<h3>What is Artificial Intelligence?</h3>AI is software that learns patterns from data instead of following explicit rules. The result: systems that can see, hear, speak, write, and reason.<br><br><strong>Key AI technologies:</strong><br>‚Ä¢ <strong>Machine Learning:</strong> Algorithms that improve with data (spam filters, Netflix recommendations)<br>‚Ä¢ <strong>Deep Learning:</strong> Neural networks that process images, audio (face recognition, voice assistants)<br>‚Ä¢ <strong>LLMs:</strong> Large Language Models like ChatGPT ‚Äî trained on trillions of text tokens<br><br><strong>Why NOW is different:</strong> Computing power (GPUs), data availability, and algorithmic breakthroughs all converged simultaneously around 2022.<div class="example-box">üí° India trains ~200,000 AI engineers per year ‚Äî the largest pipeline globally. Companies like Sarvam AI and Krutrim are building India-specific AI models in Hindi, Tamil, Telugu etc.</div>`,
      `<h3>India's AI & Tech Ecosystem</h3>India is not just an IT services country anymore ‚Äî it's becoming an AI creator.<br><br><strong>Key players:</strong><br>‚Ä¢ <strong>Sarvam AI:</strong> Building India's foundational AI model. Backed by Lightspeed, Khosla.<br>‚Ä¢ <strong>Krutrim (Ola):</strong> Bhavish Aggarwal's AI startup. India's first AI unicorn.<br>‚Ä¢ <strong>Jio AI:</strong> Mukesh Ambani deploying AI across 450M Jio subscribers<br>‚Ä¢ <strong>Government:</strong> ‚Çπ10,000 crore IndiaAI Mission for compute, research, startups<br><br><strong>India's AI advantage:</strong> English proficiency, large data volume (UPI, Aadhaar, healthcare), cost efficiency, huge domestic market.<div class="example-box">üí° India has 5 million+ software engineers. AI makes each 10x more productive. India's IT exports could reach $500B by 2030 vs $250B today ‚Äî directly because of AI leverage.</div>`,
      `<h3>Chips & Semiconductors</h3>Semiconductors are the oil of the 21st century. Every modern device ‚Äî phones, cars, data centers, weapons ‚Äî runs on chips.<br><br><strong>The supply chain:</strong><br>‚Ä¢ Design: NVIDIA, AMD, Qualcomm (mostly USA)<br>‚Ä¢ Fabrication: TSMC (90% of advanced chips), Samsung (South Korea)<br>‚Ä¢ Packaging: Malaysia, Vietnam, China<br><br><strong>The bottleneck:</strong> TSMC in Taiwan. If Taiwan is disrupted, global chip supply collapses within weeks.<br><br><strong>India's chip ambitions:</strong> Tata Electronics + PSMC building India's first chip fab in Gujarat. $10B investment. Expected to produce chips by 2025-26.<div class="example-box">üí° India currently imports ~$50B of semiconductor-related products annually. If India builds even 10% domestic capability, that's $5B in import substitution. A massive economic unlock.</div>`,
      `<h3>How to Invest in the AI Theme from India</h3>You can participate in the AI boom from India without needing a US brokerage account:<br><br><strong>Indian plays on AI:</strong><br>‚Ä¢ <strong>IT Services:</strong> TCS, Infosys, HCL ‚Äî AI implementation contracts<br>‚Ä¢ <strong>Semiconductors:</strong> Dixon Technologies (electronics manufacturing), Kaynes Technology<br>‚Ä¢ <strong>Data Centers:</strong> Adani Enterprises, Nxtra (Airtel subsidiary)<br>‚Ä¢ <strong>AI-adjacent:</strong> Jio (AI infra deployment), Paytm (AI in fintech)<br><br><strong>US exposure via India:</strong> Motilal Oswal Nasdaq 100 FoF, Mirae US Innovation ETF ‚Äî no need for LRS.<div class="example-box">üí° NVIDIA stock grew 10x in 2 years due to AI GPU demand. In India, the equivalent is a Nifty IT index fund + selective AI-adjacent stocks. Rebalance annually.</div>`,
    ],
    markets: [
      `<h3>Stock Market Basics</h3>A stock represents ownership in a company. When you buy 1 share of TCS, you own a tiny fraction of Tata Consultancy Services and are entitled to a share of its profits.<br><br><strong>Key terms:</strong><br>‚Ä¢ <strong>NSE/BSE:</strong> India's stock exchanges where shares are traded<br>‚Ä¢ <strong>Nifty 50/Sensex:</strong> Index tracking the top 50/30 companies ‚Äî barometers of the market<br>‚Ä¢ <strong>Bull/Bear market:</strong> Rising (bull) vs falling (bear) market conditions<br>‚Ä¢ <strong>Market cap:</strong> Total value of all shares (price √ó number of shares)<br><br><strong>How prices are set:</strong> Pure supply and demand. More buyers ‚Üí price rises. More sellers ‚Üí price falls.<div class="example-box">üí° The Nifty 50 has delivered ~14% CAGR over 20 years. ‚Çπ1 lakh invested in Nifty 50 index fund in 2004 = ~‚Çπ13 lakhs today. No stock picking needed.</div>`,
      `<h3>How to Read Stock Charts</h3>A price chart shows you what buyers and sellers have done historically ‚Äî not what they WILL do. But patterns help.<br><br><strong>Key concepts:</strong><br>‚Ä¢ <strong>Candlestick:</strong> Each candle shows open, high, low, close for a period. Green = price went up. Red = price went down.<br>‚Ä¢ <strong>Support:</strong> A price level where buyers historically step in (floor)<br>‚Ä¢ <strong>Resistance:</strong> A price level where sellers historically dominate (ceiling)<br>‚Ä¢ <strong>Volume:</strong> Number of shares traded. High volume = conviction. Low volume = weak move.<br><br><strong>The golden rule:</strong> Charts show you WHERE price is relative to history ‚Äî not WHY or WHEN it will move.<div class="example-box">üí° Before buying any stock, check its 1-year chart on Zerodha or TradingView. Is it at support or resistance? Is it in an uptrend? Context matters more than any single indicator.</div>`,
      `<h3>Mutual Funds & ETFs ‚Äî The Smart Way to Invest</h3>Most people should NOT pick individual stocks. Here's why mutual funds and ETFs are better:<br><br><strong>Mutual Fund:</strong> Pool of money managed by a professional fund manager. Actively managed. Higher fees (1-2% expense ratio).<br><br><strong>ETF (Exchange Traded Fund):</strong> Tracks an index (like Nifty 50) automatically. No manager needed. Very low fees (0.05-0.15%). Beats 80% of active funds over 10+ years.<br><br><strong>Best ETFs for beginners in India:</strong><br>‚Ä¢ Nifty 50 Index ETF (any AMC)<br>‚Ä¢ Nifty Next 50 ETF<br>‚Ä¢ Gold ETF (SilverBees, GoldBees)<div class="example-box">üí° If you invest ‚Çπ5,000/month in a Nifty 50 SIP for 20 years at 13%, you get ~‚Çπ2.6 crore. Invested amount: ‚Çπ12 lakh. The rest is pure compounding.</div>`,
      `<h3>Cryptocurrency ‚Äî Risk, Reward, Reality</h3>Crypto is the most volatile major asset class in the world. Bitcoin fell 80% in 2018. Rose 1,000% in 2020. Fell 75% in 2022. This is normal for crypto.<br><br><strong>What crypto actually is:</strong><br>‚Ä¢ <strong>Bitcoin:</strong> Digital gold. Fixed supply of 21 million coins. Store of value thesis.<br>‚Ä¢ <strong>Ethereum:</strong> Programmable blockchain. Powers DeFi, NFTs, smart contracts.<br>‚Ä¢ <strong>Altcoins:</strong> Thousands of speculative tokens. Most go to zero.<br><br><strong>India's crypto rules:</strong> 30% flat tax on gains + 1% TDS on every transaction. Not tax-friendly but legal.<div class="example-box">üí° If you want crypto exposure, limit it to 2-5% of your portfolio. Only Bitcoin and Ethereum have long-term track records. Never invest more than you can afford to lose 100% of.</div>`,
      `<h3>Building Your Portfolio</h3>A good portfolio is diversified, rebalanced annually, and aligned to your goals and risk tolerance.<br><br><strong>Simple Indian portfolio template (moderate risk):</strong><br>‚Ä¢ 60% ‚Äî Nifty 50 Index Fund (equity growth)<br>‚Ä¢ 15% ‚Äî Nifty Next 50 / Midcap 150 (higher growth, higher risk)<br>‚Ä¢ 10% ‚Äî Gold ETF / SGB (hedge, stability)<br>‚Ä¢ 10% ‚Äî Debt fund / FD (safety, liquidity)<br>‚Ä¢ 5% ‚Äî International fund (global diversification)<br><br><strong>Rebalancing:</strong> Every 12 months, if any asset class drifts 5%+ from target, sell the winner and buy the laggard.<div class="example-box">üí° The hardest part of investing is doing nothing. When markets crash 30%, your SIP auto-buys MORE units at cheaper prices. This is rupee-cost averaging ‚Äî your friend during downturns.</div>`,
    ],
    science: [
      `<h3>India's Space Programme ‚Äî ISRO & Beyond</h3>India's space story is one of the most inspiring in the world. With a fraction of NASA's budget, ISRO achieves world firsts.<br><br><strong>Recent milestones:</strong><br>‚Ä¢ <strong>Chandrayaan-3 (2023):</strong> First soft landing on Moon's south pole ‚Äî ever, by any country<br>‚Ä¢ <strong>Aditya-L1 (2023):</strong> India's first solar mission, studying sun from L1 orbit<br>‚Ä¢ <strong>Gaganyaan:</strong> India's first crewed spaceflight ‚Äî upcoming<br><br><strong>Commercial space (NewSpace India):</strong> Private companies like Skyroot Aerospace (Vikram rocket) and Pixxel (hyperspectral imaging satellites) are building India's space economy.<div class="example-box">üí° India's space economy is projected to reach $44 billion by 2033 (vs $8.4B in 2023). PM Modi's target: 1,000 new space startups by 2025. ISRO licensing its technology to private players now.</div>`,
      `<h3>CRISPR Gene Editing</h3>CRISPR-Cas9 is arguably the most important scientific breakthrough of the 21st century. It allows editing DNA like text ‚Äî find a sequence, cut it, replace it.<br><br><strong>How it works:</strong><br>1. Scientists program a "guide RNA" with the target DNA sequence<br>2. The Cas9 protein follows the guide and cuts the target DNA<br>3. The cell's natural repair mechanism fixes the cut ‚Äî you can insert new DNA here<br><br><strong>Applications in India:</strong><br>‚Ä¢ Sickle cell disease cure (affects 20M Indians)<br>‚Ä¢ Thalassemia treatment (45M carriers in India)<br>‚Ä¢ Agricultural crops resistant to drought/disease<div class="example-box">üí° The first CRISPR therapy (Casgevy) was approved in the USA and UK in 2023. It functionally cures sickle cell disease. India-specific trials are ongoing. Timeline to India approval: 3-5 years.</div>`,
      `<h3>Fusion Energy</h3>Fusion is how the sun works: hydrogen atoms fuse under extreme pressure to release massive energy. For 70 years, scientists have been trying to replicate this on Earth.<br><br><strong>Why it's the holy grail:</strong><br>‚Ä¢ Fuel: Deuterium (from seawater) ‚Äî virtually unlimited<br>‚Ä¢ Output: Helium ‚Äî completely harmless<br>‚Ä¢ No carbon emissions, no long-lived radioactive waste<br>‚Ä¢ Energy density: 1kg of fusion fuel = 10 million kg of coal<br><br><strong>2022 breakthrough:</strong> NIF (USA) achieved Q>1 ‚Äî got more energy out than laser energy put in. First time in history.<br><br><strong>Timeline:</strong> Commercial fusion by 2035-2040 is realistic. Commonwealth Fusion Systems targeting 2030s.<div class="example-box">üí° If fusion succeeds, India ‚Äî which currently imports 85% of its energy needs ‚Äî could become energy self-sufficient. Electricity costs could drop 70-90%. Manufacturing competitiveness would explode.</div>`,
      `<h3>AI in Scientific Discovery</h3>AI is now accelerating scientific research at a rate no human team could match alone.<br><br><strong>AlphaFold (DeepMind):</strong> Predicted the 3D structure of 200 million proteins ‚Äî a problem that took biologists years per protein. AI did it in hours. This accelerates drug discovery by decades.<br><br><strong>Drug discovery:</strong> Traditional drug development: 12 years, $2.6 billion. AI-assisted: potentially 3-4 years, $100M. Insilico Medicine approved an AI-discovered drug for ILD in 2023.<br><br><strong>Climate science:</strong> Google's GraphCast weather model outperforms traditional models at 10-day forecasts with 99% less computing power.<div class="example-box">üí° India's biotech companies (Biocon, Dr. Reddy's) are adopting AI for drug discovery. Biocon partnered with Google for AI-driven biologics research. India could become a major AI-pharma hub given its generics expertise.</div>`,
    ],
  };
  const content = CONTENT[arena];
  return content && content[idx]
    ? `<div class="lb-body" style="font-size:13px;color:#7080a0;line-height:1.85">${content[idx]}</div>`
    : `<div style="font-size:13px;color:var(--muted);line-height:1.8">This module covers: <strong style="color:var(--text)">${ARENAS[arena].traineeModules[idx].sub}</strong>.<br><br>Read through the arena's Why, Forecast, and Learn tabs for context on this topic.</div>`;
}

// [FIX 3] Complete module ‚Äî XP awarded ONLY here, after user clicks Mark Complete
function completeTraineeModule(arena, idx) {
  const prog = getTraineeProgress(arena);
  if ((prog.completed || []).includes(idx)) {
    closelesson();
    return;
  }
  prog.completed = prog.completed || [];
  prog.completed.push(idx);
  prog.lastDate = new Date().toDateString();
  saveTraineeProgress(arena, prog);
  const xp = ARENAS[arena].traineeModules[idx].xp;
  addXP(xp);
  closelesson();
  showLevelUp(`Module complete! +${xp} XP`);
  setTimeout(() => buildTrainee(), 600);
}

// ‚îÄ CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function generatePriceData(base, vol, days) {
  const d = []; let v = base;
  for (let i = 0; i < days; i++) { v += v * (Math.random() - 0.48) * vol; d.push(Math.max(v * 0.85, v)); }
  return d;
}
function drawChart() {
  const canvas = document.getElementById('priceChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth; const H = 180;
  canvas.width = W * devicePixelRatio; canvas.height = H * devicePixelRatio;
  ctx.scale(devicePixelRatio, devicePixelRatio);
  const goldData = generatePriceData(61000, 0.012, 30);
  const silverData = generatePriceData(7200, 0.018, 30).map(v => v / 10);
  function drawLine(data, color, gStart, gEnd) {
    const min = Math.min(...data), max = Math.max(...data), range = max - min || 1;
    const pts = data.map((v, i) => ({ x: i / (data.length-1) * (W-20) + 10, y: H - 20 - ((v-min) / range) * (H-40) }));
    ctx.beginPath();
    pts.forEach((p, i) => i ? ctx.lineTo(p.x, p.y) : ctx.moveTo(p.x, p.y));
    ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.lineJoin = 'round'; ctx.stroke();
    const grad = ctx.createLinearGradient(0, 0, 0, H);
    grad.addColorStop(0, gStart); grad.addColorStop(1, gEnd);
    ctx.lineTo(pts[pts.length-1].x, H-10);
    ctx.lineTo(pts[0].x, H-10);
    ctx.closePath();
    ctx.fillStyle = grad; ctx.fill();
  }
  ctx.clearRect(0, 0, W, H);
  ctx.strokeStyle = 'rgba(255,255,255,0.04)'; ctx.lineWidth = 1;
  for (let i = 0; i < 4; i++) { const y = 20 + i * (H-40) / 3; ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke(); }
  drawLine(goldData, '#f5c842', 'rgba(245,200,66,0.18)', 'rgba(245,200,66,0)');
  drawLine(silverData, '#c8d8ee', 'rgba(200,216,238,0.1)', 'rgba(200,216,238,0)');
}
function switchRange(btn, range) {
  document.querySelectorAll('.rb').forEach(b => b.classList.remove('act'));
  btn.classList.add('act');
  drawChart();
}
function animConf() {
  document.querySelectorAll('.ft-cfill[data-w]').forEach(el => { el.style.width = el.getAttribute('data-w') + '%'; });
}

// ‚îÄ QUEST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateQuest() {
  const count = Math.min(S.visitedArenas.size, 2);
  S.questCount = count;
  const el = document.getElementById('quest-count'); if (el) el.textContent = count;
  const pct = count / 2 * 100;
  const fill = document.getElementById('quest-fill'); if (fill) fill.style.width = pct + '%';
  const pctEl = document.getElementById('quest-pct'); if (pctEl) pctEl.textContent = pct + '%';
  if (count >= 2) {
    const questDoneKey = 'wiq_quest_reward_' + new Date().toDateString();
    if (!localStorage.getItem(questDoneKey)) {
      localStorage.setItem(questDoneKey, '1');
      addXP(150);
      showLevelUp('Daily Quest Complete! +150 XP');
    }
  }
}

// ‚îÄ CLOCK & GREETING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateClock() {
  const now = new Date();
  const clockEl = document.getElementById('topbar-clock');
  if (clockEl) clockEl.textContent = now.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
  const h = now.getHours();
  const greetEl = document.getElementById('home-greeting');
  if (greetEl) greetEl.textContent = h < 12 ? '‚òÄÔ∏è Good Morning' : h < 17 ? 'üå§ Good Afternoon' : 'üåô Good Evening';
}
setInterval(updateClock, 1000);
updateClock();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AUTH FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setAuthStatus(msg, color = 'var(--muted)') {
  const el = document.getElementById('auth-status');
  if (el) { el.textContent = msg; el.style.color = color; }
}

async function signup() {
  const username = document.getElementById("username").value.trim();
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if (!email || !password || !username) { setAuthStatus("Please fill all fields", "var(--red)"); return; }
  if (!window.supabaseClient) { setAuthStatus("Connection error. Please refresh.", "var(--red)"); return; }
  setAuthStatus("Creating account...", "var(--muted)");
  try {
    const { data, error } = await window.supabaseClient.auth.signUp({ email, password, options: { data: { username } } });
    if (error) { setAuthStatus(error.message, "var(--red)"); return; }
    setAuthStatus("Account created! Please check your email to verify, then login.", "var(--green)");
    setTimeout(() => switchToLogin(), 2000);
  } catch (err) { setAuthStatus("Signup failed. Try again.", "var(--red)"); }
}

async function login() {
  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;
  if (!email || !password) { setAuthStatus("Please fill all fields", "var(--red)"); return; }
  if (!window.supabaseClient) { setAuthStatus("Connection error. Please refresh.", "var(--red)"); return; }
  setAuthStatus("Logging in...", "var(--muted)");
  try {
    const { data, error } = await window.supabaseClient.auth.signInWithPassword({ email, password });
    if (error) { setAuthStatus(error.message, "var(--red)"); return; }
    setAuthStatus("", "var(--muted)");
    if (data.user) loadUserProfile(data.user);
    else showApp(email.split('@')[0]);
  } catch (err) { setAuthStatus("Login failed. Check console.", "var(--red)"); }
}

async function logout() {
  // [FIX v2.1] Logout ‚Äî sign out session ONLY.
  // NEVER delete profile data (wiq_xp, wiq_level, wiq_correct, wiq_achievements,
  // wiq_highscores, wiq_completed_cards, wiq_trainee_progress, wiq_streak).
  // These persist in localStorage as cache, reconciled with server on next login.
  if (window.supabaseClient) {
    try { await window.supabaseClient.auth.signOut(); } catch (e) { console.warn('[WIQ] signOut err', e); }
  }
  // Clear ONLY session/daily state ‚Äî NOT profile data
  ['wiq_visited_today', 'wiq_quest_date'].forEach(k => localStorage.removeItem(k));
  // Clear the quest reward keys for today so they can fire again after login
  const todayStr = new Date().toDateString();
  localStorage.removeItem('wiq_quest_reward_' + todayStr);
  sessionStorage.clear();
  // Reset RUNTIME S object only ‚Äî localStorage retains the profile cache for reconciliation
  S.xp = 0; S.level = 1; S.streak = 1; S.arenaXP = 0; S.totalCorrect = 0;
  S.visitedArenas.clear();
  // Reset UI elements to show guest state
  const xpFill = document.getElementById('xp-fill'); if (xpFill) xpFill.style.width = '0%';
  const xpVal  = document.getElementById('xp-val');  if (xpVal)  xpVal.textContent  = '0';
  const lvNum  = document.getElementById('lv-num');  if (lvNum)  lvNum.textContent  = '1';
  const strNum = document.getElementById('str-num'); if (strNum) strNum.textContent = '1';
  const uname  = document.getElementById('tb-username'); if (uname) uname.textContent = 'Guest';
  showAuth();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT ON PAGE LOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener("DOMContentLoaded", async () => {
  // Unlock first step achievement
  unlockAchievement('first_step');
  // Check 7-day streak achievement
  if (S.streak >= 7) unlockAchievement('consistent');
  updateXPBar();
  updateQuest();
  try {
    if (!window.supabaseClient) { showAuth(); return; }
    const { data } = await window.supabaseClient.auth.getSession();
    if (data?.session?.user) {
      await loadUserProfile(data.session.user);
    } else {
      showAuth();
    }
  } catch (err) {
    console.error("Session check error:", err);
    showAuth();
  }
});

window.addEventListener('resize', () => { if (document.getElementById('priceChart')) drawChart(); });
</script>
</body>
</html>